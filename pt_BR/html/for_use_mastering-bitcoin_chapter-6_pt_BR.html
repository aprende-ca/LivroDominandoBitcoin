<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<title>Transações</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article data-line-1">
<div id="header">
</div>
<div id="content">
<div class="sect1 data-line-3">
<h2 id="transactions">Transações</h2>
<div class="sectionbody">
<div class="sect2 data-line-6">
<h3 id="ch06_intro">Introdução</h3>
<div class="paragraph data-line-8">
<p>Transactions are the most important part of the Bitcoin system. Everything else in bitcoin is designed to ensure that transactions can be created, propagated on the network, validated, and finally added to the global ledger of transactions (the blockchain). Transactions are data structures that encode the transfer of value between participants in the Bitcoin system. Each transaction is a public entry in bitcoin&#8217;s blockchain, the global double-entry bookkeeping ledger.</p>
</div>
<div class="paragraph data-line-10">
<p>Neste capítulo, examinaremos as várias formas de transações, o que elas contêm, como criá-las, como elas são verificadas e como elas se tornam parte do registro permanente de todas as transações. Quando usamos o termo "carteira" neste capítulo, estamos nos referindo ao software que constrói transações, e não apenas ao banco de dados de chaves.</p>
</div>
</div>
<div class="sect2 data-line-13">
<h3 id="tx_structure">Transações em Detalhe</h3>
<div class="paragraph data-line-15">
<p>No <a href="#ch02_bitcoin_overview">[ch02_bitcoin_overview]</a>, analisamos a transação que a Alice usou para pagar pelo café na cafeteria do Bob usando um explorador de blocos (<a href="#alices_transactions_to_bobs_cafe">Transação da Alice para a Cafeteria do Bob</a>).</p>
</div>
<div class="paragraph data-line-17">
<p>O explorador de blocos mostra uma transação do "endereço" da Alice para o "endereço" do Bob. Esta é uma visão muito simplificada do que está contido em uma transação. Na verdade, como veremos neste capítulo, muitas das informações mostradas são construídas pelo explorador de blocos e não estão realmente na transação.</p>
</div>
<div id="alices_transactions_to_bobs_cafe" class="imageblock data-line-21">
<div class="content">
<img src="images/mbc2_0208.png" alt="Alice Coffee Transaction">
</div>
<div class="title">Figure 1. Transação da Alice para a Cafeteria do Bob</div>
</div>
<div class="sect3 data-line-24">
<h4 id="transactions_behind_the_scenes">Transações&#x2014;Nos Bastidores</h4>
<div class="paragraph data-line-26">
<p>Behind the scenes, an actual transaction looks very different from a transaction provided by a typical block explorer. In fact, most of the high-level constructs we see in the various bitcoin application user interfaces <em>do not actually exist</em> in the Bitcoin system.</p>
</div>
<div class="paragraph data-line-28">
<p>Podemos usar a interface de linha de comando do Bitcoin Core (getrawtransaction e decoderawtransaction) para recuperar a transação "bruta" da Alice, decodificá-la e ver o que ela contém. O resultado é o seguinte:</p>
</div>
<div id="alice_tx" class="listingblock data-line-33">
<div class="title">Transação da Alice decodificada</div>
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "version": 1,
  "locktime": 0,
  "vin": [
    {
      "txid": "7957a35fe64f80d234d76d83a2a8f1a0d8149a41d81de548f0a65a8a999f6f18",
      "vout": 0,
      "scriptSig" : "3045022100884d142d86652a3f47ba4746ec719bbfbd040a570b1deccbb6498c75c4ae24cb02204b9f039ff08df09cbe9f6addac960298cad530a863ea8f53982c09db8f6e3813[ALL] 0484ecc0d46f1918b30928fa0e4ed99f16a0fb4fde0735e7ade8416ab9fe423cc5412336376789d172787ec3457eee41c04f4938de5cc17b4a10fa336a8d752adf",
      "sequence": 4294967295
    }
  ],
  "vout": [
    {
      "value": 0.01500000,
      "scriptPubKey": "OP_DUP OP_HASH160 ab68025513c3dbd2f7b92a94e0581f5d50f654e7 OP_EQUALVERIFY OP_CHECKSIG"
    },
    {
      "value": 0.08450000,
      "scriptPubKey": "OP_DUP OP_HASH160 7f9b1a7fb68d60c536c2fd8aeaa53a8f3cc025a8 OP_EQUALVERIFY OP_CHECKSIG",
    }
  ]
}</code></pre>
</div>
</div>
<div class="paragraph data-line-58">
<p>Você pode notar algumas coisas sobre esta transação, principalmente as coisas que estão faltando! Onde está o endereço da Alice? Onde está o endereço do Bob? Onde está a entrada de 0.1 "enviada" pela Alice? No bitcoin não há moedas, nem remetentes, nem destinatários, nem saldos, nem contas, nem endereços. Todas essas coisas são construídas em um nível superior para o benefício do usuário, para tornar as coisas mais fáceis de serem entendidas.</p>
</div>
<div class="paragraph data-line-60">
<p>Você também pode notar muitos campos estranhos e indecifráveis, assim como <em>strings</em> hexadecimais. Não se preocupe, explicaremos cada campo mostrado aqui em detalhes neste capítulo.</p>
</div>
</div>
</div>
<div class="sect2 data-line-63">
<h3 id="tx_inputs_outputs">Saídas e Entradas de Transação</h3>
<div class="paragraph data-line-65">
<p>O que dá origem a uma transação de bitcoin é uma <em>saída de transação</em>. As saídas de transação (em inglês, <em>transaction outputs</em>) são partes indivisíveis da moeda bitcoin, registradas na blockchain e reconhecidas como válidas por toda a rede. Os nós completos do bitcoin rastreiam todas as saídas que estão disponíveis e podem ser gastas, conhecidas como <em>saídas de transação não gastas</em> (em inglês,  <em>unspent transaction outputs</em> ou UTXOs). A coleção de todas as UTXOs é conhecida como o <em>conjunto UTXO</em> e atualmente está na casa das milhões de UTXOs. O conjunto UTXO cresce quando uma nova UTXO é criada e diminui quando uma UTXO é consumida. Cada transação representa uma mudança (transição de estado) no conjunto UTXO.</p>
</div>
<div class="paragraph data-line-67">
<p>Quando dizemos que a carteira de um usuário "recebeu" bitcoin, o que queremos dizer é que a carteira detectou na blockchain um UTXO que pode ser gasto com uma das chaves controladas por essa carteira. Assim, o "saldo" de bitcoin de um usuário é a soma de todo o UTXO que a carteira do usuário pode gastar e que pode estar espalhado entre centenas de transações e em centenas de blocos. O conceito de saldo é criado pela aplicação da carteira. A carteira calcula o saldo do usuário escaneando a blockchain e agregando o valor de qualquer UTXO que a carteira possa gastar com as chaves que ela controla. A maioria das carteiras mantém um banco de dados ou usa um serviço de banco de dados para armazenar um conjunto de referência rápida de todo o UTXO que podem gastar com as chaves que controlam.</p>
</div>
<div class="paragraph data-line-69">
<p><a href="#utxo-stxo">Cadeia de transações entre Joe e Gopesh sendo construída na blockchain</a>exibe a blockchain em três momentos diferentes, conforme a cadeia de transações entre Joe e Gopesh que está sendo construída. Observe como cada transação gasta um UTXO que foi criado em uma transação anterior, transformando-o em uma <em>saída de transação gasta</em> ou <em>STXO</em>. Como a transação nº 1 (de Joe para Alice) gasta um único UTXO (de Joe) e cria um único UTXO (para Alice), ela não modifica o tamanho do conjunto do UTXO. Por outro lado, as transações 2 e 3 criam saídas de troco para o remetente, gastando um único UTXO e criando dois UTXO (o pagamento e a saída de troco). Portanto, cada um deles aumenta o tamanho do conjunto UTXO em 1.</p>
</div>
<div id="utxo-stxo" class="imageblock data-line-73">
<div class="content">
<img src="images/mbc2_0609.png" alt="Cadeia de transação entre Joe e Gopesh sendo construída na blockchain">
</div>
<div class="title">Figure 2. Cadeia de transações entre Joe e Gopesh sendo construída na blockchain</div>
</div>
<div class="paragraph data-line-75">
<p>A saída de uma transação pode ter um valor arbitrário (inteiro) denominado como um múltiplo de satoshis. Assim como os dólares podem ser divididos em até duas casas decimais como centavos, o bitcoin pode ser dividido em até oito casas decimais como satoshis. Embora uma saída possa ter qualquer valor arbitrário, uma vez criada, ela é indivisível. Esta é uma característica importante das saídas que precisa ser enfatizada: as saídas são unidades de valor <em>discretas</em> e <em>indivisíveis</em>, denominadas em satoshis inteiros. Uma saída não gasta só pode ser consumida em sua totalidade por uma transação.</p>
</div>
<div class="paragraph data-line-77">
<p>Se uma UTXO é maior do que o valor desejado de uma transação, ela precisa ser totalmente consumida e um troco deve ser gerado na transação. Em outras palavras, se você possui uma UTXO que vale 20 bitcoins, e você quer pagar apenas 1 bitcoin, a sua transação precisa consumir toda a UTXO de 20 bitcoins e produzir duas saídas: uma que paga 1 bitcoin para o destinatário desejado e outra que paga 19 bitcoins em troco de volta para a sua carteira. Devido à natureza indivisível das saídas de transação, a maioria das transações de bitcoin precisa gerar troco.</p>
</div>
<div class="paragraph data-line-79">
<p>Imagine uma cliente comprando uma bebida de $1,50, pegando sua carteira e tentando achar uma combinação de moedas e notas para atingir o valor de $1,50. A cliente poderá escolher pagar a quantia exata, se disponível, com uma nota de um dólar e duas moedas de 25 centavos, ou com uma combinação de pequenas denominações (6 moedas de 25 centavos), ou, se necessário, com uma unidade maior, como uma nota de 5 dólares. Se ela der dinheiro em excesso ao dono da loja, digamos $5, ela esperará um troco de $3,50, o qual ela guardará em sua carteira, onde ficará disponível para transações futuras.</p>
</div>
<div class="paragraph data-line-81">
<p>De maneira semelhante, uma transação de bitcoin precisa ser criada a partir de uma UTXO do usuário em quaisquer denominações que o usuário tiver disponível. Os usuários não podem dividir uma UTXO pela metade, da mesma maneira que eles não podem cortar uma nota de um dólar pela metade e usá-la para fazer pagamentos. O aplicativo de carteira do usuário geralmente selecionará algumas UTXOs entre as UTXOs disponíveis do usuário, com o objetivo de juntar uma quantia maior ou igual ao valor desejado da transação.</p>
</div>
<div class="paragraph data-line-83">
<p>Assim como na vida real, a aplicação de bitcoin possui várias estratégias para satisfazer a quantia de compra: combinar várias unidades menores, procurar pelo troco exato ou usar uma unidade única maior que o valor da transação e receber o troco. Toda essa complexa administração das UTXOs gastáveis é feita de maneira automática pela carteira do usuário, e os usuários sequer tomam conhecimento dela. A administração das UTXOs só é relevante se você for um programador e estiver construindo transações brutas a partir de UTXOs.</p>
</div>
<div class="paragraph data-line-85">
<p>Uma transação consome saídas de transação não gastas registradas anteriormente e cria novas saídas de transação que podem ser consumidas por uma transação futura. Dessa forma, pedaços de valor de bitcoin passam de proprietário a proprietário em uma cadeia de transações que consome e cria UTXOs.</p>
</div>
<div class="paragraph data-line-87">
<p>A exceção para a cadeia de entradas e saídas é um tipo especial de transação chamada de transação <em>coinbase</em>, que é a primeira transação em cada bloco. Essa transação é inserida no bloco pelo minerador "vencedor" e cria bitcoins novos, recém-criados, que serão pagos para o minerador como uma recompensa por ter conseguido minerar o bloco. Esta transação especial não consome UTXOs; em vez disso, ela tem um tipo especial de entrada chamada "coinbase". É assim que a oferta monetária do bitcoin é criada durante o processo de mineração, como veremos no <a href="#mining">[mining]</a>.</p>
</div>
<div class="admonitionblock tip data-line-90">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-91">
<p>E o que vem primeiro? As entradas ou as saídas, a galinha ou o ovo? Falando estritamente, as saídas vem primeiro, pois as transações coinbase, que geram os novos bitcoins, não tem entradas e criam saídas a partir do nada.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3 data-line-95">
<h4 id="tx_outs">Saídas de Transação</h4>
<div class="paragraph data-line-97">
<p>Toda transação de bitcoin cria saídas (em inglês, <em>outputs</em>), que são gravadas no livro-razão do bitcoin (a cadeia de blocos). Quase todas essas saídas, com uma exceção (ver <a href="#op_return">[op_return]</a>), criam partes de bitcoin gastáveis chamadas <em>saídas de transação não gastas</em> ou UTXO (em inglês, <em>Unspent Transaction Output</em>), que são então reconhecidas por toda a rede e se tornam disponíveis para que o dono gaste em uma transação futura.</p>
</div>
<div class="paragraph data-line-99">
<p>UTXO are tracked by every full-node Bitcoin client in the UTXO set. New transactions consume (spend) one or more of these outputs from the UTXO set.</p>
</div>
<div class="paragraph data-line-101">
<p>As saídas de transação consistem em duas partes:</p>
</div>
<div class="ulist data-line-103">
<ul>
<li class="data-line-103">
<p>Uma quantidade de bitcoin, denominada em <em>satoshis</em>, a menor unidade do bitcoin</p>
</li>
<li class="data-line-104">
<p>Um quebra-cabeça criptográfico que determina as condições necessárias para se gastar a saída</p>
</li>
</ul>
</div>
<div class="paragraph data-line-106">
<p>O quebra-cabeça criptográfico também é conhecido como um <em>script de travamento</em> (em inglês, <em>locking script</em>), um <em>script de testemunha</em> (em inglês, <em>witness script</em>) ou um scriptPubKey.</p>
</div>
<div class="paragraph data-line-108">
<p>A linguagem de script da transação, usada no script de travamento mencionado anteriormente, é discutida em detalhes em <a href="#tx_script">Scripts de Transação e Linguagem de Script</a>.</p>
</div>
<div class="paragraph data-line-110">
<p>Agora, vamos dar uma olhada na transação da Alice (mostrada anteriormente em <a href="#transactions_behind_the_scenes">Transações&#x2014;Nos Bastidores</a>) e ver se conseguimos identificar as saídas. Na codificação JSON, as saídas estão em um array (uma lista) chamado vout:</p>
</div>
<div class="listingblock data-line-113">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">"vout": [
  {
    "value": 0.01500000,
    "scriptPubKey": "OP_DUP OP_HASH160 ab68025513c3dbd2f7b92a94e0581f5d50f654e7 OP_EQUALVERIFY
    OP_CHECKSIG"
  },
  {
    "value": 0.08450000,
    "scriptPubKey": "OP_DUP OP_HASH160 7f9b1a7fb68d60c536c2fd8aeaa53a8f3cc025a8 OP_EQUALVERIFY OP_CHECKSIG",
  }
]</code></pre>
</div>
</div>
<div class="paragraph data-line-127">
<p>Como você pode ver, a transação contém duas saídas. Cada saída é definida por um valor e um quebra-cabeça criptográfico. Na codificação mostrada pelo Bitcoin Core, o valor (em inglês, value) é mostrado em bitcoin, mas na transação em si ele é registrado como um número inteiro denominado em satoshis. A segunda parte de cada saída é o quebra-cabeça criptográfico que define as condições de gasto. O Bitcoin Core exibe-o como scriptPubKey e nos mostra uma representação legível do script.</p>
</div>
<div class="paragraph data-line-129">
<p>O tópico sobre o travamento e o destravamento de UTXOs será discutido mais tarde, em <a href="#tx_lock_unlock">Construção do Script (Travamento + Destravamento)</a>. A linguagem de script que é usada para o script em scriptPubKey é discutida em <a href="#tx_script">Scripts de Transação e Linguagem de Script</a>. Mas antes de nos aprofundarmos nesses tópicos, precisamos entender a estrutura geral das entradas e saídas de transação.</p>
</div>
<div class="sect4 data-line-131">
<h5 id="_serialização_da_transaçãosaídas">Serialização da Transação&#x2014;saídas</h5>
<div class="paragraph data-line-133">
<p>Quando as transações são transmitidas pela rede ou trocadas entre aplicativos, elas são <em>serializadas</em>. Serialização é o processo de converter a representação interna de uma estrutura de dados em um formato que pode ser transmitido um byte por vez, também conhecido como um fluxo de bytes. A serialização é mais comumente usada para codificar estruturas de dados para transmissão em uma rede ou para armazenamento em um arquivo. O formato de serialização de uma saída de transação é mostrado na <a href="#tx_out_structure">Serialização da saída de transação</a>.</p>
</div>
<table id="tx_out_structure" class="tableblock frame-all grid-all stretch data-line-138">
<caption class="title">Table 1. Serialização da saída de transação</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Tamanho</th>
<th class="tableblock halign-left valign-top">Campo</th>
<th class="tableblock halign-left valign-top">Descrição</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">8 bytes (little-endian)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Quantia</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Valor de bitcoin em satoshis (10<sup>-8</sup> bitcoin)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1&#x2013;9 bytes (VarInt)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tamanho do Script de Travamento</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Comprimento em bytes do Script de Travamento</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Variável</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Script de Travamento</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Um script definindo as condições necessárias para se gastar a saída</p></td>
</tr>
</tbody>
</table>
<div class="paragraph data-line-145">
<p>A maioria das bibliotecas e frameworks de bitcoin não armazena transações internamente como fluxos de bytes, pois isso exigiria uma análise sintática complexa toda vez que você precisasse acessar um único campo. Por conveniência e legibilidade, as bibliotecas de bitcoin armazenam as transações internamente em estruturas de dados (geralmente estruturas orientadas a objetos).</p>
</div>
<div class="paragraph data-line-147">
<p>O processo de conversão da representação em fluxo de bytes de uma transação em uma estrutura de dados da representação interna de uma biblioteca é chamada de <em>deserialização</em> ou <em>análise sintática da transação</em> (em inglês, <em>transaction parsing</em>). O processo de conversão de volta para um fluxo de bytes, a fim de ser transmitido pela rede, submetido a uma função de hash ou armazenado em disco, é chamado de <em>serialização</em>. A maioria das bibliotecas do bitcoin possui funções para fazer a serialização e a desserialização de transações.</p>
</div>
<div class="paragraph data-line-149">
<p>Veja se você consegue decodificar manualmente a transação da Alice a partir da forma hexadecimal serializada, encontrando alguns dos elementos que vimos anteriormente. Para ajudá-lo, a seção que contém as duas saídas está destacada no <a href="#example_6_1">Transação da Alice, serializada e apresentada em notação hexadecimal</a>:</p>
</div>
<div id="example_6_1" class="exampleblock data-line-153">
<div class="title">Example 1. Transação da Alice, serializada e apresentada em notação hexadecimal</div>
<div class="content">
<div class="paragraph data-line-154">
<p>0100000001186f9f998a5aa6f048e51dd8419a14d8a0f1a8a2836dd73
4d2804fe65fa35779000000008b483045022100884d142d86652a3f47
ba4746ec719bbfbd040a570b1deccbb6498c75c4ae24cb02204b9f039
ff08df09cbe9f6addac960298cad530a863ea8f53982c09db8f6e3813
01410484ecc0d46f1918b30928fa0e4ed99f16a0fb4fde0735e7ade84
16ab9fe423cc5412336376789d172787ec3457eee41c04f4938de5cc1
7b4a10fa336a8d752adfffffffff02<strong>60e31600000000001976a914ab6</strong>
<strong>8025513c3dbd2f7b92a94e0581f5d50f654e788acd0ef800000000000</strong>
<strong>1976a9147f9b1a7fb68d60c536c2fd8aeaa53a8f3cc025a888ac</strong>
00000000</p>
</div>
</div>
</div>
<div class="paragraph data-line-166">
<p>Aqui estão algumas dicas:</p>
</div>
<div class="ulist data-line-168">
<ul>
<li class="data-line-168">
<p>Existem duas saídas na seção destacada, cada uma serializada conforme mostrado na <a href="#tx_out_structure">Serialização da saída de transação</a>.</p>
</li>
<li class="data-line-169">
<p>O valor de 0,015 bitcoin equivale a 1.500.000 satoshis, que é 16 e3 60 em hexadecimal.</p>
</li>
<li class="data-line-170">
<p>Na transação serializada, o valor 16 e3 60 é codificado na ordem de bytes <em>little-endian</em> (byte menos significativo primeiro), resultando em 60 e3 16.</p>
</li>
<li class="data-line-171">
<p>O comprimento do scriptPubKey é 25 bytes, que é 19 em hexadecimal.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3 data-line-174">
<h4 id="tx_inputs">Entradas de Transação</h4>
<div class="paragraph data-line-176">
<p>As entradas de transação identificam (por referência) qual UTXO será consumida e fornecem uma prova de posse através de um script de destravamento.</p>
</div>
<div class="paragraph data-line-178">
<p>Para construir uma transação, uma carteira seleciona, das UTXOs que ela controla, UTXOs com valor suficiente para fazer o pagamento solicitado. Às vezes, uma UTXO é suficiente, outras vezes, mais de uma é necessária. Para cada UTXO que será consumida para fazer este pagamento, a carteira cria uma entrada apontando para a UTXO e a destrava com um script de destravamento.</p>
</div>
<div class="paragraph data-line-180">
<p>Vamos analisar os componentes de uma entrada em maiores detalhes. A primeira parte de uma entrada é um apontador para uma UTXO por referência ao hash da transação e um índice de saída, que identifica a UTXO específica naquela transação. A segunda parte é um script de destravamento, que a carteira constrói para atender às condições de gasto definidas na UTXO. Na maioria das vezes, o script de destravamento é uma assinatura digital e uma chave pública que provam a posse do bitcoin. No entanto, nem todos os scripts de destravamento contêm assinaturas. A terceira parte é um número de sequência, que será discutido posteriormente.</p>
</div>
<div class="paragraph data-line-182">
<p>Considere nosso exemplo em <a href="#transactions_behind_the_scenes">Transações&#x2014;Nos Bastidores</a>. As entradas da transação são um array (lista) chamado vin:</p>
</div>
<div id="vin" class="listingblock data-line-187">
<div class="title">As entradas de transação na transação da Alice</div>
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">"vin": [
  {
    "txid": "7957a35fe64f80d234d76d83a2a8f1a0d8149a41d81de548f0a65a8a999f6f18",
    "vout": 0,
    "scriptSig" : "3045022100884d142d86652a3f47ba4746ec719bbfbd040a570b1deccbb6498c75c4ae24cb02204b9f039ff08df09cbe9f6addac960298cad530a863ea8f53982c09db8f6e3813[ALL] 0484ecc0d46f1918b30928fa0e4ed99f16a0fb4fde0735e7ade8416ab9fe423cc5412336376789d172787ec3457eee41c04f4938de5cc17b4a10fa336a8d752adf",
    "sequence": 4294967295
  }
]</code></pre>
</div>
</div>
<div class="paragraph data-line-198">
<p>Como você pode ver, só existe uma entrada na lista (porque uma UTXO continha valor suficiente para fazer este pagamento). A entrada contém quatro elementos:</p>
</div>
<div class="ulist data-line-200">
<ul>
<li class="data-line-200">
<p>Um ID de transação, referenciando a transação que contém a UTXO sendo gasta</p>
</li>
<li class="data-line-201">
<p>Um índice de saída (vout), identificando qual UTXO daquela transação é referenciada (a primeira tem índice igual a zero)</p>
</li>
<li class="data-line-202">
<p>Um scriptSig, que satisfaz as condições colocadas na UTXO, destravando-a para ser gasta</p>
</li>
<li class="data-line-203">
<p>Um número de sequência (que será discutido mais tarde)</p>
</li>
</ul>
</div>
<div class="paragraph data-line-205">
<p>Na transação da Alice, a entrada aponta para o ID de transação:</p>
</div>
<div class="listingblock data-line-207">
<div class="content">
<pre>7957a35fe64f80d234d76d83a2a8f1a0d8149a41d81de548f0a65a8a999f6f18</pre>
</div>
</div>
<div class="paragraph data-line-211">
<p>e o índice de saída 0 (ou seja, a primeira UTXO criada por aquela transação). O script de destravamento é construído pela carteira de Alice primeiro recuperando a UTXO referenciada, depois examinando seu script de travamento e, em seguida, usando-o para construir o script de destravamento necessário para satisfazê-lo.</p>
</div>
<div class="paragraph data-line-213">
<p>Olhando apenas para a entrada, você deve ter notado que não sabemos nada sobre esta UTXO, exceto uma referência à transação pai que a contém. Não sabemos seu valor (quantia em satoshis) e não conhecemos o script de travamento que define as condições para gastá-la. Para encontrar essas informações, devemos recuperar a UTXO referenciada recuperando a transação pai que a contém. Observe que, como o valor da entrada não é declarado explicitamente, também devemos usar a UTXO referenciada para calcular as taxas que serão pagas nesta transação (ver <a href="#tx_fees">Taxas de Transação</a>).</p>
</div>
<div class="paragraph data-line-215">
<p>Não é apenas a carteira da Alice que precisa recuperar as UTXOs referenciadas nas entradas. Uma vez que essa transação é transmitida para a rede, todos os nós validadores também precisarão recuperar as UTXOs referenciadas nas entradas da transação para poder validar a transação.</p>
</div>
<div class="paragraph data-line-217">
<p>As transações por si sós parecem incompletas, pois elas não têm contexto. Elas fazem referência às UTXOs em suas entradas, mas, sem recuperar essas UTXOs, não podemos saber o valor das entradas ou suas condições de travamento. Ao escrever um software de bitcoin, sempre que você decodificar uma transação com a intenção de validá-la, ou para contar as taxas, ou para verificar o script de destravamento, seu código terá primeiro de recuperar a UTXO referenciada da blockchain para construir o contexto que está implícito, mas que não está presente nas referências de UTXO das entradas. Por exemplo, para calcular o valor pago em taxas, é necessário saber a soma dos valores das entradas e saídas. Mas sem recuperar as UTXOs referenciadas nas entradas, você não sabe o valor delas. Portanto, uma operação aparentemente simples, como calcular as taxas de uma única transação, na verdade envolve várias etapas e dados de múltiplas transações.</p>
</div>
<div class="paragraph data-line-219">
<p>Podemos usar a mesma sequência de comandos do Bitcoin Core que usamos ao recuperar a transação da Alice (getrawtransaction e decoderawtransaction). Com isso, conseguimos obter a UTXO referenciada na entrada da transação da Alice e dar uma olhada:</p>
</div>
<div id="alice_input_tx" class="listingblock data-line-224">
<div class="title">A UTXO da transação anterior, referenciada na entrada da transação da Alice</div>
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">"vout": [
   {
     "value": 0.10000000,
     "scriptPubKey": "OP_DUP OP_HASH160 7f9b1a7fb68d60c536c2fd8aeaa53a8f3cc025a8 OP_EQUALVERIFY OP_CHECKSIG"
   }
 ]</code></pre>
</div>
</div>
<div class="paragraph data-line-233">
<p>Vemos que esta UTXO tem um valor de 0,1 BTC e que ela possui um script de travamento (scriptPubKey) que contém "OP_DUP OP_HASH160&#8230;&#8203;".</p>
</div>
<div class="admonitionblock tip data-line-236">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-237">
<p>Para entender completamente a transação da Alice, tivemos que recuperar a transação anterior referenciada como entrada. Uma função que recupera transações anteriores e saídas de transação não gastas é muito comum e existe em quase todas as bibliotecas e APIs do bitcoin.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4 data-line-240">
<h5 id="_serialização_da_transaçãoentradas">Serialização da Transação&#x2014;entradas</h5>
<div class="paragraph data-line-242">
<p>Quando as transações são serializadas para transmissão na rede, suas entradas são codificadas em um fluxo de bytes, conforme mostrado na <a href="#tx_in_structure">Serialização da entrada de transação</a>.</p>
</div>
<table id="tx_in_structure" class="tableblock frame-all grid-all stretch data-line-247">
<caption class="title">Table 2. Serialização da entrada de transação</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Tamanho</th>
<th class="tableblock halign-left valign-top">Campo</th>
<th class="tableblock halign-left valign-top">Descrição</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">32 bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hash da Transação</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Apontador para a transação contendo a UTXO a ser gasta</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4 bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Índice da Saída</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">O número índice da UTXO a ser gasta; o primeiro é 0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1&#x2013;9 bytes (VarInt)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tamanho do Script de Destravamento</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Comprimento em bytes do Script de Destravamento</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Variável</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Script de Destravamento</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Um script que preenche as condições necessárias para o script de travamento da UTXO</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4 bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Número de Sequência</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Usado para o locktime ou desabilitado (0xFFFFFFFF)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph data-line-256">
<p>Assim como fizemos com as saídas, vamos ver se conseguimos encontrar as entradas da transação da Alice no formato serializado. Primeiro, as entradas decodificadas:</p>
</div>
<div class="listingblock data-line-259">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">"vin": [
  {
    "txid": "7957a35fe64f80d234d76d83a2a8f1a0d8149a41d81de548f0a65a8a999f6f18",
    "vout": 0,
    "scriptSig" : "3045022100884d142d86652a3f47ba4746ec719bbfbd040a570b1deccbb6498c75c4ae24cb02204b9f039ff08df09cbe9f6addac960298cad530a863ea8f53982c09db8f6e3813[ALL] 0484ecc0d46f1918b30928fa0e4ed99f16a0fb4fde0735e7ade8416ab9fe423cc5412336376789d172787ec3457eee41c04f4938de5cc17b4a10fa336a8d752adf",
    "sequence": 4294967295
  }
],</code></pre>
</div>
</div>
<div class="paragraph data-line-270">
<p>Agora, vamos ver se conseguimos identificar esses campos na codificação hexadecimal serializada no <a href="#example_6_2">Transação da Alice, serializada e apresentada em notação hexadecimal</a>:</p>
</div>
<div id="example_6_2" class="exampleblock data-line-274">
<div class="title">Example 2. Transação da Alice, serializada e apresentada em notação hexadecimal</div>
<div class="content">
<div class="paragraph data-line-275">
<p>0100000001<strong>186f9f998a5aa6f048e51dd8419a14d8a0f1a8a2836dd73</strong>
<strong>4d2804fe65fa35779000000008b483045022100884d142d86652a3f47</strong>
<strong>ba4746ec719bbfbd040a570b1deccbb6498c75c4ae24cb02204b9f039</strong>
<strong>ff08df09cbe9f6addac960298cad530a863ea8f53982c09db8f6e3813</strong>
<strong>01410484ecc0d46f1918b30928fa0e4ed99f16a0fb4fde0735e7ade84</strong>
<strong>16ab9fe423cc5412336376789d172787ec3457eee41c04f4938de5cc1</strong>
<strong>7b4a10fa336a8d752adfffffffff</strong>0260e31600000000001976a914ab6
8025513c3dbd2f7b92a94e0581f5d50f654e788acd0ef800000000000
1976a9147f9b1a7fb68d60c536c2fd8aeaa53a8f3cc025a888ac00000
000</p>
</div>
</div>
</div>
<div class="paragraph data-line-287">
<p>Dicas:</p>
</div>
<div class="ulist data-line-289">
<ul>
<li class="data-line-289">
<p>O ID de transação é serializado em ordem de byte reversa, então começa com (hex) 18 e termina com 79</p>
</li>
<li class="data-line-290">
<p>O índice da saída é um grupo de zeros de 4 bytes, que é fácil de identificar</p>
</li>
<li class="data-line-291">
<p>O comprimento do scriptSig é 139 bytes, ou 8b em hexadecimal</p>
</li>
<li class="data-line-292">
<p>O número de sequência é definido como FFFFFFFF, também fácil de ser identificado</p>
</li>
</ul>
</div>
<div class="paragraph data-line-294">
<p>O ScriptSig é um tipo específico de script de destravamento que, quando serializado para transmissão na rede, as entradas são codificadas em um fluxo de bytes, conforme mostrado na <a href="#scriptsig_in_structure">Serialização de entrada ScriptSig</a>. A serialização do campo de assinatura é detalhada em <a href="#seralization_of_signatures_der">Serialização de assinaturas (DER)</a>. O campo de assinatura também inclui um tipo de hash de assinatura (SIGHASH), que é detalhado em <a href="#sighash_types">Tipos de Hash de Assinatura (SIGHASH)</a>.</p>
</div>
<table id="scriptsig_in_structure" class="tableblock frame-all grid-all stretch data-line-299">
<caption class="title">Table 3. Serialização de entrada ScriptSig</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Tamanho</th>
<th class="tableblock halign-left valign-top">Campo</th>
<th class="tableblock halign-left valign-top">Descrição</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1&#x2013;9 bytes (VarInt)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tamanho da Assinatura</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Comprimento da assinatura em bytes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Variável</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Assinatura</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uma assinatura que é produzida pela carteira do usuário a partir de sua chave privada, que inclui um SIGHASH</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1&#x2013;9 bytes (VarInt)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tamanho da Chave Pública</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Comprimento da chave pública em bytes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Variável</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Chave Pública</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A chave pública, não transformada em hash</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3 data-line-308">
<h4 id="tx_fees">Taxas de Transação</h4>
<div class="paragraph data-line-310">
<p>A maioria das transações inclui taxas de transação, que compensam os mineradores de bitcoin por protegerem a rede. As taxas por si sós também servem como um mecanismo de segurança, tornando economicamente inviável para que atacantes inundem a rede com transações. A mineração, as taxas e as recompensas coletadas pelos mineradores são discutidas em maiores detalhes no <a href="#mining">[mining]</a>.</p>
</div>
<div class="paragraph data-line-312">
<p>Esta seção examina como as taxas de transação são incluídas em uma transação típica. A maioria das carteiras calcula e inclui automaticamente as taxas de transação. No entanto, se você estiver criando transações através de programação ou usando uma interface de linha de comando, você deve contabilizar e incluir manualmente essas taxas.</p>
</div>
<div class="paragraph data-line-314">
<p>As taxas de transação servem como um incentivo para incluir (minerar) uma transação no próximo bloco e também como um desincentivo ao abuso do sistema, ao imporem um pequeno custo em cada transação. As taxas de transação são coletadas pelo minerador que minera o bloco que registra a transação na blockchain.</p>
</div>
<div class="paragraph data-line-316">
<p>Transaction fees are calculated based on the size of the transaction in kilobytes, not the value of the transaction in bitcoin. Overall, transaction fees are set based on market forces within the Bitcoin network. Miners prioritize transactions based on many different criteria, including fees, and might even process transactions for free under certain circumstances. Transaction fees affect the processing priority, meaning that a transaction with sufficient fees is likely to be included in the next block mined, whereas a transaction with insufficient or no fees might be delayed, processed on a best-effort basis after a few blocks, or not processed at all. Transaction fees are not mandatory, and transactions without fees might be processed eventually; however, including transaction fees encourages priority processing.</p>
</div>
<div class="paragraph data-line-318">
<p>Ao longo do tempo, a forma como as taxas são calculadas e o efeito que elas tem na prioridade das transações evoluiu. Inicialmente, as taxas de transação eram fixas e constantes em toda a rede. Gradualmente, a estrutura de taxas foi flexibilizada, e agora as taxas podem ser influenciadas por forças do mercado, com base na capacidade da rede e no volume de transações. Desde, pelo menos, o início de 2016, os limites de capacidade no bitcoin criaram concorrência entre as transações, resultando em taxas mais altas e efetivamente tornando as transações gratuitas uma coisa do passado. Transações com taxa zero ou com taxa muito baixa raramente são mineradas e, às vezes, nem mesmo são propagadas pela rede.</p>
</div>
<div class="paragraph data-line-320">
<p>No Bitcoin Core, as políticas de taxa para retransmissão são definidas pela opção minrelaytxfee. O valor padrão atual da minrelaytxfee é 0,00001 bitcoin ou um centésimo de milibitcoin por kilobyte. Portanto, por padrão, as transações com uma taxa inferior a 0,00001 bitcoin são tratadas como gratuitas e só serão retransmitidas se houver espaço na mempool; caso contrário, elas serão descartadas. Os nós de bitcoin podem substituir a política de taxa para retransmissão padrão ajustando o valor da minrelaytxfee.</p>
</div>
<div class="paragraph data-line-322">
<p>Qualquer serviço de bitcoin que cria transações, incluindo carteiras, corretoras, aplicativos de varejo, etc., <em>deve</em> implementar taxas dinâmicas. As taxas dinâmicas podem ser implementadas por meio de um serviço de estimativa de taxa de terceiros ou com um algoritmo de estimativa de taxa integrado. Se você não tiver certeza, comece com um serviço de terceiros e, à medida que ganhar experiência, projete e implemente seu próprio algoritmo, caso você não queira mais ficar dependente de terceiros.</p>
</div>
<div class="paragraph data-line-324">
<p>Os algoritmos de estimativa de taxa calculam a taxa apropriada, com base na capacidade e nas taxas oferecidas pelas transações que estão "competindo". Esses algoritmos variam dos mais simples (taxa média ou mediana no último bloco) aos mais sofisticados (análise estatística). Eles estimam a taxa necessária (em satoshis por byte) que dará a uma transação uma alta probabilidade de ser selecionada e incluída em um determinado número de blocos. A maioria dos serviços oferece aos usuários a opção de escolher taxas de prioridade alta, média ou baixa. Alta prioridade significa que os usuários pagam taxas mais altas, mas a transação provavelmente será incluída no próximo bloco. Prioridades média e baixa significam que os usuários pagam taxas de transação mais baixas, mas a confirmação das transações pode demorar muito mais.</p>
</div>
<div class="paragraph data-line-326">
<p>Muitos aplicativos de carteira usam serviços de terceiros para cálculos de taxas. Um serviço popular é o <a href="https://bitcoinfees.earn.com/" data-href="https://bitcoinfees.earn.com/"><em>https://bitcoinfees.earn.com/</em></a>, que fornece uma API e um gráfico mostrando a taxa em satoshis/byte para diferentes prioridades.</p>
</div>
<div class="admonitionblock tip data-line-329">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-330">
<p>Static fees are no longer viable on the Bitcoin network. Wallets that set static fees will produce a poor user experience as transactions will often get "stuck" and remain unconfirmed. Users who don&#8217;t understand bitcoin transactions and fees are dismayed by "stuck" transactions because they think they&#8217;ve lost their money.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-333">
<p>O gráfico na <a href="#bitcoinfeesearncom">Serviço de estimativa de taxa bitcoinfees.earn.com</a> mostra a estimativa em tempo real das taxas em incrementos de 10 satoshis/byte e o tempo de confirmação esperado (em minutos e número de blocos) para transações com taxas em cada faixa. Para cada faixa de taxa (por exemplo, 61&#x2013;70 satoshis/byte), duas barras horizontais mostram o número de transações não confirmadas (1.405) e o número total de transações com taxas nessa faixa nas últimas 24 horas (102.975). Com base no gráfico, a taxa de alta prioridade recomendada naquele momento era de 80 satoshis/byte, uma taxa que provavelmente faria com que a transação fosse minerada no bloco seguinte (com atraso de bloco zero). Para se ter uma idéia, o tamanho mediano de uma transação é de 226 bytes, então a taxa recomendada para esse tamanho de transação seria 18.080 satoshis (0,00018080 BTC).</p>
</div>
<div class="paragraph data-line-335">
<p>Os dados de estimativa de taxa podem ser recuperados por meio de uma API HTTP REST simples, em <a href="https://bitcoinfees.earn.com/api/v1/fees/recommended" data-href="https://bitcoinfees.earn.com/api/v1/fees/recommended">https://bitcoinfees.earn.com/api/v1/fees/recommended</a>. Por exemplo, usando-se o comando curl na linha de comando:</p>
</div>
<div class="listingblock data-line-338">
<div class="title">Usando a API de estimativa de taxa</div>
<div class="content">
<pre>$ curl https://bitcoinfees.earn.com/api/v1/fees/recommended

{"fastestFee":80,"halfHourFee":80,"hourFee":60}</pre>
</div>
</div>
<div class="paragraph data-line-344">
<p>A API retorna um objeto JSON com a estimativa de taxa atual para a confirmação mais rápida (fastFee), para uma confirmação dentro de três blocos (halfHourFee) e para uma confirmação dentro de seis blocos (hourFee), em satoshis por byte.</p>
</div>
<div id="bitcoinfeesearncom" class="imageblock data-line-348">
<div class="content">
<img src="images/mbc2_0602.png" alt="Fee Estimation Service bitcoinfees.earn.com">
</div>
<div class="title">Figure 3. Serviço de estimativa de taxa bitcoinfees.earn.com</div>
</div>
</div>
<div class="sect3 data-line-350">
<h4 id="_adicionando_taxas_às_transações">Adicionando Taxas às Transações</h4>
<div class="paragraph data-line-352">
<p>A estrutura de dados das transações não tem um campo para as taxas. Em vez disso, infere-se que as taxas são a diferença entre a soma das entradas e a soma das saídas. Qualquer valor em excesso que permanece após todas as saídas terem sido deduzidas de todas as entradas é a taxa que é coletada pelos mineradores.</p>
</div>
<div id="tx_fee_equation" class="listingblock data-line-356">
<div class="title">As taxas de transação são implicitamente consideradas como o resto da subtração das entradas pela saídas:</div>
<div class="content">
<pre>Taxas = Soma(Entradas) – Soma(Saídas)</pre>
</div>
</div>
<div class="paragraph data-line-360">
<p>Isso é um elemento relativamente confuso das transações, e é um ponto importante para se compreender, pois se você está construindo as suas próprias transações, você deve se certificar de que você não incluiu uma taxa muito grande ao subutilizar as entradas. Isso significa que você deve contabilizar todas as entradas, e, se necessário, criar troco, caso contrário, você acabará dando uma gorjeta grande demais para os mineradores!</p>
</div>
<div class="paragraph data-line-362">
<p>Por exemplo, se você consumir uma UTXO de 20 bitcoins para fazer um pagamento de 1 bitcoin, você precisa incluir uma saída de troco de 19 bitcoins de volta para a sua carteira. Caso contrário, os 19 bitcoins que sobrarem serão contados como uma taxa de transação e serão coletados pelo minerador que minerar a sua transação em um bloco. A sua transação vai receber alta prioridade e o minerador vai ficar muito feliz, mas provavelmente não era isso que você queria fazer.</p>
</div>
<div class="admonitionblock warning data-line-365">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph data-line-366">
<p>Se você se esquecer de adicionar uma saída de troco em uma transação construída manualmente, o seu troco será usado para pagar a taxa da transação. Provavelmente a sua real intenção não era dizer ao minerador "Pode ficar com troco!"</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-369">
<p>Vamos ver como isso funciona na prática, ao analisar novamente a compra da xícara de café da Alice. A Alice quer gastar 0,015 BTC para pagar pelo café. Para ter a certeza de que essa transação será processada prontamente, ela terá que incluir uma taxa de transação, que digamos que seja de 0,0005 BTC. Isso significa que o custo total da transação será de 0,0155 BTC. A carteira dela, portanto, precisará usar um conjunto de UTXOs cuja soma resulte em 0,0155 BTC ou mais e, se necessário, terá que criar o troco. Digamos que a carteira dela tem uma UTXO de 0,1 BTC disponível. Portanto ela precisará consumir essa UTXO, criando uma saída de 0,015 BTC para a Cafeteria do Bob e uma segunda saída de 0,0845 BTC de troco de volta para a própria carteira dela, deixando 0,0005 BTC não alocado, que é uma taxa implícita pela transação.</p>
</div>
<div class="paragraph data-line-371">
<p>Agora vamos ver um cenário diferente. A Eugênia, nossa diretora da instituição de caridade para crianças nas Filipinas, completou uma campanha para arrecadação de fundos para comprar livros escolares para as crianças. Ela recebeu milhares de pequenas doações de pessoas de todos os lugares do mundo, totalizando 50 bitcoins, então sua carteira está cheia de pagamentos muito pequenos (UTXOs). Agora ela que comprar centenas de livros escolares da editora local, pagando em bitcoin.</p>
</div>
<div class="paragraph data-line-373">
<p>Ao tentar construir uma única transação de pagamento com uma quantia maior, o aplicativo de carteira da Eugênia deve utilizar o conjunto UTXO disponível, que é composto por várias quantias menores. Isso significa que a transação resultante utilizará mais de uma centena de UTXOs de pequeno valor como entradas, e terá apenas uma única saída, que será o pagamento à editora do livro. Uma transação com tantas entradas terá mais do que um kilobyte, talvez vários kilobytes. Como resultado, ela exigirá uma taxa muito maior do que a transação de tamanho mediano.</p>
</div>
<div class="paragraph data-line-375">
<p>O aplicativo de carteira da Eugênia calculará a taxa apropriada ao medir o tamanho da transação e multiplicá-lo pela taxa por kilobyte. Muitas carteiras pagarão taxas extras para transações de maior tamanho, a fim de garantir que a transação seja processada prontamente. A taxa não é maior pelo fato de a Eugênia estar gastando mais dinheiro, mas pelo fato de a transação dela ser mais complexa e ter um tamanho maior—a taxa é independente do valor da transação em bitcoins.</p>
</div>
</div>
</div>
<div class="sect2 pagebreak-before less_space_h1 data-line-379">
<h3 id="tx_script">Scripts de Transação e Linguagem de Script</h3>
<div class="paragraph data-line-381">
<p>A linguagem de script da transação do bitcoin, chamada <em>Script</em>, é uma linguagem de execução baseada em pilha de notação polonesa reversa, semelhante à linguagem Forth. Se isso soa como um jargão, você provavelmente não estudou as linguagens de programação dos anos 1960, mas tudo bem&#x2014;explicaremos tudo o que você precisa saber neste capítulo. Tanto o script de travamento colocado em uma UTXO quanto o script de destravamento são escritos nesta linguagem de script. Quando uma transação é validada, o script de destravamento em cada entrada é executado junto com o script de travamento correspondente para ver se ele satisfaz a condição de gasto.</p>
</div>
<div class="paragraph data-line-383">
<p>A Script é uma linguagem muito simples que foi projetada para ser limitada em escopo e executável em uma variedade de hardwares, talvez tão simples quanto um dispositivo embutido. Ela requer processamento mínimo e não consegue fazer muitas das coisas extravagantes que as linguagens de programação modernas conseguem fazer. Para seu uso na validação de dinheiro programável, este é um recurso de segurança deliberado.</p>
</div>
<div class="paragraph data-line-385">
<p>Today, most transactions processed through the Bitcoin network have the form "Payment to Bob&#8217;s Bitcoin address" and are based on a script called a Pay-to-Public-Key-Hash script.  However, bitcoin transactions are not limited to the "Payment to Bob&#8217;s Bitcoin address" script. In fact, locking scripts can be written to express a vast variety of complex conditions. In order to understand these more complex scripts, we must first understand the basics of transaction scripts and script language.</p>
</div>
<div class="paragraph data-line-387">
<p>Nesta seção, demonstraremos os componentes básicos da linguagem de script da transação de bitcoin e mostraremos como ela pode ser usada para expressar condições simples para que o dinheiro seja gasto e como essas condições podem ser satisfeitas através de scripts de destravamento.</p>
</div>
<div class="admonitionblock tip data-line-390">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-391">
<p>A validação da transação de bitcoin não é baseada em um padrão estático, em vez disso, ela é obtida através da execução de uma linguagem de script. Essa linguagem permite que uma variedade quase infinita de condições seja expressa. É dessa maneira que o bitcoin recebe o poder de ser um "dinheiro programável".</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3 data-line-395">
<h4 id="_incompletude_de_turing">Incompletude de Turing</h4>
<div class="paragraph data-line-397">
<p>The bitcoin transaction script language contains many operators, but is deliberately limited in one important way&#8212;&#8203;there are no loops or complex flow control capabilities other than conditional flow control. This ensures that the language is not <em>Turing Complete</em>, meaning that scripts have limited complexity and predictable execution times. Script is not a general-purpose language. These limitations ensure that the language cannot be used to create an infinite loop or other form of "logic bomb" that could be embedded in a transaction in a way that causes a denial-of-service attack against the Bitcoin network. Remember, every transaction is validated by every full node on the Bitcoin network. A limited language prevents the transaction validation mechanism from being used as a vulnerability.</p>
</div>
</div>
<div class="sect3 data-line-399">
<h4 id="_verificação_sem_estado">Verificação sem Estado</h4>
<div class="paragraph data-line-401">
<p>The bitcoin transaction script language is stateless, in that there is no state prior to execution of the script, or state saved after execution of the script. Therefore, all the information needed to execute a script is contained within the script. A script will predictably execute the same way on any system. If your system verifies a script, you can be sure that every other system in the Bitcoin network will also verify the script, meaning that a valid transaction is valid for everyone and everyone knows this. This predictability of outcomes is an essential benefit of the Bitcoin system.</p>
</div>
</div>
<div class="sect3 data-line-404">
<h4 id="tx_lock_unlock">Construção do Script (Travamento + Destravamento)</h4>
<div class="paragraph data-line-406">
<p>O mecanismo de validação de transações do bitcoin conta com dois tipos de scripts para validar transações: um script de travamento e um script de destravamento.</p>
</div>
<div class="paragraph data-line-408">
<p>A locking script is a spending condition placed on an output: it specifies the conditions that must be met to spend the output in the future. Historically, the locking script was called a <em>scriptPubKey</em>, because it usually contained a public key or Bitcoin address (public key hash). In this book we refer to it as a "locking script" to acknowledge the much broader range of possibilities of this scripting technology. In most bitcoin applications, what we refer to as a locking script will appear in the source code as scriptPubKey. You will also see the locking script referred to as a <em>witness script</em> (see <a href="#segwit">[segwit]</a>) or more generally as a <em>cryptographic puzzle</em>. These terms all mean the same thing, at different levels of abstraction.</p>
</div>
<div class="paragraph data-line-410">
<p>Um script de destravamento é um script que "resolve", ou satisfaz, as condições que foram colocadas em uma saída por um script de travamento, permitindo que a saída seja gasta. Os scripts de destravamento fazem parte de todas as entradas de transação. Na maioria das vezes, eles contêm uma assinatura digital produzida pela carteira do usuário a partir de sua chave privada. Historicamente, o script de destravamento era chamado de <em>scriptSig</em>, porque ele geralmente continha uma assinatura digital. Na maioria das aplicações de bitcoin, o código-fonte refere-se ao script de destravamento como scriptSig. Você também verá o script de destravamento sendo referido como uma <em>testemunha</em> (em inglês, <em>witness</em>) (ver <a href="#segwit">[segwit]</a>). Neste livro, nos referimos a ele como um "script de destravamento", para reconhecer a gama muito maior de exigências dos scripts de travamento, pois nem todos os scripts de destravamento precisam conter assinaturas.</p>
</div>
<div class="paragraph data-line-412">
<p>Cada nó validador do bitcoin validará transações ao executar os scripts de travamento e destravamento juntos. Cada entrada contém um script de destravamento e refere-se a uma UTXO previamente existente. O software de validação copiará o script de destravamento, recuperará a UTXO referenciada pela entrada e copiará o script de travamento dessa UTXO. A seguir, os scripts de destravamento e travamento são executados em sequência. A entrada é considerada válida se o script de destravamento satisfizer as condições do script de travamento (ver <a href="#script_exec">Execução separada de scripts de destravamento e travamento</a>). Todas as entradas são validadas de forma independente, como parte da validação geral da transação.</p>
</div>
<div class="paragraph data-line-414">
<p>Como a UTXO é armazenada permanentemente na blockchain, ela é invariável, não sendo afetada por tentativas fracassadas de gastá-la através de uma referência em uma nova transação. Somente uma transação válida, que satisfaça corretamente as condições da saída, fará com que uma saída seja considerada "gasta" e seja removida do conjunto de saídas de transação não gastas (conjunto UTXO).</p>
</div>
<div class="paragraph data-line-416">
<p>A <a href="#scriptSig_and_scriptPubKey">Combinando o scriptSig e o scriptPubKey para avaliar um script de transação</a> é um exemplo de scripts de destravamento e travamento para o tipo mais comum de transação de bitcoin (um pagamento para um hash de endereço público), demonstrando o script combinado resultante da concatenação dos scripts de destravamento e travamento antes da validação do script.</p>
</div>
<div id="scriptSig_and_scriptPubKey" class="imageblock data-line-420">
<div class="content">
<img src="images/mbc2_0603.png" alt="scriptSig_and_scriptPubKey">
</div>
<div class="title">Figure 4. Combinando o scriptSig e o scriptPubKey para avaliar um script de transação</div>
</div>
<div class="sect4 data-line-422">
<h5 id="_o_stack_de_execução_do_script">O stack de execução do script</h5>
<div class="paragraph data-line-424">
<p>A linguagem de script do bitcoin é considerada uma linguagem baseada em stack, pois ela usa uma estrutura de dados chamada de <em>stack</em> (em português, <em>pilha</em>). Um stack é uma estrutura de dados muito simples, que pode ser imaginada como uma pilha de cartas de baralho. Um stack permite duas operações: adicionar ("push") e remover ("pop"). "Adicionar" ("push") adiciona um item no topo da pilha. "Remover" ("pop") retira o item que está no topo da pilha. As operações em uma pilha só podem agir no item que está no topo da pilha. Uma estrutura de dados em pilha também é chamada de Last-In-First-Out (o último a entrar é o primeiro a sair) ou fila "LIFO".</p>
</div>
<div class="paragraph data-line-426">
<p>A linguagem de script executa o script ao processar cada item da esquerda para a direita. Os números (constantes de dados) são adicionados no stack. Os operadores adicionam (push) ou removem (pop) um ou mais parâmetros do stack, atuam neles e podem adicionar um resultado no stack. Por exemplo, o operador OP_ADD irá remover dois itens do stack, somá-los e adicionar o resultado da soma no stack.</p>
</div>
<div class="paragraph data-line-428">
<p>Os operadores condicionais avaliam uma condição, produzindo um resultado booleano TRUE (VERDADEIRO) ou FALSE (FALSO). Por exemplo, OP_EQUAL remove (pop) dois itens do stack e adiciona TRUE (TRUE representado pelo número 1) se eles forem iguais ou FALSE (representado por zero) se eles não forem iguais. Os scripts de transação do bitcoin geralmente contêm um operador condicional, de maneira que eles possam produzir o resultado TRUE que significa uma transação válida.</p>
</div>
</div>
<div class="sect4 data-line-430">
<h5 id="_um_script_simples">Um script simples</h5>
<div class="paragraph data-line-432">
<p>Agora vamos aplicar o que aprendemos sobre scripts e stacks a alguns exemplos simples.</p>
</div>
<div class="paragraph data-line-434">
<p>Na <a href="#simplemath_script">Script de validação do bitcoin fazendo uma conta matemática simples</a>, o script 2 3 OP_ADD 5 OP_EQUAL demonstra o operador de adição aritmética OP_ADD somando dois números e colocando o resultado no stack, seguido pelo operador condicional OP_EQUAL, que verifica se a soma resultante é igual a 5. Para simplificar, o prefixo OP_ é omitido no exemplo passo-a-passo. Para obter mais detalhes sobre os operadores de script e as funções disponíveis, consulte o <a href="#tx_script_ops">[tx_script_ops]</a>.</p>
</div>
<div class="paragraph data-line-436">
<p>Although most locking scripts refer to a public key hash (essentially, a Bitcoin address), thereby requiring proof of ownership to spend the funds, the script does not have to be that complex. Any combination of locking and unlocking scripts that results in a TRUE value is valid. The simple arithmetic we used as an example of the scripting language is also a valid locking script that can be used to lock a transaction output.</p>
</div>
<div class="paragraph data-line-438">
<p>Use parte do script de exemplo aritmético como sendo o script de travamento:</p>
</div>
<div class="listingblock data-line-440">
<div class="content">
<pre>3 OP_ADD 5 OP_EQUAL</pre>
</div>
</div>
<div class="paragraph data-line-444">
<p>que pode ser satisfeito através de uma transação contendo uma entrada com o script de destravamento:</p>
</div>
<div class="listingblock data-line-446">
<div class="content">
<pre>2</pre>
</div>
</div>
<div class="paragraph data-line-450">
<p>O software de validação combina os scripts de travamento e de destravamento e o script resultante é:</p>
</div>
<div class="listingblock data-line-452">
<div class="content">
<pre>2 3 OP_ADD 5 OP_EQUAL</pre>
</div>
</div>
<div class="paragraph data-line-456">
<p>Conforme vimos no exemplo passo-a-passo da <a href="#simplemath_script">Script de validação do bitcoin fazendo uma conta matemática simples</a>, quando o script é executado, o resultado é OP_TRUE, tornando a transação válida. Não apenas esse é um script de travamento válido, como também a UTXO resultante poderia ser gasta por qualquer pessoa que tivesse as habilidades aritméticas para saber que o número 2 satisfaz o script.</p>
</div>
<div class="admonitionblock tip data-line-459">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-460">
<p>As transações são válidas se o resultado no topo do stack for TRUE (definido como &amp;#x7b;0x01&amp;#x7d;), qualquer valor diferente de zero, não OP_0, ou se o stack estiver vazio após a execução do script. As transações são inválidas se o valor do topo do stack for FALSE (um valor vazio de comprimento zero, definido como &amp;#x7b;&amp;#x7d;) ou se a execução do script for suspensa por um operador, como o OP_VERIFY, o OP_RETURN ou um terminador condicional como o OP_ENDIF. Veja o <a href="#tx_script_ops">[tx_script_ops]</a> para mais detalhes.</p>
</div>
</td>
</tr>
</table>
</div>
<div id="simplemath_script" class="imageblock data-line-465">
<div class="content">
<img src="images/mbc2_0604.png" alt="TxScriptSimpleMathExample">
</div>
<div class="title">Figure 5. Script de validação do bitcoin fazendo uma conta matemática simples</div>
</div>
<div class="paragraph pagebreak-before data-line-468">
<p>O script a seguir é um pouco mais complexo, que calcula 2 + 7 - 3 + 1. Note que quando o script contém vários operadores em uma linha, o stack permite que os resultados de um operador sejam usados pelo próximo operador:</p>
</div>
<div class="listingblock data-line-470">
<div class="content">
<pre>2 7 OP_ADD 3 OP_SUB 1 OP_ADD 7 OP_EQUAL</pre>
</div>
</div>
<div class="paragraph data-line-474">
<p>Tente você mesmo validar o script anterior usando papel e caneta. Quando a execução do script terminar, você deve ficar com o valor TRUE no stack.</p>
</div>
</div>
<div class="sect4 data-line-477">
<h5 id="script_exec">Execução separada de scripts de destravamento e travamento</h5>
<div class="paragraph data-line-479">
<p>In the original Bitcoin client, the unlocking and locking scripts were concatenated and executed in sequence. For security reasons, this was changed in 2010, because of a vulnerability that allowed a malformed unlocking script to push data onto the stack and corrupt the locking script. In the current implementation, the scripts are executed separately with the stack transferred between the two executions, as described next.</p>
</div>
<div class="paragraph data-line-481">
<p>Primeiro, o script de destravamento é executado, usando o mecanismo de execução do stack. Se o script de destravamento for executado sem erros (por exemplo, ele não possui ponteiros "pendentes" faltando), o stack principal é copiado e o script de travamento é executado. Se o resultado da execução do script de travamento com os dados do stack copiados a partir do script de destravamento for "TRUE", o script de destravamento teve sucesso em resolver as condições impostas pelo script de travamento e, portanto, a entrada é uma autorização válida para gastar a UTXO. Se qualquer resultado diferente de "TRUE" permanecer após a execução do script combinado, a entrada é inválida, pois ela não conseguiu satisfazer as condições de gasto impostas na UTXO.</p>
</div>
</div>
</div>
<div class="sect3 data-line-485">
<h4 id="p2pkh">Pay-to-Public-Key-Hash (P2PKH)</h4>
<div class="paragraph data-line-487">
<p>The vast majority of transactions processed on the Bitcoin network spend outputs locked with a Pay-to-Public-Key-Hash or "P2PKH" script. These outputs contain a locking script that locks the output to a public key hash, more commonly known as a Bitcoin address. An output locked by a P2PKH script can be unlocked (spent) by presenting a public key and a digital signature created by the corresponding private key (see <a href="#digital_sigs">Assinaturas Digitais (ECDSA)</a>).</p>
</div>
<div class="paragraph data-line-489">
<p>For example, let&#8217;s look at Alice&#8217;s payment to Bob&#8217;s Cafe again. Alice made a payment of 0.015 bitcoin to the cafe&#8217;s Bitcoin address. That transaction output would have a locking script of the form:</p>
</div>
<div class="listingblock data-line-491">
<div class="content">
<pre>OP_DUP OP_HASH160 &lt;Hash da Chave Pública do Café&gt; OP_EQUALVERIFY OP_CHECKSIG</pre>
</div>
</div>
<div class="paragraph data-line-495">
<p>The Cafe Public Key Hash is equivalent to the Bitcoin address of the cafe, without the Base58Check encoding. Most applications would show the <em>public key hash</em> in hexadecimal encoding and not the familiar Bitcoin address Base58Check format that begins with a "1."</p>
</div>
<div class="paragraph data-line-497">
<p>O script de travamento anterior pode ser satisfeito com um script de destravamento com o seguinte formato:</p>
</div>
<div class="listingblock data-line-499">
<div class="content">
<pre>&lt;Assinatura do Café&gt; &lt;Chave Pública do Café&gt;</pre>
</div>
</div>
<div class="paragraph data-line-503">
<p>Os dois scripts juntos formariam o seguinte script de validação combinado:</p>
</div>
<div class="listingblock data-line-505">
<div class="content">
<pre>&lt;Assinatura do Café&gt; &lt;Chave Pública do Café&gt; OP_DUP OP_HASH160
&lt;Hash da Chave Pública do Café&gt; OP_EQUALVERIFY OP_CHECKSIG</pre>
</div>
</div>
<div class="paragraph data-line-510">
<p>Quando executado, esse script combinado resultará em TRUE se, e somente se, o script de destravamento preencher as condições definidas pelo script de travamento. Em outras palavras, o resultado será TRUE se o script de destravamento tiver uma assinatura válida da chave privada do café que corresponda ao hash de chave pública que foi definido como uma trava.</p>
</div>
<div class="paragraph data-line-512">
<p>As Figuras <a data-type="xref" href="#P2PubKHash1" data-xrefstyle="select: labelnumber">#P2PubKHash1</a> e <a data-type="xref" href="#P2PubKHash2" data-xrefstyle="select: labelnumber">#P2PubKHash2</a> demonstram (em duas partes) uma execução passo-a-passo do script combinado, que provará que essa é uma transação válida.</p>
</div>
<div id="P2PubKHash1" class="imageblock data-line-516">
<div class="content">
<img src="images/mbc2_0605.png" alt="Tx_Script_P2PubKeyHash_1">
</div>
<div class="title">Figure 6. Avaliando um script para uma transação P2PKH (parte 1 de 2)</div>
</div>
<div id="P2PubKHash2" class="imageblock data-line-520">
<div class="content">
<img src="images/mbc2_0606.png" alt="Tx_Script_P2PubKeyHash_2">
</div>
<div class="title">Figure 7. Avaliando um script para uma transação P2PKH (parte 2 de 2)</div>
</div>
</div>
</div>
<div class="sect2 data-line-523">
<h3 id="digital_sigs">Assinaturas Digitais (ECDSA)</h3>
<div class="paragraph data-line-525">
<p>Até agora, não nos aprofundamos em detalhes sobre as "assinaturas digitais". Nesta seção, veremos como as assinaturas digitais funcionam e como elas podem apresentar uma prova de posse de uma chave privada sem revelar essa chave privada.</p>
</div>
<div class="paragraph data-line-527">
<p>O algoritmo de assinatura digital usado no bitcoin é o <em>Algoritmo de Assinatura Digital de Curva Elíptica</em> (em inglês, <em>Elliptic Curve Digital Signature Algorithm</em> ou <em>ECDSA</em>). O ECDSA é o algoritmo usado para assinaturas digitais com base em pares de chaves privadas/públicas em curva elíptica, conforme descrito em <a href="#elliptic_curve">[elliptic_curve]</a>. O ECDSA é usado pelas funções de script OP_CHECKSIG, OP_CHECKSIGVERIFY, OP_CHECKMULTISIG e OP_CHECKMULTISIGVERIFY. Sempre que você encontrar essas funções em um script de travamento, o script de destravamento necessariamente precisa conter uma assinatura ECDSA.</p>
</div>
<div class="paragraph data-line-529">
<p>Uma assinatura digital tem três finalidades no bitcoin. Primeiro, a assinatura prova que o proprietário da chave privada, que se subentende ser o proprietário dos fundos, <em>autorizou</em> o gasto desses fundos. Em segundo lugar, a prova de autorização é <em>inegável</em> (não repúdio). Em terceiro lugar, a assinatura prova que a transação (ou partes específicas da transação) não foi e <em>não pode ser modificada</em> por ninguém após ter sido assinada.</p>
</div>
<div class="paragraph data-line-531">
<p>Observe que cada entrada de transação é assinada de forma independente. Isso é fundamental, pois nem as assinaturas nem as entradas precisam pertencer ou serem usadas pelos mesmos "donos". Um esquema específico de transação chamado "CoinJoin" usa esse fato para criar transações com entradas de diferentes usuários com o objetivo de se obter maior privacidade.</p>
</div>
<div class="admonitionblock note data-line-534">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-535">
<p>Cada entrada de transação e qualquer assinatura que ela possa conter é <em>completamente</em> independente de qualquer outra entrada ou assinatura. Vários usuários podem se unir para construir transações em que cada um assina apenas uma única entrada.</p>
</div>
</td>
</tr>
</table>
</div>
<div id="digital_signature_definition" class="sidebarblock data-line-540">
<div class="content">
<div class="title">Definição de "Assinatura Digital" da Wikipédia</div>
<div class="paragraph data-line-541">
<p>Uma assinatura digital é um esquema matemático usado para demonstrar a autenticidade de uma mensagem ou documentos digitais. Uma assinatura digital válida dá ao destinatário motivos para acreditar que a mensagem foi criada por um remetente conhecido (autenticação), que o remetente não pode negar ter enviado da mensagem (não repúdio) e que a mensagem não foi alterada em trânsito (integridade).</p>
</div>
<div class="paragraph data-line-543">
<p><em>Fonte: <a href="https://en.wikipedia.org/wiki/Digital_signature" class="undefined" data-href="https://en.wikipedia.org/wiki/Digital_signature">https://en.wikipedia.org/wiki/Digital_signature</a></em></p>
</div>
</div>
</div>
<div class="sect3 data-line-546">
<h4 id="_como_funcionam_as_assinaturas_digitais">Como Funcionam as Assinaturas Digitais</h4>
<div class="paragraph data-line-548">
<p>Uma assinatura digital é um <em>esquema matemático</em> que consiste em duas partes. A primeira parte é um algoritmo usado para criar uma assinatura, usando uma chave privada (a chave de assinatura), a partir de uma mensagem (a transação). A segunda parte é um algoritmo que permite a qualquer pessoa verificar a assinatura, caso seja fornecida a mensagem e uma chave pública.</p>
</div>
<div class="sect4 data-line-550">
<h5 id="_criando_uma_assinatura_digital">Criando uma assinatura digital</h5>
<div class="paragraph data-line-552">
<p>Na implementação do bitcoin do algoritmo ECDSA, a "mensagem" sendo assinada é a transação, ou, mais precisamente, um hash de um subconjunto específico dos dados incluídos na transação (ver <a href="#sighash_types">Tipos de Hash de Assinatura (SIGHASH)</a>). A chave de assinatura é a chave privada do usuário. O resultado é a assinatura:</p>
</div>
<div class="paragraph data-line-554">
<p>\(\(Sig = F_{sig}(F_{hash}(m), dA)\)\)</p>
</div>
<div class="paragraph data-line-556">
<p>onde:</p>
</div>
<div class="ulist data-line-558">
<ul>
<li class="data-line-558">
<p><em>dA</em> é a chave privada que assina</p>
</li>
<li class="data-line-559">
<p><em>m</em> é a transação (ou partes dela)</p>
</li>
<li class="data-line-560">
<p><em>F</em><sub><em>hash</em></sub> é a função de hash</p>
</li>
<li class="data-line-561">
<p><em>F</em><sub><em>sig</em></sub> é o algoritmo de assinatura</p>
</li>
<li class="data-line-562">
<p><em>Sig</em> é a assinatura resultante</p>
</li>
</ul>
</div>
<div class="paragraph data-line-564">
<p>Mais detalhes sobre a matemática do Algoritmo de Assinatura Digital de Curva Elíptica (ECDSA) podem ser encontrados em <a href="#ecdsa_math">Matemática do ECDSA</a>.</p>
</div>
<div class="paragraph data-line-566">
<p>A função <em>F</em><sub><em>sig</em></sub> produz uma assinatura Sig que é composta de dois valores, comumente referidos como R e S:</p>
</div>
<div class="listingblock data-line-568">
<div class="content">
<pre>Sig = (R, S)</pre>
</div>
</div>
<div class="paragraph data-line-572">
<p>Agora que os dois valores R e S foram calculados, eles são serializados em um fluxo de bytes usando um esquema de codificação padronizado internacional denominado <em>Regras de Codificação Distintas</em> (em inglês, <em>Distinguished Encoding Rules</em> ou <em>DER</em>).</p>
</div>
</div>
<div class="sect4 data-line-575">
<h5 id="seralization_of_signatures_der">Serialização de assinaturas (DER)</h5>
<div class="paragraph data-line-577">
<p>Vejamos novamente a transação que a Alice criou. Na entrada da transação, há um script de destravamento que contém a seguinte assinatura codificada em DER pela carteira da Alice:</p>
</div>
<div class="listingblock data-line-579">
<div class="content">
<pre>3045022100884d142d86652a3f47ba4746ec719bbfbd040a570b1deccbb6498c75c4ae24cb02204b9f039ff08df09cbe9f6addac960298cad530a863ea8f53982c09db8f6e381301</pre>
</div>
</div>
<div class="paragraph data-line-583">
<p>Essa assinatura é um stream de bytes serializado dos valores R e S produzidos pela carteira da Alice para provar que ela possui a chave privada autorizada a gastar aquela saída. O formato de serialização consiste em nove elementos, abaixo descritos:</p>
</div>
<div class="ulist data-line-585">
<ul>
<li class="data-line-585">
<p>0x30&#x2014;indicando o início de uma sequência DER</p>
</li>
<li class="data-line-586">
<p>0x45&#x2014;o comprimento da sequência (69 bytes)</p>
</li>
<li class="data-line-587">
<p>0x02&#x2014;segue-se um valor inteiro</p>
</li>
<li class="data-line-588">
<p>0x21&#x2014;o comprimento do número inteiro (33 bytes)</p>
</li>
<li class="data-line-589">
<p>R&#x2014;00884d142d86652a3f47ba4746ec719bbfbd040a570b1deccbb6498c75c4ae24cb</p>
</li>
<li class="data-line-590">
<p>0x02&#x2014;segue-se um outro valor inteiro</p>
</li>
<li class="data-line-591">
<p>0x20&#x2014;o comprimento do número inteiro (32 bytes)</p>
</li>
<li class="data-line-592">
<p>S&#x2014;4b9f039ff08df09cbe9f6addac960298cad530a863ea8f53982c09db8f6e3813</p>
</li>
<li class="data-line-593">
<p>Um sufixo (0x01) indicando o tipo de hash utilizado (SIGHASH_ALL)</p>
</li>
</ul>
</div>
<div class="paragraph data-line-595">
<p>Veja se você consegue decodificar a assinatura serializada da Alice (codificada em DER) usando esta lista. Os números importantes são R e S; o restante dos dados faz parte do esquema de codificação DER.</p>
</div>
</div>
</div>
<div class="sect3 data-line-597">
<h4 id="_verificando_a_assinatura">Verificando a Assinatura</h4>
<div class="paragraph data-line-599">
<p>Para verificar a assinatura, deve-se ter a assinatura (R e S), a transação serializada e a chave pública (que corresponde à chave privada usada para criar a assinatura). Essencialmente, a verificação de uma assinatura significa "Apenas o proprietário da chave privada que gerou esta chave pública poderia ter produzido esta assinatura nesta transação".</p>
</div>
<div class="paragraph data-line-601">
<p>O algoritmo de verificação de assinatura pega a mensagem (um hash da transação ou partes dela), a chave pública do signatário e a assinatura (valores R e S) e retorna TRUE se a assinatura for válida para esta mensagem e esta chave pública.</p>
</div>
</div>
<div class="sect3 data-line-604">
<h4 id="sighash_types">Tipos de Hash de Assinatura (SIGHASH)</h4>
<div class="paragraph data-line-606">
<p>As assinaturas digitais são aplicadas às mensagens, que, no caso do bitcoin, são as próprias transações. A assinatura implica um <em>compromisso</em> (um comprometimento) por parte do signatário com dados de transação específicos. Na forma mais simples, a assinatura se aplica a toda a transação, comprometendo-se com todas as entradas, todas as saídas e todos os outros campos da transação. No entanto, uma assinatura pode comprometer-se com apenas um subconjunto dos dados em uma transação, o que é útil para vários cenários, como veremos nesta seção.</p>
</div>
<div class="paragraph data-line-608">
<p>Ao utilizar um sinalizador SIGHASH, as assinaturas do bitcoin têm uma maneira de indicar qual parte dos dados de uma transação está incluída no hash assinado pela chave privada. O sinalizador SIGHASH é um único byte que é anexado à assinatura. Cada assinatura tem um sinalizador SIGHASH e o sinalizador pode ser diferente de entrada para entrada. Uma transação com três entradas assinadas pode ter três assinaturas com diferentes sinalizadores SIGHASH, cada assinatura assinando (comprometendo-se com) diferentes partes da transação.</p>
</div>
<div class="paragraph data-line-610">
<p>Remember, each input may contain a signature in its unlocking script. As a result, a transaction that contains several inputs may have signatures with different SIGHASH flags that commit different parts of the transaction in each of the inputs. Note also that bitcoin transactions may contain inputs from different "owners," who may sign only one input in a partially constructed (and invalid) transaction, collaborating with others to gather all the necessary signatures to make a valid transaction. Many of the SIGHASH flag types only make sense if you think of multiple participants collaborating outside the Bitcoin network and updating a partially signed transaction.</p>
</div>
<div class="paragraph pagebreak-before data-line-613">
<p>Existem três sinalizadores SIGHASH: ALL, NONE e SINGLE, conforme mostrado na <a href="#sighash_types_and_their">Tipos de SIGHASH e seus significados</a>.</p>
</div>
<table id="sighash_types_and_their" class="tableblock frame-all grid-all stretch data-line-618">
<caption class="title">Table 4. Tipos de SIGHASH e seus significados</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sinalizador SIGHASH</th>
<th class="tableblock halign-left valign-top">Valor</th>
<th class="tableblock halign-left valign-top">Descrição</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ALL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x01</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A assinatura se aplica a todas as entradas e saídas</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NONE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x02</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A assinatura se aplica a todas as entradas e nenhuma das saídas</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SINGLE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x03</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A assinatura se aplica a todas as entradas, mas somente à saída com o mesmo número índice da entrada assinada</p></td>
</tr>
</tbody>
</table>
<div class="paragraph data-line-625">
<p>Além disso, há um sinalizador modificador SIGHASH_ANYONECANPAY, que pode ser combinado com cada um dos sinalizadores anteriores. Quando ANYONECANPAY é definido, apenas uma entrada é assinada, deixando o resto (e seus números de sequência) abertos para modificação. O ANYONECANPAY tem o valor 0x80 e é aplicado pelo operador bitwise OR, resultando nos sinalizadores combinados mostrados na <a href="#sighash_types_with_modifiers">Tipos de SIGHASH com modificadores e seus significados</a>.</p>
</div>
<table id="sighash_types_with_modifiers" class="tableblock frame-all grid-all stretch data-line-630">
<caption class="title">Table 5. Tipos de SIGHASH com modificadores e seus significados</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sinalizador SIGHASH</th>
<th class="tableblock halign-left valign-top">Valor</th>
<th class="tableblock halign-left valign-top">Descrição</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ALL|ANYONECANPAY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x81</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A assinatura se aplica a uma entrada e todas as saídas</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NONE|ANYONECANPAY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x82</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A assinatura se aplica a uma entrada e nenhuma das saídas</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SINGLE|ANYONECANPAY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x83</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A assinatura se aplica a uma entrada e à saída com o mesmo número índice</p></td>
</tr>
</tbody>
</table>
<div class="paragraph data-line-637">
<p>Essas combinações de sinalizadores estão resumidas na <a href="#sighash_combinations">Resumo das diferentes combinações de sighash</a>.</p>
</div>
<div id="sighash_combinations" class="imageblock data-line-641">
<div class="content">
<img src="images/sighash_combinations.png" alt="Summary of different SIGHASH flag combinations">
</div>
<div class="title">Figure 8. Resumo das diferentes combinações de sighash</div>
</div>
<div class="paragraph data-line-643">
<p>Os sinalizadores SIGHASH são aplicados durante a assinatura e a verificação de uma maneira que uma cópia da transação é feita e certos campos dentro dela são truncados (são definidos para comprimento zero e esvaziados). A transação resultante é serializada. O sinalizador SIGHASH é adicionado ao final da transação serializada e o resultado é transformado em um hash. O próprio hash é a "mensagem" que é assinada. Dependendo de qual sinalizador SIGHASH for usado, diferentes partes da transação são truncadas. O hash resultante depende de diferentes subconjuntos dos dados na transação. Ao incluir o SIGHASH na última etapa antes de transformar em hash, a assinatura também compromete-se com o tipo do SIGHASH, de maneira que ele não possa ser alterado no futuro (por exemplo, por um minerador).</p>
</div>
<div class="admonitionblock note data-line-646">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-647">
<p>Todos os tipos de SIGHASH assinam o campo nLocktime da transação (ver <a href="#transaction_locktime_nlocktime">[transaction_locktime_nlocktime]</a>). Além disso, o próprio tipo do SIGHASH é anexado à transação antes de ela ser assinada, de modo que ele não possa ser modificado depois de a transação ser assinada.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-650">
<p>No exemplo da transação da Alice (ver a lista em <a href="#seralization_of_signatures_der">Serialização de assinaturas (DER)</a>), vimos que a última parte da assinatura codificada em DER era 01, que é o sinalizador SIGHASH_ALL. Isso trava os dados da transação, portanto a assinatura da Alice está comprometendo-se com o estado de todas as entradas e saídas. Esta é a forma de assinatura mais comum.</p>
</div>
<div class="paragraph data-line-652">
<p>Vejamos alguns dos outros tipos de SIGHASH e como eles podem ser usados na prática:</p>
</div>
<div class="dlist data-line-654">
<dl>
<dt class="hdlist1">ALL|ANYONECANPAY </dt>
<dd>
<p>Esta construção pode ser usada para fazer uma transação de "financiamento coletivo". Alguém tentando arrecadar fundos pode construir uma transação com uma única saída. A saída única da transação paga o valor da "meta" para a pessoa que está arrecadando os fundos. Essa transação obviamente não é válida, pois ela não tem entradas. No entanto, outras pessoas agora podem alterá-la adicionando suas próprias entradas, como uma doação. Elas assinam suas próprias entradas com ALL|ANYONECANPAY. A menos que entradas suficientes sejam coletadas para atingir o valor da saída, a transação é inválida. Cada doação serve como uma garantia de pagamento, que não pode ser coletada pela pessoa que está arrecadando os fundos até que todo o valor da meta tenha sido arrecadado.</p>
</dd>
<dt class="hdlist1">NONE </dt>
<dd>
<p>This construction can be used to create a "bearer check" or "blank check" of a specific amount. It commits to the input, but allows the output locking script to be changed. Anyone can write their own Bitcoin address into the output locking script and redeem the transaction. However, the output value itself is locked by the signature.</p>
</dd>
<dt class="hdlist1">NONE|ANYONECANPAY </dt>
<dd>
<p>Esta construção pode ser usada para construir um "coletor de pó". Os usuários que têm UTXOs minúsculas em suas carteiras não conseguem gastá-las, pois o custo em taxas é maior do que o valor dessas UTXOs pó. Com este tipo de assinatura, pode-se doar as UTXOs pó para qualquer pessoa agregá-las e gastá-las quando quiser.</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-660">
<p>Existem algumas propostas para modificar ou expandir o sistema SIGHASH. Uma dessas propostas é a <em>Bitmask Sighash Modes</em> feita por Glenn Willen da Blockstream, como parte do projeto Elements. O objetivo é criar uma substituição flexível para os tipos de SIGHASH que permite a criação de "bitmasks de entradas e saídas que sejam arbitrários e regraváveis pelos mineradores" e que possam expressar "esquemas de pré-compromisso contratual mais complexos, como ofertas assinadas com troco em uma troca de ativos distribuída".</p>
</div>
<div class="admonitionblock note data-line-663">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-664">
<p>Você não verá os sinalizadores SIGHASH apresentados como uma opção no aplicativo de carteira do usuário. Com poucas exceções, as carteiras geralmente constroem scripts P2PKH e assinam com sinalizadores SIGHASH_ALL. Para usar um sinalizador SIGHASH diferente, você teria que escrever um software para construir e assinar transações. Ou seja, os sinalizadores SIGHASH geralmente são usados por aplicativos de bitcoin de propósito especial que permitem novos usos.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3 data-line-668">
<h4 id="ecdsa_math">Matemática do ECDSA</h4>
<div class="paragraph data-line-670">
<p>Conforme mencionado anteriormente, as assinaturas são criadas por uma função matemática <em>F</em><sub><em>sig</em></sub> que produz uma assinatura composta de dois valores, o valor <em>R</em> e o valor <em>S</em>. Nesta seção, veremos a função <em>F</em><sub><em>sig</em></sub> em maiores detalhes.</p>
</div>
<div class="paragraph data-line-672">
<p>O algoritmo de assinatura primeiro gera um par de chaves públicas privadas <em>efêmeras</em> (temporárias). Este par de chaves temporárias é usado no cálculo dos valores <em>R</em> e <em>S</em>, após uma transformação envolvendo a chave privada de assinatura e o hash da transação.</p>
</div>
<div class="paragraph data-line-674">
<p>O par de chaves temporárias é baseado em um número aleatório <em>k</em>, que é usado como a chave privada temporária. A partir do <em>k</em>, geramos a chave pública temporária correspondente <em>P</em> (calculada como <em>P = k*G</em>, da mesma forma que as chaves públicas do bitcoin são derivadas; ver <a href="#pubkey">[pubkey]</a>). O valor <em>R</em> da assinatura digital é então a coordenada x da chave pública efêmera <em>P</em>.</p>
</div>
<div class="paragraph data-line-676">
<p>A partir daí, o algoritmo calcula o valor <em>S</em> da assinatura, de modo que:</p>
</div>
<div class="paragraph data-line-678">
<p><em>S</em> = <em>k</em><sup>-1</sup> (<em>Hash</em>(<em>m</em>) + <em>dA</em> * <em>R</em>) <em>mod n</em></p>
</div>
<div class="paragraph data-line-680">
<p>onde:</p>
</div>
<div class="ulist data-line-682">
<ul>
<li class="data-line-682">
<p><em>k</em> é a chave privada efêmera</p>
</li>
<li class="data-line-683">
<p><em>R</em> é a coordenada x da chave pública efêmera</p>
</li>
<li class="data-line-684">
<p><em>dA</em> é a chave privada que assina</p>
</li>
<li class="data-line-685">
<p><em>m</em> são os dados da transação</p>
</li>
<li class="data-line-686">
<p><em>n</em> é a ordem prima da curva elíptica</p>
</li>
</ul>
</div>
<div class="paragraph data-line-688">
<p>A verificação é o inverso da função de geração de assinatura, usando os valores <em>R</em>, <em>S</em> e a chave pública para calcular um valor <em>P</em>, que é um ponto na curva elíptica (a chave pública efêmera usada na criação da assinatura):</p>
</div>
<div class="paragraph data-line-690">
<p><em>P</em> = <em>S</em><sup>-1</sup> * <em>Hash</em>(<em>m</em>) * <em>G</em> + <em>S</em><sup>-1</sup> * <em>R</em> * <em>Qa</em></p>
</div>
<div class="paragraph data-line-692">
<p>onde:</p>
</div>
<div class="ulist data-line-694">
<ul>
<li class="data-line-694">
<p><em>R</em> e <em>S</em> são os valores da assinatura</p>
</li>
<li class="data-line-695">
<p><em>Qa</em> é a chave pública da Alice</p>
</li>
<li class="data-line-696">
<p><em>m</em> são os dados da transação que foram assinados</p>
</li>
<li class="data-line-697">
<p><em>G</em> é o ponto gerador da curva elíptica</p>
</li>
</ul>
</div>
<div class="paragraph data-line-699">
<p>Se a coordenada x do ponto calculado <em>P</em> for igual a <em>R</em>, então o verificador pode concluir que a assinatura é válida.</p>
</div>
<div class="paragraph data-line-701">
<p>Observe que, ao verificar a assinatura, a chave privada não é conhecida nem revelada.</p>
</div>
<div class="admonitionblock tip data-line-704">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-705">
<p>ECDSA é necessariamente uma peça matemática bastante complicada; uma explicação completa vai além do escopo deste livro. Existe uma série de ótimos guias na internet que podem o conduzir no passo a passo: pesquise por "ECDSA explicado" ou acesse este link: <a href="https://bit.ly/2r0HhGB" class="undefined" data-href="https://bit.ly/2r0HhGB">https://bit.ly/2r0HhGB</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3 data-line-708">
<h4 id="_a_importância_da_aleatoriedade_nas_assinaturas">A Importância da Aleatoriedade nas Assinaturas</h4>
<div class="paragraph data-line-710">
<p>Conforme vimos em <a href="#ecdsa_math">Matemática do ECDSA</a>, o algoritmo de geração de assinatura usa uma chave aleatória <em>k</em>, que serve como a base para a geração de um par de chaves pública/privada efêmeras. O valor de <em>k</em> não é importante, <em>contanto que seja aleatório</em>. Se o mesmo valor <em>k</em> for usado para produzir duas assinaturas em diferentes mensagens (transações), a <em>chave privada</em> de assinatura poderá ser calculada por qualquer pessoa. Ou seja, a reutilização de um mesmo valor para <em>k</em> em um algoritmo de assinatura leva à exposição da chave privada!</p>
</div>
<div class="admonitionblock warning data-line-713">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph data-line-714">
<p>Se o mesmo valor <em>k</em> for usado no algoritmo de assinatura em duas transações diferentes, a chave privada poderá ser calculada e ser exposta por qualquer pessoa!</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-717">
<p>Esta não é apenas uma possibilidade teórica. Vimos esse problema levar à exposição de chaves privadas em algumas implementações diferentes de algoritmos de assinatura de transação no bitcoin. Algumas pessoas tiveram fundos roubados devido à reutilização inadvertida de um valor <em>k</em>. O motivo mais comum para a reutilização de um valor <em>k</em> é um gerador de número aleatório inicializado incorretamente.</p>
</div>
<div class="paragraph data-line-719">
<p>Para evitar essa vulnerabilidade, a prática recomendada pela indústria é não gerar <em>k</em> com um gerador de número aleatório semeado com entropia, mas, em vez disso, usar um processo determinístico-aleatório semeado com os dados da próprio transação. Isso garante que cada transação produza um <em>k</em> diferente. O algoritmo padrão da indústria para inicialização determinística de <em>k</em> é definido em <a href="https://tools.ietf.org/html/rfc6979" data-href="https://tools.ietf.org/html/rfc6979">RFC 6979</a>, publicado pela <em>Internet Engineering Task Force</em>.</p>
</div>
<div class="paragraph data-line-721">
<p>Se você estiver implementando um algoritmo para assinar transações no bitcoin, você <em>deve</em> usar o RFC 6979 ou um algoritmo determinístico-aleatório semelhante para garantir a geração de um <em>k</em> diferente para cada transação.</p>
</div>
</div>
</div>
<div class="sect2 data-line-723">
<h3 id="_endereços_saldos_e_outras_abstrações_do_bitcoin">Endereços, Saldos e Outras Abstrações do Bitcoin</h3>
<div class="paragraph data-line-725">
<p>We began this chapter with the discovery that transactions look very different "behind the scenes" than how they are presented in wallets, blockchain explorers, and other user-facing applications. Many of the simplistic and familiar concepts from the earlier chapters, such as Bitcoin addresses and balances, seem to be absent from the transaction structure. We saw that transactions don&#8217;t contain Bitcoin addresses, per se, but instead operate through scripts that lock and unlock discrete values of bitcoin. Balances are not present anywhere in this system and yet every wallet application prominently displays the balance of the user&#8217;s wallet.</p>
</div>
<div class="paragraph data-line-727">
<p>Agora que exploramos o que realmente está incluído em uma transação de bitcoin, podemos examinar como as abstrações de nível superior são derivadas dos componentes aparentemente primitivos da transação.</p>
</div>
<div class="paragraph data-line-729">
<p>Vejamos novamente como a transação da Alice foi apresentada em um explorador de blocos popular (<a href="#alice_transaction_to_bobs_cafe">Transação da Alice para a Cafeteria do Bob</a>).</p>
</div>
<div id="alice_transaction_to_bobs_cafe" class="imageblock data-line-733">
<div class="content">
<img src="images/mbc2_0208.png" alt="Alice Coffee Transaction">
</div>
<div class="title">Figure 9. Transação da Alice para a Cafeteria do Bob</div>
</div>
<div class="paragraph data-line-735">
<p>On the left side of the transaction, the blockchain explorer shows Alice&#8217;s Bitcoin address as the "sender." In fact, this information is not in the transaction itself. When the blockchain explorer references the transaction it also references the previous transaction associated with the input and extracts the first output from that older transaction. Within that output is a locking script that locks the UTXO to Alice&#8217;s public key hash (a P2PKH script). The blockchain explorer extracted the public key hash and encoded it using Base58Check encoding to produce and display the Bitcoin address that represents that public key.</p>
</div>
<div class="paragraph data-line-737">
<p>Similarly, on the right side, the blockchain explorer shows the two outputs; the first to Bob&#8217;s Bitcoin address and the second to Alice&#8217;s Bitcoin address (as change). Once again, to create these Bitcoin addresses, the blockchain explorer extracted the locking script from each output, recognized it as a P2PKH script, and extracted the public-key-hash from within. Finally, the blockchain explorer reencoded each public key hash with Base58Check to produce and display the Bitcoin addresses.</p>
</div>
<div class="paragraph data-line-739">
<p>If you were to click on Bob&#8217;s Bitcoin address, the blockchain explorer would show you the view in <a href="#the_balance_of_bobs_bitcoin_address">The balance of Bob&#8217;s Bitcoin address</a>.</p>
</div>
<div id="the_balance_of_bobs_bitcoin_address" class="imageblock data-line-743">
<div class="content">
<img src="images/mbc2_0608.png" alt="The balance of Bob&#8217;s Bitcoin address">
</div>
<div class="title">Figure 10. The balance of Bob&#8217;s Bitcoin address</div>
</div>
<div class="paragraph data-line-745">
<p>The blockchain explorer displays the balance of Bob&#8217;s Bitcoin address. But nowhere in the Bitcoin system is there a concept of a "balance." Rather, the values displayed here are constructed by the blockchain explorer as follows.</p>
</div>
<div class="paragraph data-line-747">
<p>To construct the "Total Received" amount, the blockchain explorer first will decode the Base58Check encoding of the Bitcoin address to retrieve the 160-bit hash of Bob&#8217;s public key that is encoded within the address. Then, the blockchain explorer will search through the database of transactions, looking for outputs with P2PKH locking scripts that contain Bob&#8217;s public key hash. By summing up the value of all the outputs, the blockchain explorer can produce the total value received.</p>
</div>
<div class="paragraph data-line-749">
<p>Constructing the current balance (displayed as "Final Balance") requires a bit more work. The blockchain explorer keeps a separate database of the outputs that are currently unspent, the UTXO set. To maintain this database, the blockchain explorer must monitor the Bitcoin network, add newly created UTXO, and remove spent UTXO, in real time, as they appear in unconfirmed transactions. This is a complicated process that depends on keeping track of transactions as they propagate, as well as maintaining consensus with the Bitcoin network to ensure that the correct chain is followed. Sometimes, the blockchain explorer goes out of sync and its perspective of the UTXO set is incomplete or incorrect.</p>
</div>
<div class="paragraph data-line-751">
<p>A partir do conjunto UTXO, o explorador de blockchain soma o valor de todas as saídas não gastas que fazem referência ao hash da chave pública do Bob e produz o valor do "Saldo Final" que é exibido ao usuário.</p>
</div>
<div class="paragraph data-line-753">
<p>Para produzir apenas essa tela, contendo esses dois "saldos", o explorador de blockchain precisa indexar e pesquisar dezenas, centenas ou mesmo centenas de milhares de transações.</p>
</div>
<div class="paragraph data-line-755">
<p>Em resumo, as informações apresentadas aos usuários por meio de aplicativos de carteira, exploradores de blockchain e outras interfaces de usuário do bitcoin são frequentemente compostas de abstrações de nível superior que são derivadas ao se pesquisar muitas transações diferentes, ao se inspecionar seu conteúdo e ao  se manipular os dados contidos nelas. Ao apresentar essa visão simplista das transações de bitcoin, que se assemelham a cheques bancários de um remetente para um destinatário, esses aplicativos precisam abstrair muitos detalhes subjacentes. Eles se concentram principalmente nos tipos comuns de transações: P2PKH com assinaturas SIGHASH_ALL em todas as entradas. Portanto, embora os aplicativos de bitcoin possam apresentar mais de 80% de todas as transações em uma maneira fácil de ler, às vezes eles ficam perdidos quando se deparam com transações que fogem do normal. As transações que contêm scripts de travamento mais complexos, sinalizadores SIGHASH diferentes ou muitas entradas e saídas, acabam demonstrando a simplicidade e a fraqueza dessas abstrações.</p>
</div>
<div class="paragraph data-line-757">
<p>Todos os dias, centenas de transações que não contêm saídas P2PKH são confirmadas na blockchain. Os exploradores de blockchain frequentemente apresentam mensagens de advertência em vermelho dizendo que eles não conseguem decodificar um endereço.</p>
</div>
<div class="paragraph data-line-759">
<p>Como veremos no próximo capítulo, essas transações não são necessariamente estranhas. São transações que contêm scripts de travamento mais complexos do que o P2PKH comum. A seguir, aprenderemos a decodificar e compreender scripts mais complexos e as aplicações que eles suportam.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-07-10 05:52:37 -0400
</div>
</div>
</body>
</html>