<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<title>Transações e Scripts Avançados</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article data-line-1">
<div id="header">
</div>
<div id="content">
<div class="sect1 data-line-3">
<h2 id="adv_transactions">Transações e Scripts Avançados</h2>
<div class="sectionbody">
<div class="sect2 data-line-6">
<h3 id="ch07_intro">Introdução</h3>
<div class="paragraph data-line-8">
<p>No capítulo anterior, apresentamos os elementos básicos das transações de bitcoin e vimos o tipo mais comum de script de transação, o script P2PKH. Neste capítulo, veremos scripts mais avançados e como podemos usá-los para construir transações com condições complexas.</p>
</div>
<div class="paragraph data-line-10">
<p>Primeiro, veremos os scripts <em>multiassinatura</em>. A seguir, examinaremos o segundo script de transação mais comum, o <em>Pay-to-Script-Hash</em> (em português, <em>Paga-para-Hash-de-Script</em>), que abre um novo mundo de scripts complexos. Em seguida, examinaremos novos operadores de script que adicionam uma dimensão de tempo ao bitcoin, por meio de <em>timelocks</em>. Por último, veremos a <em>Segregated Witness</em> (em português, <em>Testemunha Segregada</em>), uma mudança arquitetural na estrutura das transações.</p>
</div>
</div>
<div class="sect2 data-line-13">
<h3 id="multisig">Multiassinatura</h3>
<div class="paragraph data-line-15">
<p>Os scripts multiassinatura definem uma condição onde N chaves públicas são registradas no script e pelo menos M delas devem fornecer assinaturas para destravar os fundos. Isso também é conhecido como um esquema M-de-N, onde N é o número total de chaves e M é a quantidade mínima de assinaturas necessárias para validação. Por exemplo, uma multiassinatura 2-de-3 é aquela em que três chaves públicas são listadas como signatárias em potencial e pelo menos duas delas devem ser usadas para criar assinaturas para uma transação válida gastar os fundos.</p>
</div>
<div class="paragraph data-line-17">
<p>Atualmente, os scripts multiassinatura <em>padrão</em> são limitados a no máximo 3 chaves públicas listadas, o que significa que você pode fazer qualquer combinação partindo de 1-de-1 até 3-de-3 ou qualquer combinação dentro desse intervalo. A limitação de 3 chaves listadas pode já ter sido removida no momento em que este livro for publicado, portanto, verifique a função IsStandard() para ver o que é aceito atualmente pela rede. Observe que o limite de 3 chaves se aplica apenas a scripts multiassinatura padrão (também conhecidos como "<em>bare multisig</em>"), e não a scripts multiassinatura embrulhados em um script Pay-to-Script-Hash (P2SH). Os scripts multiassinatura P2SH são limitados a 15 chaves, permitindo multiassinaturas de até 15-de-15. Essa limitação é também imposta pela função IsStandard(). Aprenderemos sobre o P2SH em <a href="#p2sh">Pay-to-Script-Hash (P2SH)</a>.</p>
</div>
<div class="paragraph data-line-19">
<p>A forma geral usada por um script de travamento para definir uma condição multiassinatura M-de-N é</p>
</div>
<div class="listingblock data-line-21">
<div class="content">
<pre>M &lt;Chave Pública 1&gt; &lt;Chave Pública 2&gt; ... &lt;Chave Pública N&gt; N CHECKMULTISIG</pre>
</div>
</div>
<div class="paragraph data-line-25">
<p>onde N é o número total de chaves públicas listadas e M é a quantidade mínima de assinaturas necessárias para se gastar a saída.</p>
</div>
<div class="paragraph data-line-27">
<p>Um script de travamento definindo uma condição multiassinatura 2-de-3 fica dessa forma:</p>
</div>
<div class="listingblock data-line-29">
<div class="content">
<pre>2 &lt;Chave Pública A&gt; &lt;Chave Pública B&gt; &lt;Chave Pública C&gt; 3 CHECKMULTISIG</pre>
</div>
</div>
<div class="paragraph data-line-33">
<p>O script de travamento acima pode ser satisfeito com um script de destravamento contendo qualquer combinação de duas assinaturas obtidas a partir das chaves privadas que correspondem às três chaves públicas listadas:</p>
</div>
<div class="listingblock data-line-35">
<div class="content">
<pre>&lt;Assinatura B&gt; &lt;Assinatura C&gt;</pre>
</div>
</div>
<div class="paragraph data-line-39">
<p>Os dois scripts juntos formariam o seguinte script de validação combinado:</p>
</div>
<div class="listingblock data-line-41">
<div class="content">
<pre>&lt;Assinatura B&gt; &lt;Assinatura C&gt; 2 &lt;Chave Pública A&gt; &lt;Chave Pública B&gt; &lt;Chave Pública C&gt; 3 CHECKMULTISIG</pre>
</div>
</div>
<div class="paragraph data-line-45">
<p>Quando executado, o script combinado será avaliado como TRUE se, e somente se, o script de destravamento coincidir com as condições definidas pelo script de travamento. Neste caso, a condição é se o script de destravamento tem uma assinatura válida obtida a partir das duas chaves privadas que correspondem a duas das três chaves públicas definidas como uma trava.</p>
</div>
<div class="sect4 data-line-48">
<h5 id="multisig_bug">Um bug na execução do CHECKMULTISIG</h5>
<div class="paragraph data-line-50">
<p>Existe um bug na execução do CHECKMULTISIG que requer uma pequena solução alternativa. Quando o CHECKMULTISIG é executado, ele deveria consumir M+N+2 itens na pilha como parâmetros. No entanto, devido ao bug, o CHECKMULTISIG removerá um valor a mais do que o esperado.</p>
</div>
<div class="paragraph data-line-52">
<p>Vamos examinar isso em mais detalhes usando o exemplo de validação anterior:</p>
</div>
<div class="listingblock data-line-54">
<div class="content">
<pre>&lt;Assinatura B&gt; &lt;Assinatura C&gt; 2 &lt;Chave Pública A&gt; &lt;Chave Pública B&gt; &lt;Chave Pública C&gt; 3 CHECKMULTISIG</pre>
</div>
</div>
<div class="paragraph data-line-58">
<p>Primeiro, o CHECKMULTISIG remove o item do topo da pilha, que é o N (neste exemplo "3"). Em seguida, ele remove N itens, que são as chaves públicas que podem assinar. Neste exemplo, as chaves públicas A, B e C. Em seguida, ele remove um item da pilha, que é o M, o quórum (quantas assinaturas são necessárias). Aqui, M = 2. Neste ponto, o CHECKMULTISIG deve remover da pilha os M itens finais, que são as assinaturas, e ver se elas são válidas. No entanto, infelizmente, um bug na implementação faz com que o CHECKMULTISIG remova um item a mais do que deveria (M+1 no total). O item extra é desconsiderado na verificação das assinaturas, então ele não tem efeito direto no CHECKMULTISIG em si. No entanto, um valor extra deve estar presente, pois se ele não estiver presente, quando o CHECKMULTISIG tentar remover um item em uma pilha vazia, isso causará um erro de pilha e uma falha de script (marcando a transação como inválida). Como o item extra é desconsiderado, ele pode ser qualquer coisa, mas normalmente o valor 0 é usado.</p>
</div>
<div class="paragraph data-line-60">
<p>Como esse bug tornou-se parte das regras de consenso, agora ele precisa ser replicado para sempre. Portanto, a validação de script correta seria assim:</p>
</div>
<div class="listingblock data-line-62">
<div class="content">
<pre>0 &lt;Assinatura B&gt; &lt;Assinatura C&gt; 2 &lt;Chave Pública A&gt; &lt;Chave Pública B&gt; &lt;Chave Pública C&gt; 3 CHECKMULTISIG</pre>
</div>
</div>
<div class="paragraph data-line-66">
<p>Portanto, o script de destravamento que é de fato usado na multiassinatura não é:</p>
</div>
<div class="listingblock data-line-68">
<div class="content">
<pre>&lt;Assinatura B&gt; &lt;Assinatura C&gt;</pre>
</div>
</div>
<div class="paragraph data-line-72">
<p>mas, em vez disso, é:</p>
</div>
<div class="listingblock data-line-74">
<div class="content">
<pre>0 &lt;Assinatura B&gt; &lt;Assinatura C&gt;</pre>
</div>
</div>
<div class="paragraph data-line-78">
<p>De agora em diante, sempre que você se deparar com um script de destravamento multiassinatura, você já saberá para que serve o 0 extra no início do script, cujo único propósito é contornar um bug que acidentalmente se tornou uma regra de consenso.</p>
</div>
</div>
</div>
<div class="sect2 data-line-81">
<h3 id="p2sh">Pay-to-Script-Hash (P2SH)</h3>
<div class="paragraph data-line-83">
<p>O <em>Pay-to-Script-Hash</em> (em português, Paga-para-Hash-de-Script) ou P2SH foi introduzido em 2012 como um novo tipo poderoso de transação que simplifica muito o uso de scripts de transação complexos. Para explicar a necessidade do P2SH, vamos dar uma olhada em um exemplo prático.</p>
</div>
<div class="paragraph data-line-85">
<p>No <a href="#ch01_intro_what_is_bitcoin">[ch01_intro_what_is_bitcoin]</a> apresentamos o Mohammed, um importador de eletrônicos que mora em Dubai. A empresa do Mohammed usa extensivamente o recurso de multiassinatura do bitcoin para suas contas corporativas. Os scripts multiassinatura são um dos usos mais comuns das capacidades avançadas de script do bitcoin e são um recurso muito poderoso.  A empresa do Mohammed usa um script multiassinatura para todos os pagamentos de clientes, algo que é conhecido em termos contábeis como "contas a receber" (em inglês <em>"accounts receivable"</em> ou AR). Com o esquema multiassinatura, todos os pagamentos feitos pelos clientes são travados de forma que eles exijam pelo menos duas assinaturas para serem liberados, uma do Mohammed e uma de seus sócios ou uma de seu advogado que possui uma chave reserva. Um esquema multiassinatura como esse oferece controles de governança corporativa e protege contra roubo, apropriação indébita ou perda.</p>
</div>
<div class="paragraph data-line-87">
<p>O script resultante é bastante longo e tem a seguinte forma:</p>
</div>
<div class="listingblock data-line-89">
<div class="content">
<pre>2 &lt;Chave Pública do Mohammed&gt; &lt;Chave Pública do Sócio1&gt; &lt;Chave Pública do Sócio2&gt; &lt;Chave Pública do Sócio3&gt; &lt;Chave Pública do Advogado&gt; 5 CHECKMULTISIG</pre>
</div>
</div>
<div class="paragraph data-line-93">
<p>Embora os scripts multiassinatura sejam um recurso poderoso, eles são complicados de usar. Dado o script anterior, o Mohammed teria que comunicar esse script a todos os clientes antes do pagamento. Cada cliente teria que usar um software de carteira de bitcoin especial, com a capacidade de criar scripts de transação personalizados, e cada cliente teria que entender como criar uma transação usando scripts personalizados. Além disso, a transação resultante seria cerca de cinco vezes maior do que uma transação de pagamento simples, pois esse script contém chaves públicas muito longas. O ônus dessa transação extra-grande seria arcado pelo cliente na forma de taxas de transação mais elevadas. Finalmente, um script de transação grande como este seria carregado no conjunto UTXO contido na memória RAM de cada nó completo, até que ele fosse gasto. Todos esses problemas tornam o uso de scripts de travamento complexos difícil na prática.</p>
</div>
<div class="paragraph data-line-95">
<p>P2SH was developed to resolve these practical difficulties and to make the use of complex scripts as easy as a payment to a Bitcoin address. With P2SH payments, the complex locking script is replaced with its digital fingerprint, a cryptographic hash. When a transaction attempting to spend the UTXO is presented later, it must contain the script that matches the hash, in addition to the unlocking script. In simple terms, P2SH means "pay to a script matching this hash, a script that will be presented later when this output is spent."</p>
</div>
<div class="paragraph data-line-97">
<p>Nas transações P2SH, o script de travamento que é substituído por um hash é referido como o <em>script de resgate</em> (em inglês, <em>redeem script</em>), pois ele é apresentado ao sistema no momento do resgate, ao invés de ser apresentado como um script de travamento. A <a href="#without_p2sh">Script complexo sem P2SH</a> mostra o script sem P2SH e a <a href="#with_p2sh">Script complexo com P2SH</a> mostra o mesmo script codificado com P2SH.</p>
</div>
<table id="without_p2sh" class="tableblock frame-all grid-all stretch data-line-101">
<caption class="title">Table 1. Script complexo sem P2SH</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Script de Travamento</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2 ChavePública1 ChavePública2 ChavePública3 ChavePública4 ChavePública5 5 CHECKMULTISIG</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Script de Destravamento</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0 Assinatura1 Assinatura2</p></td>
</tr>
</tbody>
</table>
<table id="with_p2sh" class="tableblock frame-all grid-all stretch data-line-108">
<caption class="title">Table 2. Script complexo com P2SH</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Script de Resgate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2 ChavePública1 ChavePública2 ChavePública3 ChavePública4 ChavePública5 5 CHECKMULTISIG</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Script de Travamento</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HASH160 &lt;hash de 20 bytes do script de resgate&gt; EQUAL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Script de Destravamento</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0 Assinatura1 Assinatura2 &lt;script de resgate&gt;</p></td>
</tr>
</tbody>
</table>
<div class="paragraph data-line-114">
<p>Como você pode ver nas tabelas, com P2SH, o complexo script que detalha as condições para gastar a saída (o script de resgate) não é apresentado no script de travamento. Em vez disso, somente um hash do script de resgate é adicionado no script de travamento e o script de resgate em si é apresentado mais tarde, como parte do script de destravamento quando a saída for gasta. Isso transfere o fardo das taxas e da complexidade do remetente (quem cria a transação) para o destinatário (quem destrava e gasta a transação).</p>
</div>
<div class="paragraph data-line-116">
<p>Vamos dar uma olhada na empresa do Mohammed, o script multiassinatura complexo e os scripts P2SH resultantes.</p>
</div>
<div class="paragraph data-line-118">
<p>Primeiro, o script multiassinatura que a empresa do Mohammed usa para todos os pagamentos que recebe de seus clientes:</p>
</div>
<div class="listingblock data-line-120">
<div class="content">
<pre>2 &lt;Chave Pública do Mohammed&gt; &lt;Chave Pública do Sócio1&gt; &lt;Chave Pública do Sócio2&gt; &lt;Chave Pública do Sócio3&gt; &lt;Chave Pública do Advogado&gt; 5 CHECKMULTISIG</pre>
</div>
</div>
<div class="paragraph data-line-124">
<p>Se os marcadores forem substituídos pelas verdadeiras chaves públicas (demonstradas aqui como números de 520 bits começando com 04), você verá que esse script se torna muito longo:</p>
</div>
<div class="listingblock data-line-126">
<div class="content">
<pre>2
04C16B8698A9ABF84250A7C3EA7EEDEF9897D1C8C6ADF47F06CF73370D74DCCA01CDCA79DCC5C395D7EEC6984D83F1F50C900A24DD47F569FD4193AF5DE762C58704A2192968D8655D6A935BEAF2CA23E3FB87A3495E7AF308EDF08DAC3C1FCBFC2C75B4B0F4D0B1B70CD2423657738C0C2B1D5CE65C97D78D0E34224858008E8B49047E63248B75DB7379BE9CDA8CE5751D16485F431E46117B9D0C1837C9D5737812F393DA7D4420D7E1A9162F0279CFC10F1E8E8F3020DECDBC3C0DD389D99779650421D65CBD7149B255382ED7F78E946580657EE6FDA162A187543A9D85BAAA93A4AB3A8F044DADA618D087227440645ABE8A35DA8C5B73997AD343BE5C2AFD94A5043752580AFA1ECED3C68D446BCAB69AC0BA7DF50D56231BE0AABF1FDEEC78A6A45E394BA29A1EDF518C022DD618DA774D207D137AAB59E0B000EB7ED238F4D800 5 CHECKMULTISIG</pre>
</div>
</div>
<div class="paragraph data-line-131">
<p>Em vez disso, esse script inteiro pode ser representado por um hash criptográfico de 20 bytes, aplicando-se primeiro o algoritmo de hash SHA256 e, em seguida, aplicando-se o algoritmo RIPEMD160 no resultado.</p>
</div>
<div class="paragraph data-line-133">
<p>Usamos o libbitcoin-explorer (bx) na linha de comando para produzir o hash do script, da seguinte maneira:</p>
</div>
<div class="listingblock data-line-135">
<div class="content">
<pre>echo \
2 \
[04C16B8698A9ABF84250A7C3EA7EEDEF9897D1C8C6ADF47F06CF73370D74DCCA01CDCA79DCC5C395D7EEC6984D83F1F50C900A24DD47F569FD4193AF5DE762C587] \
[04A2192968D8655D6A935BEAF2CA23E3FB87A3495E7AF308EDF08DAC3C1FCBFC2C75B4B0F4D0B1B70CD2423657738C0C2B1D5CE65C97D78D0E34224858008E8B49] \
[047E63248B75DB7379BE9CDA8CE5751D16485F431E46117B9D0C1837C9D5737812F393DA7D4420D7E1A9162F0279CFC10F1E8E8F3020DECDBC3C0DD389D9977965] \
[0421D65CBD7149B255382ED7F78E946580657EE6FDA162A187543A9D85BAAA93A4AB3A8F044DADA618D087227440645ABE8A35DA8C5B73997AD343BE5C2AFD94A5] \
[043752580AFA1ECED3C68D446BCAB69AC0BA7DF50D56231BE0AABF1FDEEC78A6A45E394BA29A1EDF518C022DD618DA774D207D137AAB59E0B000EB7ED238F4D800] \
5 CHECKMULTISIG \
| bx script-encode | bx sha256 | bx ripemd160
54c557e07dde5bb6cb791c7a540e0a4796f5e97e</pre>
</div>
</div>
<div class="paragraph data-line-148">
<p>A série de comandos acima codifica primeiro o script de resgate multiassinatura do Mohammed como um Script do bitcoin codificado em hexadecimal e serializado. O próximo comando bx calcula o hash SHA256 do script. O próximo comando bx faz outro <em>hashing</em> com o RIPEMD160, produzindo o hash do script final:</p>
</div>
<div class="paragraph data-line-150">
<p>O hash de 20 bytes do script de resgate do Mohammed é:</p>
</div>
<div class="listingblock data-line-152">
<div class="content">
<pre>54c557e07dde5bb6cb791c7a540e0a4796f5e97e</pre>
</div>
</div>
<div class="paragraph data-line-156">
<p>Uma transação P2SH trava a saída para este hash, em vez do script de resgate mais longo, usando o script de travamento:</p>
</div>
<div class="listingblock data-line-158">
<div class="content">
<pre>HASH160 54c557e07dde5bb6cb791c7a540e0a4796f5e97e EQUAL</pre>
</div>
</div>
<div class="paragraph data-line-162">
<p>o qual, como você pode ver, é muito mais curto. Em vez de "pagar para este script multiassinatura de 5 chaves", a transação P2SH equivalente é "pagar para um script com este hash". Um cliente que faz um pagamento para a empresa do Mohammed só precisa incluir esse script de travamento muito mais curto em seu pagamento. Quando o Mohammed e seus sócios desejarem gastar esta UTXO, eles deverão apresentar o script de resgate original (aquele cujo hash travou a UTXO) e as assinaturas necessárias para destravá-lo, dessa maneira:</p>
</div>
<div class="listingblock data-line-164">
<div class="content">
<pre>&lt;Assinatura1&gt; &lt;Assinatura2&gt; &lt;2 CP1 CP2 CP3 CP4 CP5 5 CHECKMULTISIG&gt;</pre>
</div>
</div>
<div class="paragraph data-line-168">
<p>Os dois scripts são combinados em dois estágios. Primeiro, o script de resgate é verificado em relação ao script de travamento para garantir que o hash corresponda:</p>
</div>
<div class="listingblock data-line-170">
<div class="content">
<pre>&lt;2 CP1 CP2 CP3 CP4 CP5 5 CHECKMULTISIG&gt; HASH160 &lt;hash do script de resgate&gt; EQUAL</pre>
</div>
</div>
<div class="paragraph data-line-173">
<p>Se o hash do script de resgate corresponder, o script de destravamento será executado isoladamente, para destravar o script de resgate:</p>
</div>
<div class="listingblock data-line-175">
<div class="content">
<pre>&lt;Assinatura1&gt; &lt;Assinatura2&gt; 2 CP1 CP2 CP3 CP4 CP5 5 CHECKMULTISIG</pre>
</div>
</div>
<div class="paragraph data-line-179">
<p>Quase todos os scripts descritos neste capítulo só podem ser implementados como scripts P2SH. Por exemplo, um script de travamento multiassinatura padrão 2 de 5 não pode ser usado diretamente no script de travamento de uma UTXO, pois a função IsStandard() invalidaria a transação. Para estar em conformidade, um script de travamento P2SH pode ser usado em seu lugar, como visto acima. Uma transação que inclui um script de destravamento P2SH pode ser usada para resgatar essa UTXO e será válida desde que não contenha mais do que 15 chaves públicas. </p>
</div>
<div class="admonitionblock tip data-line-182">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-183">
<p>Lembre-se, por causa da política definida pela função IsStandard() no momento da redação deste livro, os scripts multiassinatura padrão são limitados a no máximo 3 chaves públicas listadas, enquanto os scripts P2SH são limitados a no máximo 15 chaves públicas listadas. Enquanto os scripts multiassinatura padrão podem invalidar transações por meio de seu script de travamento <em>ou</em> destravamento, os scripts P2SH podem invalidar transações <em>apenas</em> por meio de seu script de destravamento. Isso ocorre porque não há como a função IsStandard() saber se um hash de um script de resgate em um script de travamento inclui mais assinaturas do que a limitação de tamanho atualmente imposta, portanto, ela só pode observar os scripts de destravamento nas entradas de transação.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3 data-line-186">
<h4 id="_endereços_p2sh">Endereços P2SH</h4>
<div class="paragraph data-line-188">
<p>Another important part of the P2SH feature is the ability to encode a script hash as an address, as defined in BIP-13. P2SH addresses are Base58Check encodings of the 20-byte hash of a script, just like Bitcoin addresses are Base58Check encodings of the 20-byte hash of a public key. P2SH addresses use the version prefix "5," which results in Base58Check-encoded addresses that start with a "3."</p>
</div>
<div class="paragraph data-line-190">
<p>Por exemplo, o script complexo do Mohammed, transformado em hash e codificado em Base58Check como um endereço P2SH, torna-se 39RF6JqABiHdYHkfChV6USGMe6Nsr66Gzw. Podemos confirmar isso com o comando bx:</p>
</div>
<div class="listingblock data-line-192">
<div class="content">
<pre>echo \
'54c557e07dde5bb6cb791c7a540e0a4796f5e97e'\
 | bx address-encode -v 5
39RF6JqABiHdYHkfChV6USGMe6Nsr66Gzw</pre>
</div>
</div>
<div class="paragraph data-line-200">
<p>Now, Mohammed can give this "address" to his customers and they can use almost any bitcoin wallet to make a simple payment, as if it were a Bitcoin address. The 3 prefix gives them a hint that this is a special type of address, one corresponding to a script instead of a public key, but otherwise it works in exactly the same way as a payment to a Bitcoin address.</p>
</div>
<div class="paragraph data-line-202">
<p>Os endereços P2SH escondem toda essa complexidade, de maneira que a pessoa que está fazendo o pagamento não enxergue o script.</p>
</div>
</div>
<div class="sect3 data-line-204">
<h4 id="_benefícios_do_p2sh">Benefícios do P2SH</h4>
<div class="paragraph data-line-206">
<p>O recurso P2SH oferece os seguintes benefícios em comparação com o uso direto de scripts complexos para o travamento de saídas:</p>
</div>
<div class="ulist data-line-208">
<ul>
<li class="data-line-208">
<p>Os scripts complexos são substituídos por impressões digitais menores na saída da transação, tornando a transação menor.</p>
</li>
<li class="data-line-209">
<p>Os scripts podem ser codificados como um endereço, de maneira que o remetente e a carteira do remetente não precisem fazer modificações complexas para implementar o P2SH.</p>
</li>
<li class="data-line-210">
<p>O P2SH faz com que o fardo de se construir o script seja do recipiente, e não do remetente.</p>
</li>
<li class="data-line-211">
<p>O P2SH transfere a obrigação de armazenar o script longo da saída (que, além de ser armazenada na blockchain, também está no conjunto UTXO) para a entrada (que é armazenada apenas na blockchain).</p>
</li>
<li class="data-line-212">
<p>O P2SH faz com que o fardo do armazenamento do script longo deixe de estar no presente (pagamento) e passe a estar no futuro (quando ele é gasto).</p>
</li>
<li class="data-line-213">
<p>O P2SH faz com que os maiores custos com taxa de transação de um script longo deixem de ser do remetente e passem a ser do recipiente (destinatário), que tem que incluir o script longo de resgate para poder gastá-lo.</p>
</li>
</ul>
</div>
</div>
<div class="sect3 data-line-215">
<h4 id="_script_de_resgate_e_validação">Script de Resgate e Validação</h4>
<div class="paragraph data-line-217">
<p>Antes da versão 0.9.2 do cliente Bitcoin Core, o Pay-to-Script-Hash era limitado aos tipos padrão de scripts de transação de bitcoin pela função IsStandard(). Isso significa que o script de resgate apresentado na transação de gasto só poderia ser um dos tipos padrão: P2PK, P2PKH ou multiassinatura.</p>
</div>
<div class="paragraph data-line-219">
<p>A partir da versão 0.9.2 do cliente Bitcoin Core, as transações P2SH podem conter qualquer script válido, tornando o padrão P2SH muito mais flexível e permitindo a experimentação de muitos tipos novos e complexos de transações.</p>
</div>
<div class="paragraph data-line-221">
<p>Você não pode colocar um P2SH dentro de um script de resgate P2SH, pois a especificação P2SH não é recursiva. Além disso, embora seja tecnicamente possível incluir um RETURN (ver <a href="#op_return">Saída de Registro de Dados (RETURN)</a>) em um script de resgate, já que nada nas regras impede que você faça isso, isso não tem uso prático, pois executar o RETURN durante a validação fará com que a transação seja marcada como inválida.</p>
</div>
<div class="paragraph data-line-223">
<p>Observe que, como o script de resgate não é apresentado à rede até que você tente gastar uma saída P2SH, se você travar uma saída com o hash de um script de resgate inválido, esse travamento será processado de qualquer forma. A UTXO será travada com sucesso. No entanto, você não poderá gastá-la porque a transação de gasto, que inclui o script de resgate, não será aceita, pois o script é inválido. Isso cria um risco, visto que você pode travar bitcoins em um P2SH que não poderá ser gasto posteriormente. A rede aceitará o script de travamento P2SH mesmo que ele corresponda a um script de resgate inválido, pois o hash do script não dá nenhuma indicação do script que ele representa.</p>
</div>
<div class="admonitionblock warning data-line-226">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph data-line-227">
<p>Os scripts de travamento P2SH contêm o hash de um script de resgate, que não fornece pistas quanto ao conteúdo do script de resgate em si. A transação P2SH será considerada válida e será aceita, mesmo que o script de resgate seja inválido. Você poderia travar acidentalmente os bitcoins, de modo que eles não possam mais ser gastos no futuro.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2 data-line-233">
<h3 id="op_return">Saída de Registro de Dados (RETURN)</h3>
<div class="paragraph data-line-235">
<p>A blockchain do bitcoin, o seu livro-razão distribuído com carimbos de data e hora, tem usos potenciais muito além dos pagamentos. Muitos desenvolvedores tentaram usar a linguagem de script de transação para aproveitar a segurança e a resiliência do sistema em aplicações como serviços de cartório digital, certificados de ações e contratos inteligentes. As primeiras tentativas de usar a linguagem de script do bitcoin para esses fins envolviam a criação de saídas de transação que registravam dados na blockchain; por exemplo, para registrar uma impressão digital de um arquivo, de tal forma que qualquer pessoa pudesse estabelecer a prova de existência desse arquivo em uma data específica através de uma referência àquela transação.</p>
</div>
<div class="paragraph data-line-237">
<p>The use of bitcoin&#8217;s blockchain to store data unrelated to bitcoin payments is a controversial subject. Many developers consider such use abusive and want to discourage it. Others view it as a demonstration of the powerful capabilities of blockchain technology and want to encourage such experimentation. Those who object to the inclusion of nonpayment data argue that it causes "blockchain bloat," burdening those running full Bitcoin nodes with carrying the cost of disk storage for data that the blockchain was not intended to carry. Moreover, such transactions create UTXO that cannot be spent, using the destination Bitcoin address as a freeform 20-byte field. Because the address is used for data, it doesn&#8217;t correspond to a private key and the resulting UTXO can <em>never</em> be spent; it&#8217;s a fake payment. These transactions that can never be spent are therefore never removed from the UTXO set and cause the size of the UTXO database to forever increase, or "bloat."</p>
</div>
<div class="paragraph data-line-239">
<p>Na versão 0.9 do cliente Bitcoin Core, os ânimos foram apaziguados com a introdução do operador RETURN. O RETURN permite que os desenvolvedores adicionem 80 bytes de dados não relacionados a pagamento a uma saída de transação. No entanto, ao contrário do uso de UTXOs "falsas", o operador RETURN explicitamente cria uma saída que é <em>comprovadamente não gastável</em>, a qual não precisa ser armazenada no conjunto UTXO. As saídas com RETURN são registradas na blockchain, portanto, consomem espaço em disco e contribuem para o aumento no tamanho da blockchain, mas elas não são armazenadas no conjunto UTXO e, portanto, não incham a pool de memória de UTXOs e diminuem os gastos que os nós completos tem em memória RAM, que é cara.</p>
</div>
<div class="paragraph data-line-241">
<p>Os scripts RETURN têm a seguinte forma:</p>
</div>
<div class="listingblock data-line-243">
<div class="content">
<pre>RETURN &lt;dados&gt;</pre>
</div>
</div>
<div class="paragraph data-line-247">
<p> A porção de dados é limitada a 80 bytes e na maioria das vezes representa um hash, como a saída do algoritmo SHA256 (32 bytes). Muitos aplicativos colocam um prefixo na frente dos dados para ajudar a identificar a aplicação. Por exemplo, o serviço de notas digitais de <a href="https://proofofexistence.com" data-href="https://proofofexistence.com">Prova de Existência</a> usa o prefixo de 8 bytes+DOCPROOF+, que é ASCII codificado como 44 4f 43 50 52 4f 4f 46 em hexadecimal.</p>
</div>
<div class="paragraph data-line-249">
<p>Lembre-se de que não existe um "script de destravamento" que corresponda ao RETURN que possa ser usado para "gastar" uma saída RETURN. O motivo principal pelo qual o RETURN foi criado, é para que você não possa gastar o dinheiro travado nessa saída e, portanto, para que ela não precise ser mantida no conjunto UTXO como potencialmente gastável—o RETURN é <em>comprovadamente impossível de ser gasto</em>. O RETURN geralmente é uma saída com uma quantidade zero de bitcoin, pois qualquer bitcoin atribuído a essa saída é efetivamente perdido para sempre. Se um RETURN for referenciado como uma entrada em uma transação, o mecanismo de validação de script suspenderá a execução do script de validação e marcará a transação como inválida. A execução do RETURN essencialmente faz com que o script "retorne" com um FALSE e suspenda a execução. Portanto, se você acidentalmente referenciar uma saída RETURN como uma entrada em uma transação, essa transação será inválida.</p>
</div>
<div class="paragraph data-line-251">
<p>Uma transação padrão (que esteja em conformidade com as verificações IsStandard()) só pode ter uma única saída RETURN. No entanto, uma saída RETURN única pode ser combinada em uma transação com saídas de qualquer outro tipo.</p>
</div>
<div class="paragraph data-line-253">
<p>Duas novas opções de linha de comando foram adicionadas ao Bitcoin Core a partir da versão 0.10. A opção datacarrier controla a retransmissão e a mineração de transações RETURN, com o padrão definido como "1" para permiti-las. A opção datacarriersize recebe um argumento numérico especificando o tamanho máximo em bytes do script RETURN, 83 bytes por padrão, o que permite um máximo de 80 bytes de dados RETURN mais um byte do código operacional RETURN e dois bytes do código operacional PUSHDATA.</p>
</div>
<div class="admonitionblock note data-line-256">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-257">
<p>O RETURN foi inicialmente proposto com um limite de 80 bytes, mas o limite foi reduzido para 40 bytes quando o recurso foi lançado. Em fevereiro de 2015, na versão 0.10 do Bitcoin Core, o limite foi novamente aumentado para 80 bytes. Os nós podem decidir não retransmitir ou minerar o RETURN, ou apenas retransmitir e minerar os RETURN que contenham menos de 80 bytes de dados.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2 data-line-260">
<h3 id="_timelocks">Timelocks</h3>
<div class="paragraph data-line-262">
<p>Os timelocks são restrições em transações ou saídas que só permitem o gasto após um determinado momento no tempo. O bitcoin tem desde o seu início um recurso de timelock a nível de transação. Ele é implementado pelo campo nLocktime em uma transação. Dois novos recursos de timelock foram introduzidos no final de 2015 e em meados de 2016, que oferecem timelocks a nível de UTXO. Eles são o CHECKLOCKTIMEVERIFY e o CHECKSEQUENCEVERIFY.</p>
</div>
<div class="paragraph data-line-264">
<p>Os timelocks são úteis para transações pré-datadas (com pagamento em data futura) e para travar fundos até uma data futura. Mais importante, os timelocks estendem o script do bitcoin para a dimensão do tempo, permitindo a criação de contratos inteligentes complexos de múltiplas etapas.</p>
</div>
<div class="sect3 data-line-267">
<h4 id="transaction_locktime_nlocktime">Locktime de Transação (nLocktime)</h4>
<div class="paragraph data-line-269">
<p>From the beginning, bitcoin has had a transaction-level timelock feature. Transaction locktime is a transaction-level setting (a field in the transaction data structure) that defines the earliest time that a transaction is valid and can be relayed on the network or added to the blockchain. Locktime is also known as nLocktime from the variable name used in the Bitcoin Core codebase. It is set to zero in most transactions to indicate immediate propagation and execution. If nLocktime is nonzero and below 500 million, it is interpreted as a block height, meaning the transaction is not valid and is not relayed or included in the blockchain prior to the specified block height. If it is greater than or equal to 500 million, it is interpreted as a Unix Epoch timestamp (seconds since Jan-1-1970) and the transaction is not valid prior to the specified time. Transactions with nLocktime specifying a future block or time must be held by the originating system and transmitted to the Bitcoin network only after they become valid. If a transaction is transmitted to the network before the specified nLocktime, the transaction will be rejected by the first node as invalid and will not be relayed to other nodes. The use of nLocktime is equivalent to postdating a paper check.</p>
</div>
<div class="sect4 data-line-272">
<h5 id="locktime_limitations">Limitações do locktime de transação</h5>
<div class="paragraph data-line-274">
<p>O nLocktime tem a limitação de que, embora ele torne possível gastar algumas saídas no futuro, ele não torna impossível gastá-las até aquele momento no futuro. Vamos explicar isso usando o exemplo a seguir.</p>
</div>
<div class="paragraph data-line-276">
<p>A Alice assina uma transação gastando uma de suas saídas para o endereço do Bob e define o nLocktime da transação para 3 meses no futuro. A seguir, a Alice envia essa transação para o Bob para retê-la. Com esta transação, a Alice e o Bob sabem que:</p>
</div>
<div class="ulist data-line-278">
<ul>
<li class="data-line-278">
<p>O Bob não conseguirá transmitir a transação para resgatar os fundos antes de decorridos 3 meses.</p>
</li>
<li class="data-line-279">
<p>O Bob conseguirá transmitir a transação após 3 meses.</p>
</li>
</ul>
</div>
<div class="paragraph data-line-281">
<p>Entretanto:</p>
</div>
<div class="ulist data-line-283">
<ul>
<li class="data-line-283">
<p>A Alice conseguirá criar outra transação, fazendo um gasto duplo das mesmas entradas sem um locktime. Portanto, a Alice conseguirá gastar a mesma UTXO antes de decorridos os 3 meses.</p>
</li>
<li class="data-line-284">
<p>Bob não tem garantia nenhuma de que a Alice não fará isso.</p>
</li>
</ul>
</div>
<div class="paragraph data-line-286">
<p>É importante entender as limitações do nLocktime da transação. A única garantia é a de que o Bob não conseguirá resgatar os fundos da transação antes de decorridos 3 meses. Não há garantia de que o Bob receberá os fundos. Para obter tal garantia, a restrição do timelock deve ser colocada na própria UTXO e fazer parte do script de travamento, em vez de ser colocada na transação. Isso é obtido pela próxima forma de timelock que veremos, que se chama Check Lock Time Verify.</p>
</div>
</div>
</div>
<div class="sect3 data-line-288">
<h4 id="_check_lock_time_verify_cltv">Check Lock Time Verify (CLTV)</h4>
<div class="paragraph data-line-290">
<p>Em dezembro de 2015, uma nova forma de timelock foi introduzida no bitcoin através de uma atualização de soft fork. Com base em uma especificação da BIP-65, um novo operador de script chamado <em>CHECKLOCKTIMEVERIFY</em> (<em>CLTV</em>) foi adicionado à linguagem de script. O CLTV é um timelock de saída, e não um timelock de transação, como é o caso do nLocktime. Isso permite uma flexibilidade muito maior na maneira como os timelocks são aplicados.</p>
</div>
<div class="paragraph data-line-292">
<p>Em termos simples, ao adicionar o código operacional CLTV no script de resgate de uma saída, ele restringe a saída, de modo que ela só possa ser gasta após o tempo especificado ter decorrido.</p>
</div>
<div class="admonitionblock tip data-line-295">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-296">
<p>Enquanto o nLocktime é um timelock a nível de transação, o CLTV é um timelock baseado na saída.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-299">
<p>O CLTV não substitui o nLocktime, mas restringe UTXOs específicas de forma que elas só possam ser gastas em uma transação futura que tenha um nLocktime definido com um valor maior ou igual ao CLTV.</p>
</div>
<div class="paragraph data-line-301">
<p>O código operacional CLTV aceita um parâmetro como entrada, expresso como um número no mesmo formato que o nLocktime (uma altura de bloco ou um carimbo de data/hora da época Unix). Conforme indicado pelo sufixo VERIFY, o CLTV é o tipo de código operacional que suspende a execução do script se o resultado for FALSE. Se o resultado for TRUE, a execução continua.</p>
</div>
<div class="paragraph data-line-303">
<p>Para travar uma saída com o CLTV, você deve inseri-lo script de resgate da saída, que fica na transação que cria a saída. Por exemplo, se a Alice estivesse pagando para o endereço do Bob, a saída normalmente conteria um script P2PKH como este:</p>
</div>
<div class="listingblock data-line-305">
<div class="content">
<pre>DUP HASH160 &lt;Hash da Chave Pública do Bob&gt; EQUALVERIFY CHECKSIG</pre>
</div>
</div>
<div class="paragraph data-line-309">
<p>Para travar a saída até um momento no futuro, digamos, daqui a três meses, seria usada uma transação P2SH com um script de resgate como este:</p>
</div>
<div class="listingblock data-line-311">
<div class="content">
<pre>&lt;agora + 3 meses&gt; CHECKLOCKTIMEVERIFY DROP DUP HASH160 &lt;Hash da Chave Pública do Bob&gt; EQUALVERIFY CHECKSIG</pre>
</div>
</div>
<div class="paragraph data-line-315">
<p>onde &lt;agora {plus} 3 meses&gt; é uma altura de bloco ou um valor de tempo estimado em 3 meses após a transação ter sido minerada: altura de bloco atual &#43; 12.960 (blocos) ou data/hora atual da época Unix &#43; 7.760.000 (segundos). Por enquanto, não se preocupe com o código operacional DROP que segue o CHECKLOCKTIMEVERIFY; ele será explicado em breve.</p>
</div>
<div class="paragraph data-line-317">
<p>When Bob tries to spend this UTXO, he constructs a transaction that references the UTXO as an input. He uses his signature and public key in the unlocking script of that input and sets the transaction nLocktime to be equal to or greater than the timelock in the CHECKLOCKTIMEVERIFY Alice set. Bob then broadcasts the transaction on the Bitcoin network.</p>
</div>
<div class="paragraph data-line-319">
<p>A transação do Bob é avaliada da seguinte maneira. Se o parâmetro CHECKLOCKTIMEVERIFY definido pela Alice for menor ou igual ao nLocktime da transação de gasto, a execução do script continua (age como se “nenhuma operação” ou um código operacional NOP tivesse sido executado). Caso contrário, a execução do script é suspensa e a transação é considerada inválida.</p>
</div>
<div class="paragraph data-line-321">
<p>Mais precisamente, o CHECKLOCKTIMEVERIFY falha e suspende a execução, marcando a transação como inválida se: (fonte: BIP-65)</p>
</div>
<div class="olist arabic data-line-323">
<ol class="arabic">
<li class="data-line-323">
<p>a pilha estiver vazia; ou</p>
</li>
<li class="data-line-324">
<p>o item no topo da pilha for menor que 0; ou</p>
</li>
<li class="data-line-325">
<p>o tipo de timelock (altura vs. carimo de data/hora) do item no topo da pilha e o campo nLocktime não forem os mesmos; ou</p>
</li>
<li class="data-line-326">
<p>o item no topo da pilha for maior que o campo nLocktime da transação; ou</p>
</li>
<li class="data-line-327">
<p>o campo nSequence da entrada é 0xffffffff.</p>
</li>
</ol>
</div>
<div class="admonitionblock note data-line-330">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-331">
<p>O CLTV e o nLocktime usam o mesmo formato para descrever os timelocks, seja uma altura de bloco ou um tempo decorrido em segundos desde a época do Unix. É importante frisar que, quando usados juntos, o formato do nLocktime deve corresponder ao formato do CLTV usado nas saídas&#x2014;ambos devem fazer referência ou à altura do bloco ou à data/hora em segundos.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-334">
<p>Após a execução, se o CLTV for satisfeito, o parâmetro de tempo que o precedeu permanece como o item superior da pilha e pode precisar ser eliminado, com o DROP, para a correta execução dos códigos operacionais subsequentes. Por esse motivo, você frequentemente verá o CHECKLOCKTIMEVERIFY seguido de DROP nos scripts.</p>
</div>
<div class="paragraph data-line-336">
<p>Ao usar o nLocktime em conjunto com o CLTV, o cenário descrito em <a href="#locktime_limitations">Limitações do locktime de transação</a> muda. A Alice não consegue mais gastar o dinheiro (pois ele está travado com a chave do Bob) e o Bob não consegue gastá-lo antes que o locktime de 3 meses tenha expirado.</p>
</div>
<div class="paragraph data-line-338">
<p>Ao introduzir a funcionalidade de timelock diretamente na linguagem de script, o CLTV nos permite desenvolver alguns scripts complexos muito interessantes.</p>
</div>
<div class="paragraph data-line-340">
<p>O padrão é definido na <a href="https://github.com/bitcoin/bips/blob/master/bip-0065.mediawiki" data-href="https://github.com/bitcoin/bips/blob/master/bip-0065.mediawiki">BIP-65 (CHECKLOCKTIMEVERIFY)</a>.</p>
</div>
</div>
<div class="sect3 data-line-342">
<h4 id="_timelocks_relativos">Timelocks Relativos</h4>
<div class="paragraph data-line-344">
<p>O nLocktime e o CLTV são ambos <em>timelocks absolutos</em> no sentido de que eles especificam um ponto absoluto no tempo. Os próximos dois recursos de timelock que examinaremos são <em>timelocks relativos</em>, pois eles especificam, como condição para se gastar uma saída, um tempo decorrido desde a confirmação da saída na blockchain.</p>
</div>
<div class="paragraph data-line-346">
<p>Os timelocks relativos são úteis porque permitem que uma cadeia de duas ou mais transações interdependentes seja mantida <em>fora da cadeia</em> (em inglês, <em>off-chain</em>), enquanto impõem uma restrição de tempo em uma transação que depende do tempo decorrido desde a confirmação de uma transação anterior. Em outras palavras, o relógio não começa a contar até que a UTXO seja registrada na blockchain. Esta funcionalidade é especialmente útil em canais de estado bidirecionais e Lightning Networks, como veremos em <a href="#state_channels">[state_channels]</a>.</p>
</div>
<div class="paragraph data-line-348">
<p>Os timelocks relativos, assim como os timelocks absolutos, são implementados tanto como um recurso a nível de transação quanto como um código operacional a nível de script. O timelock relativo a nível de transação é implementado como uma regra de consenso baseada no valor do nSequence, um campo de transação que é definido em cada entrada de transação. Os timelocks relativos a nível de script são implementados com o código operacional CHECKSEQUENCEVERIFY (CSV).</p>
</div>
<div class="paragraph data-line-350">
<p>Os timelocks relativos são implementados de acordo com as especificações na <a href="https://github.com/bitcoin/bips/blob/master/bip-0068.mediawiki" data-href="https://github.com/bitcoin/bips/blob/master/bip-0068.mediawiki">BIP-68, Timelock relativo usando números de sequência impostos por consenso</a> e na <a href="https://github.com/bitcoin/bips/blob/master/bip-0112.mediawiki" data-href="https://github.com/bitcoin/bips/blob/master/bip-0112.mediawiki">BIP-112, CHECKSEQUENCEVERIFY</a>.</p>
</div>
<div class="paragraph data-line-352">
<p>A BIP-68 e a BIP-112 foram ativadas em maio de 2016 como uma atualização de soft fork das regras de consenso.</p>
</div>
</div>
<div class="sect3 data-line-354">
<h4 id="_timelocks_relativos_com_nsequence">Timelocks Relativos com nSequence</h4>
<div class="paragraph data-line-356">
<p>Os timelocks relativos podem ser definidos em cada entrada de uma transação, ao se definir o campo nSequence de cada entrada.</p>
</div>
<div class="sect4 data-line-358">
<h5 id="_significado_original_da_nsequence">Significado original da nSequence</h5>
<div class="paragraph data-line-360">
<p>O campo nSequence foi originalmente planejado (mas nunca devidamente implementado) para permitir a modificação de transações na mempool. Nesse uso, uma transação contendo entradas com valor nSequence menor que 2<sup>32</sup> - 1 (0xFFFFFFFF) indicaria uma transação que ainda não havia sido "finalizada". Essa transação seria mantida na mempool até que fosse substituída por outra transação gastando as mesmas entradas com um valor nSequence maior. Uma vez recebida uma transação cujas entradas tivessem um valor nSequence de 0xFFFFFFFF, ela seria considerada "finalizada" e minerada.</p>
</div>
<div class="paragraph data-line-362">
<p>O significado original do nSequence nunca foi devidamente implementado e o valor do nSequence geralmente é definido como 0xFFFFFFFF em transações que não utilizam timelocks. Para transações com nLocktime ou CHECKLOCKTIMEVERIFY, o nSequence deve ser definido para um valor menor que 2<sup>31</sup> para que as proteções do timelock tenham efeito, conforme explicado abaixo.</p>
</div>
</div>
<div class="sect4 data-line-364">
<h5 id="_nsequence_como_um_timelock_relativo_imposto_por_consenso">nSequence como um timelock relativo imposto por consenso</h5>
<div class="paragraph data-line-366">
<p>Desde a ativação da BIP-68, novas regras de consenso são aplicadas a qualquer transação contendo uma entrada cujo valor do nSequence seja menor que 2<sup>31</sup> (se o bit 1&lt;&lt;31 não for definido). Programaticamente, isso significa que se o bit mais significativo (bit 1&lt;&lt;31) não for definido, isso é um sinalizador que significa "timelock relativo". Caso contrário (se o bit 1&lt;&lt;31 for definido), o valor do nSequence é reservado para outros usos, como habilitar o CHECKLOCKTIMEVERIFY, o nLocktime, o Opt-In-Replace-By-Fee e outros desenvolvimentos futuros.</p>
</div>
<div class="paragraph data-line-368">
<p>As entradas de transação com valores de nSequence menores que 2<sup>31</sup> são interpretadas como tendo um timelock relativo. Essa transação só será considerada válida depois que a entrada envelhecer o valor do timelock relativo. Por exemplo, uma transação com uma entrada com um nSequence definindo um timelock relativo de 30 blocos só será considerada válida quando pelo menos 30 blocos tiverem decorrido desde o momento em que a UTXO referenciada na entrada foi minerada. Visto que existe um campo nSequence em cada entrada, uma transação pode conter qualquer número de entradas com timelock, todas as quais devem ter envelhecido o suficiente para que a transação seja considerada válida. Uma transação pode incluir ao mesmo tempo entradas com timelock (nSequence &lt; 2<sup>31</sup>) e entradas sem um timelock relativo (nSequence &gt;= 2<sup>31</sup>).</p>
</div>
<div class="paragraph data-line-370">
<p>O valor do nSequence é especificado em blocos ou segundos, mas em um formato ligeiramente diferente do que é usado no nLocktime. Um sinalizador de tipo é usado para diferenciar entre valores contando blocos e valores contando tempo em segundos. O sinalizador de tipo é definido no 23º bit menos significativo (ou seja, o valor 1&lt;&lt;22). Se o sinalizador de tipo for definido, o valor do nSequence será interpretado como um múltiplo de 512 segundos. Se o sinalizador de tipo não for definido, o valor do nSequence será interpretado como um número de blocos.</p>
</div>
<div class="paragraph data-line-372">
<p>Ao interpretar o nSequence como um timelock relativo, apenas os 16 bits menos significativos são considerados. Uma vez que os sinalizadores (bits 32 e 23) são avaliados, o valor do nSequence é geralmente "mascarado" com uma máscara de 16 bits (por exemplo, nSequence e 0x0000FFFF).</p>
</div>
<div class="paragraph data-line-374">
<p>A <a href="#bip_68_def_of_nseq">Definição da codificação nSequence na BIP-68 (Fonte: BIP-68)</a> mostra o layout binário do valor nSequence, conforme definido pela BIP-68.</p>
</div>
<div id="bip_68_def_of_nseq" class="imageblock data-line-378">
<div class="content">
<img src="images/mbc2_0701.png" alt="BIP-68 definition of nSequence encoding">
</div>
<div class="title">Figure 1. Definição da codificação nSequence na BIP-68 (Fonte: BIP-68)</div>
</div>
<div class="paragraph data-line-381">
<p>Os timelocks relativos baseados em imposição por consenso do valor nSequence são definidos na BIP-68.</p>
</div>
<div class="paragraph data-line-383">
<p>O padrão é definido na <a href="https://github.com/bitcoin/bips/blob/master/bip-0068.mediawiki" data-href="https://github.com/bitcoin/bips/blob/master/bip-0068.mediawiki">BIP-68, Timelock relativo usando números de sequência impostos por consenso</a>.</p>
</div>
</div>
</div>
<div class="sect3 data-line-385">
<h4 id="_timelocks_relativos_com_csv">Timelocks Relativos com CSV</h4>
<div class="paragraph data-line-387">
<p>Assim como o CLTV e o nLocktime, existe também um código operacional de script para timelocks relativos que aproveita o valor do nSequence contido em scripts. Esse código operacional é o CHECKSEQUENCEVERIFY, comumente referido como CSV.</p>
</div>
<div class="paragraph data-line-389">
<p>O código operacional CSV, quando avaliado em um script de resgate de UTXO, permite que a UTXO seja gasta apenas em uma transação cujo valor nSequence da entrada seja maior ou igual ao parâmetro CSV. Essencialmente, isso restringe o gasto da UTXO até que um certo número de blocos ou segundos tenham decorrido em relação ao momento em que a UTXO foi minerada.</p>
</div>
<div class="paragraph data-line-391">
<p>Tal como acontece com o CLTV, o valor no CSV deve corresponder ao formato usado no valor nSequence correspondente. Se o CSV for especificado em blocos, então o nSequence também deve ser especificado em blocos. Se o CSV for especificado em segundos, então o nSequence também deve ser especificado em segundos.</p>
</div>
<div class="paragraph data-line-393">
<p>Os timelocks relativos com CSV são especialmente úteis quando várias transações (relacionadas entre si) são criadas e assinadas, mas não propagadas, sendo mantidas "fora da cadeia" (<em>off-chain</em>). Uma transação filha não pode ser usada até que a transação pai tenha sido propagada e minerada, e tenha envelhecido o tempo especificado no timelock relativo. Uma aplicação deste caso de uso pode ser vista em <a href="#state_channels">[state_channels]</a> e <a href="#lightning_network">[lightning_network]</a>.</p>
</div>
<div class="paragraph data-line-395">
<p>O CSV é definido em detalhes na <a href="https://github.com/bitcoin/bips/blob/master/bip-0112.mediawiki" data-href="https://github.com/bitcoin/bips/blob/master/bip-0112.mediawiki">BIP-112, CHECKSEQUENCEVERIFY</a>.</p>
</div>
</div>
<div class="sect3 data-line-398">
<h4 id="_median_time_past">Median-Time-Past</h4>
<div class="paragraph data-line-400">
<p>Como parte da ativação dos timelocks relativos, houve também uma mudança na forma como o tempo é calculado para os timelocks (absolutos e relativos). No bitcoin, há uma diferença sutil, mas muito significativa, entre o horário real (horário no relógio de parede) e o horário de consenso. O bitcoin é uma rede descentralizada, o que significa que cada participante tem sua própria perspectiva de tempo. Os eventos na rede não ocorrem instantaneamente em todos os lugares. A latência da rede deve ser levada em consideração na perspectiva de cada nó. No final, todas as informações são sincronizadas para criar um livro-razão comum. A cada 10 minutos, o bitcoin chega a um consenso sobre qual era o estado do livro-razão no <em>passado</em>.</p>
</div>
<div class="paragraph data-line-402">
<p>Os carimbos de data e hora definidos nos cabeçalhos dos blocos são definidos pelos mineradores. As regras de consenso permitem um certo grau de liberdade para os mineradores, para considerar as diferenças que existem na precisão dos relógios dos nós descentralizados. No entanto, isso infelizmente cria um incentivo para os mineradores mentirem sobre o horário em que um bloco foi minerado, a fim de ganharem taxas extras ao incluírem transações com timelocks que ainda não amadureceram. Veja a seção a seguir para obter mais informações.</p>
</div>
<div class="paragraph data-line-404">
<p>Para remover o incentivo que existe para os mineradores mentirem e para fortalecer a segurança dos timelocks, uma BIP foi proposta e ativada ao mesmo tempo que as BIPs para os timelocks relativos. Ela é a BIP-113, que define uma nova medida de consenso de horário, a chamada <em>Median-Time-Past</em>.</p>
</div>
<div class="paragraph data-line-406">
<p>A <em>Median-Time-Past</em> (em português, <em>Mediana-do-Horário-do-Passado</em>) é calculada obtendo-se os registros de data e hora dos últimos 11 blocos e encontrando-se a mediana. Esse horário mediano então se torna o horário de consenso e é usado para todos os cálculos de timelock. Ao tomar o ponto médio de aproximadamente duas horas no passado, a influência do registro de data e hora de qualquer bloco isolado é reduzida. Ao incorporar 11 blocos, nenhum minerador consegue influenciar sozinho os registros de data e hora a fim de ganhar taxas de transações com timelocks que ainda não amadureceram.</p>
</div>
<div class="paragraph data-line-408">
<p>A Median-Time-Past altera a implementação de cálculos de hora para o nLocktime, o CLTV, o nSequence e o CSV. O horário de consenso calculado pela Median-Time-Past está sempre aproximadamente uma hora atrasado em relação ao horário real (do relógio). Se você for criar transações com timelock, você deverá levar isso em consideração ao estimar o valor desejado para codificar no nLocktime, nSequence, CLTV e CSV.</p>
</div>
<div class="paragraph data-line-410">
<p>A Median-Time-Past é especificada na <a href="https://github.com/bitcoin/bips/blob/master/bip-0113.mediawiki" data-href="https://github.com/bitcoin/bips/blob/master/bip-0113.mediawiki">BIP-113</a>.</p>
</div>
</div>
<div class="sect3 data-line-413">
<h4 id="fee_sniping">Timelock como Proteção contra Sniping de Taxas</h4>
<div class="paragraph data-line-415">
<p>O <em>sniping</em> de taxas é um cenário de ataque teórico, no qual mineradores tentando reescrever blocos anteriores incluem transações com taxas maiores de blocos futuros, com o objetivo de maximizar os seus lucros.</p>
</div>
<div class="paragraph data-line-417">
<p>Por exemplo, digamos que o bloco mais alto existente seja o bloco nº100.000. Imagine que, em vez de tentar minerar o bloco nº100.001 para estender a cadeia, alguns mineradores tentem reminerar o bloco nº100.000. Esses mineradores podem decidir incluir qualquer transação válida (que ainda não foi minerada) em seu bloco candidato nº100.000. Eles não precisam refazer o bloco com as mesmas transações. Na verdade, eles têm um incentivo para escolher as transações mais lucrativas (com a maior taxa por KB) para incluir em seu bloco. Eles podem incluir quaisquer transações que estavam no bloco "antigo" nº100.000, bem como quaisquer transações que estejam na mempool atual. Essencialmente, ao recriarem o bloco nº100.000, eles têm a possibilidade de puxar as transações do "presente" para o "passado" reescrito.</p>
</div>
<div class="paragraph data-line-419">
<p>Hoje, esse ataque não é muito lucrativo, pois a recompensa do bloco é muito maior do que as taxas totais por bloco. Mas, em algum momento no futuro, as taxas de transação constituirão a maior parte da recompensa da mineração (ou mesmo a totalidade da recompensa da mineração). Nesse momento, esse cenário se tornará inevitável.</p>
</div>
<div class="paragraph data-line-421">
<p>Para prevenir o "<em>sniping</em> de taxas", quando o Bitcoin Core cria transações, ele usa o nLocktime para limitá-las ao "próximo bloco", por padrão. Em nosso cenário, o Bitcoin Core definiria o nLocktime como 100.001 em qualquer transação criada. Em circunstâncias normais, este nLocktime não tem efeito&#x2014; de qualquer maneira, as transações só poderiam ser incluídas no bloco nº100.001, pois ele é o próximo bloco.</p>
</div>
<div class="paragraph data-line-423">
<p>Mas sob um ataque de fork/gasto duplo, os mineradores não seriam capazes de incluir as transações da mempool que tem taxas altas, pois todas essas transações teriam um <em>timelock</em> para o bloco nº100.001. Eles só conseguiriam reminerar o bloco nº100.000 com quaisquer transações que fossem válidas naquele momento no passado, ou seja, eles não ganhariam novas taxas.</p>
</div>
<div class="paragraph data-line-425">
<p>Para obter essa proteção, o Bitcoin Core define o nLocktime em todas as novas transações como &lt;nº do bloco atual + 1&gt; e define o nSequence em todas as entradas como 0xFFFFFFFE para ativar o nLocktime.</p>
</div>
</div>
</div>
<div class="sect2 data-line-427">
<h3 id="_scripts_com_controle_de_fluxo_cláusulas_condicionais">Scripts com Controle de Fluxo (Cláusulas Condicionais)</h3>
<div class="paragraph data-line-429">
<p>Um dos recursos mais poderosos do Bitcoin Script é o controle de fluxo, também conhecido como cláusulas condicionais. Você provavelmente está familiarizado com o controle de fluxo em várias linguagens de programação que usam a construção IF...THEN...ELSE. As cláusulas condicionais do bitcoin podem parecer um pouco diferentes, mas são essencialmente a mesma construção.</p>
</div>
<div class="paragraph data-line-431">
<p>Em um nível básico, os códigos operacionais condicionais do bitcoin nos permitem construir um script de resgate que tenha duas maneiras de ser destravado, dependendo de um resultado TRUE/FALSE (verdadeiro/falso) da avaliação de uma condição lógica. Por exemplo, se (IF) x for verdadeiro (TRUE), o script de resgate será A, caso contrário (ELSE), o script de resgate será B.</p>
</div>
<div class="paragraph data-line-433">
<p>Além disso, as expressões condicionais do bitcoin podem ser "aninhadas" indefinidamente, o que significa que uma cláusula condicional pode conter outra dentro dela, que contém outra, etc. O controle de fluxo do Bitcoin Script pode ser usado para construir scripts muito complexos com centenas ou mesmo milhares de caminhos de execução possíveis. Não há limite para o aninhamento, mas as regras de consenso impõem um limite no tamanho máximo, em bytes, de um script.</p>
</div>
<div class="paragraph data-line-435">
<p>O bitcoin implementa o controle de fluxo usando os códigos operacionais IF, ELSE, ENDIF e NOTIF. Além disso, as expressões condicionais podem conter operadores booleanos, como BOOLAND, BOOLOR e NOT.</p>
</div>
<div class="paragraph data-line-437">
<p>À primeira vista, você pode achar os scripts de controle de fluxo do bitcoin confusos. Isso ocorre porque o Bitcoin Script é uma linguagem de pilha. Da mesma forma que 1 {plus} 1 parece "invertido" quando expresso como 1 1 ADD, as cláusulas de controle de fluxo do bitcoin também parecem que estão "invertidas".</p>
</div>
<div class="paragraph data-line-439">
<p>Na maioria das linguagens de programação tradicionais (procedurais), o controle de fluxo tem a seguinte aparência:</p>
</div>
<div class="listingblock data-line-442">
<div class="title">Pseudocódigo do controle de fluxo na maioria das linguagens de programação</div>
<div class="content">
<pre>if ("se", condição):
  código a ser executado quando a condição for verdadeira
else ("caso contrário"):
  código a ser executado quando a condição for falsa
código a ser executado em qualquer caso</pre>
</div>
</div>
<div class="paragraph data-line-450">
<p>Em uma linguagem baseada em pilha como o Bitcoin Script, a condição lógica vem antes do IF, o que faz com que ela aparente estar "invertida", dessa maneira:</p>
</div>
<div class="listingblock data-line-453">
<div class="title">Controle de fluxo no Bitcoin Script</div>
<div class="content">
<pre>condição
IF
  código a ser executado quando a condição for verdadeira
ELSE
  código a ser executado quando a condição for falsa
ENDIF
código a ser executado em qualquer caso</pre>
</div>
</div>
<div class="paragraph data-line-463">
<p>Ao ler o Bitcoin Script, lembre-se de que a condição avaliada vem <em>antes</em> do código operacional IF.</p>
</div>
<div class="sect3 data-line-465">
<h4 id="_cláusulas_condicionais_com_códigos_operacionais_verify">Cláusulas Condicionais com Códigos Operacionais VERIFY</h4>
<div class="paragraph data-line-467">
<p>Outra forma de condicional no Bitcoin Script é qualquer código operacional que termina em VERIFY. O sufixo VERIFY significa que se a condição avaliada não for TRUE (verdadeira), a execução do script é imediatamente encerrada e a transação é considerada inválida.</p>
</div>
<div class="paragraph data-line-469">
<p>Ao contrário de uma cláusula IF, que oferece caminhos de execução alternativos, o sufixo VERIFY atua como uma <em>cláusula de proteção</em>, continuando apenas se uma pré-condição for atendida.</p>
</div>
<div class="paragraph data-line-471">
<p>Por exemplo, o script a seguir requer a assinatura do Bob e uma pré-imagem (um segredo) que produz um hash específico. Ambas as condições devem ser satisfeitas para destravá-lo:</p>
</div>
<div class="listingblock data-line-474">
<div class="title">Um script de resgate com uma cláusula de proteção EQUALVERIFY.</div>
<div class="content">
<pre>HASH160 &lt;hash esperado&gt; EQUALVERIFY &lt;Chave Pública do Bob&gt; CHECKSIG</pre>
</div>
</div>
<div class="paragraph data-line-478">
<p>Para resgatá-lo, o Bob deve construir um script de destravamento que apresente uma pré-imagem válida e uma assinatura:</p>
</div>
<div class="listingblock data-line-481">
<div class="title">Um script de destravamento para satisfazer o script de resgate acima</div>
<div class="content">
<pre>&lt;Assinatura do Bob&gt; &lt;hash da pré-imagem&gt;</pre>
</div>
</div>
<div class="paragraph data-line-485">
<p>Sem apresentar a pré-imagem, Bob não consegue chegar à parte do script que verifica sua assinatura.</p>
</div>
<div class="paragraph pagebreak-after data-line-488">
<p>Este script também poderia ser escrito com um IF:</p>
</div>
<div class="listingblock data-line-491">
<div class="title">Um script de resgate com uma cláusula de proteção IF</div>
<div class="content">
<pre>HASH160 &lt;hash esperado&gt; EQUAL
IF
   &lt;Chave pública do Bob&gt; CHECKSIG
ENDIF</pre>
</div>
</div>
<div class="paragraph data-line-498">
<p>O script de destravamento do Bob é idêntico:</p>
</div>
<div class="listingblock data-line-501">
<div class="title">Um script de destravamento para satisfazer o script de resgate acima</div>
<div class="content">
<pre>&lt;Assinatura do Bob&gt; &lt;hash da pré-imagem&gt;</pre>
</div>
</div>
<div class="paragraph data-line-505">
<p>O script com o IF faz a mesma coisa que usar um código operacional com um sufixo VERIFY; ambos funcionam como cláusulas de proteção. No entanto, a construção com o VERIFY é mais eficiente, pois usa dois códigos operacionais a menos.</p>
</div>
<div class="paragraph data-line-507">
<p>Então, quando devemos usar o VERIFY e quando devemos usar  o IF? Se tudo o que estamos tentando fazer é anexar uma pré-condição (uma cláusula de proteção), então é melhor usarmos o VERIFY. Se, entretanto, quisermos ter mais de um caminho de execução (um controle de fluxo), então precisamos de uma cláusula de controle de fluxo IF...ELSE.</p>
</div>
<div class="admonitionblock tip data-line-510">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-511">
<p>Um código operacional como o EQUAL adicionará o resultado (TRUE/FALSE) na pilha, deixando-o lá para ser avaliado por códigos operacionais subsequentes. Em contraste, o sufixo de código operacional EQUALVERIFY não deixa nada na pilha. Os códigos operacionais que terminam em VERIFY não deixam o resultado na pilha.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3 data-line-514">
<h4 id="_usando_controle_de_fluxo_em_scripts">Usando Controle de Fluxo em Scripts</h4>
<div class="paragraph data-line-516">
<p>Um uso muito comum para o controle de fluxo no Bitcoin Script é construir um script de resgate que oferece vários caminhos de execução, cada um com uma maneira diferente de resgatar a UTXO.</p>
</div>
<div class="paragraph data-line-518">
<p>Vejamos um exemplo simples, em que temos dois signatários, a Alice e o Bob, e qualquer um deles pode resgatar. Com a funcionalidade de multiassinatura, isso seria expresso como um script multiassinatura 1-de-2. Para fins de demonstração, faremos a mesma coisa com uma cláusula IF:</p>
</div>
<div class="listingblock data-line-520">
<div class="content">
<pre>IF
 &lt;Chave Pública da Alice&gt; CHECKSIG
ELSE
 &lt;Chave pública do Bob&gt; CHECKSIG
ENDIF</pre>
</div>
</div>
<div class="paragraph data-line-528">
<p>Olhando para este script de resgate, você pode estar se perguntando: "Onde está a condição? Não há nada antes da cláusula IF!"</p>
</div>
<div class="paragraph data-line-530">
<p>A condição não faz parte do script de resgate. Em vez disso, a condição será oferecida no script de destravamento, permitindo que a Alice e o Bob "escolham" o caminho de execução que eles quiserem.</p>
</div>
<div class="paragraph data-line-532">
<p>A Alice resgata a UTXO com o seguinte script de destravamento:</p>
</div>
<div class="listingblock data-line-533">
<div class="content">
<pre>&lt;Assinatura da Alice&gt; 1</pre>
</div>
</div>
<div class="paragraph data-line-537">
<p>O 1 no final serve como a condição (TRUE) que fará com que a cláusula IF execute o primeiro caminho de resgate, para o qual a Alice tem uma assinatura.</p>
</div>
<div class="paragraph data-line-539">
<p>Para que o Bob resgatasse a UTXO, ele teria que escolher o segundo caminho de execução atribuindo um valor FALSE à cláusula IF:</p>
</div>
<div class="listingblock data-line-541">
<div class="content">
<pre>&lt;Assinatura do Bob&gt; 0</pre>
</div>
</div>
<div class="paragraph data-line-545">
<p>O script de destravamento do Bob coloca um 0 na pilha, fazendo com que a cláusula IF execute o segundo script (ELSE), que requer a assinatura de Bob.</p>
</div>
<div class="paragraph data-line-547">
<p>Como as cláusulas IF podem ser aninhadas, podemos criar um "labirinto" de caminhos de execução. O script de destravamento pode fornecer um "mapa" selecionando qual caminho de execução é de fato executado:</p>
</div>
<div class="listingblock data-line-549">
<div class="content">
<pre>IF
  script A
ELSE
  IF
    script B
  ELSE
    script C
  ENDIF
ENDIF</pre>
</div>
</div>
<div class="paragraph data-line-561">
<p>Nesse cenário, há três caminhos de execução (script A, script B e script C). O script de destravamento fornece um caminho na forma de uma sequência de valores TRUE ou FALSE. Para selecionar o caminho script B, por exemplo, o script de destravamento deve terminar em 1 0 (TRUE, FALSE). Esses valores serão adicionados na pilha, de modo que o segundo valor (FALSE) termine no topo da pilha. A cláusula IF externa remove o valor FALSE da pilha e executa a primeira cláusula ELSE. Em seguida, o valor TRUE é movido para o topo da pilha e é avaliado pelo IF interno (aninhado), selecionando o caminho de execução B.</p>
</div>
<div class="paragraph data-line-563">
<p>Usando essa construção, podemos fazer scripts de resgate com dezenas ou centenas de caminhos de execução, cada um oferecendo uma maneira diferente de resgatar a UTXO. Para gastar, construímos um script de destravamento que navega pelo caminho de execução, colocando os valores TRUE e FALSE apropriados na pilha em cada ponto de controle de fluxo. </p>
</div>
</div>
</div>
<div class="sect2 data-line-565">
<h3 id="_exemplo_de_script_complexo">Exemplo de Script Complexo</h3>
<div class="paragraph data-line-567">
<p>Nesta seção combinaremos muitos dos conceitos deste capítulo em um único exemplo.</p>
</div>
<div class="paragraph data-line-569">
<p>Nosso exemplo usa a história do Mohammed, o proprietário da empresa de Dubai que opera um negócio de importação/exportação.</p>
</div>
<div class="paragraph data-line-571">
<p>Neste exemplo, o Mohammed deseja construir uma conta de capital da empresa com regras flexíveis. O esquema que ele está criando requer diferentes níveis de autorização dependendo dos timelocks. Os participantes do esquema multiassinatura são o Mohammed, seus dois sócios Saeed e Zaira, e o advogado da empresa, o Abdul. Os três sócios tomam decisões com base na regra da maioria, portanto, dois dos três devem concordar. No entanto, caso haja algum problema com suas chaves, eles querem que seu advogado possa recuperar os fundos com uma assinatura dos três sócios. Finalmente, se todos os sócios estiverem indisponíveis ou incapacitados por um tempo, eles querem que o advogado possa administrar a conta diretamente.</p>
</div>
<div class="paragraph data-line-573">
<p>A seguir está o script de resgate que o Mohammed desenvolveu para o seu esquema multiassinatura (os números no início de cada linha correspondem ao número da linha no script):</p>
</div>
<div class="listingblock data-line-576">
<div class="title">Multiassinatura Variável com Timelock</div>
<div class="content">
<pre>01  IF
02    IF
03      2
04    ELSE
05      &lt;30 dias&gt; CHECKSEQUENCEVERIFY DROP
06      &lt;Chave Pública do Advogado Abdul&gt; CHECKSIGVERIFY
07      1
08    ENDIF
09    &lt;Chave Pública do Mohammed&gt; &lt;Chave Pública do Saeed&gt; &lt;Chave Pública da Zaira&gt; 3 CHECKMULTISIG
10  ELSE
11    &lt;90 dias&gt; CHECKSEQUENCEVERIFY DROP
12    &lt;Chave Pública do Advogado Abdul&gt; CHECKSIG
13  ENDIF</pre>
</div>
</div>
<div class="paragraph data-line-592">
<p>O script do Mohammed implementa três caminhos de execução usando cláusulas de controle de fluxo IF...ELSE aninhadas.</p>
</div>
<div class="paragraph data-line-594">
<p>No primeiro caminho de execução, este script opera como uma multiassinatura 2-de-3 simples com os três sócios. Este caminho de execução consiste nas linhas 3 e 9. A linha 3 define o quórum da multiassinatura para 2 (2-de-3). Este caminho de execução pode ser selecionado colocando-se TRUE TRUE no final do script de destravamento:</p>
</div>
<div class="listingblock data-line-597">
<div class="title">Script de destravamento para o primeiro caminho de execução (multiassinatura 2-de-3)</div>
<div class="content">
<pre>0 &lt;Assinatura do Mohammed&gt; &lt;Assinatura da Zaira&gt; TRUE TRUE</pre>
</div>
</div>
<div class="admonitionblock tip data-line-603">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-604">
<p>O 0 no início deste script de destravamento é devido a um bug no CHECKMULTISIG que remove um valor extra da pilha. O valor extra é desconsiderado pelo CHECKMULTISIG, mas ele deve estar presente, caso contrário o script falhará. Uma solução para contornar o bug geralmente consiste em adicionar um 0, conforme descrito em <a href="#multisig_bug">Um bug na execução do CHECKMULTISIG</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-607">
<p>O segundo caminho de execução só pode ser usado 30 dias após a criação da UTXO. Após passados esses 30 dias, ele exigirá a assinatura do advogado Abdul e a assinatura de um dos três sócios (uma multiassinatura 1-de-3). Isso é realizado na linha 7 do script, que define o quórum da multiassinatura para 1. Para selecionar este caminho de execução, o script de destravamento terminaria em FALSE TRUE:</p>
</div>
<div class="listingblock data-line-610">
<div class="title">Script de destravamento para o segundo caminho de execução (advogado + 1-de-3)</div>
<div class="content">
<pre>0 &lt;Assinatura do Advogado Abdul&gt; &lt;Assinatura do Saeed&gt; FALSE TRUE</pre>
</div>
</div>
<div class="admonitionblock tip data-line-615">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-616">
<p>Por que FALSE TRUE? Isso não está invertido? Isso acontece porque os dois valores são adicionados na pilha, o FALSE sendo adicionado primeiro e o TRUE sendo adicionado em seguida. O TRUE é, portanto, o <em>primeiro</em> valor a ser removido pelo primeiro código operacional IF.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-619">
<p>Por fim, o terceiro caminho de execução permite que o Abdul, o advogado, gaste os fundos sozinho, mas somente após 90 dias. Para selecionar este caminho de execução, o script de destravamento deve terminar em FALSE:</p>
</div>
<div class="listingblock data-line-622">
<div class="title">Script de destravamento para o terceiro caminho de execução (apenas o advogado)</div>
<div class="content">
<pre>&lt;Assinatura do Advogado Abdul&gt; FALSE</pre>
</div>
</div>
<div class="paragraph data-line-626">
<p>Tente executar o script no papel para ver como ele se comporta na pilha.</p>
</div>
<div class="paragraph data-line-628">
<p>Mais algumas coisas a serem consideradas ao ler este exemplo. Veja se você consegue encontrar as respostas:</p>
</div>
<div class="ulist data-line-630">
<ul>
<li class="data-line-630">
<p>Por que o advogado não pode resgatar o terceiro caminho de execução a qualquer momento, selecionando-o com FALSE no script de destravamento?</p>
</li>
<li class="data-line-632">
<p>Quantos caminhos de execução podem ser usados 5, 35 e 105 dias, respectivamente, após a UTXO ser minerada?</p>
</li>
<li class="data-line-634">
<p>Os fundos são perdidos se o advogado perder a chave? Sua resposta mudaria caso 91 dias se passaram?</p>
</li>
<li class="data-line-636">
<p>De que maneira os sócios "zeram" o relógio a cada 29 ou 89 dias para prevenir que o advogado acesse os fundos?</p>
</li>
<li class="data-line-638">
<p>Por que alguns códigos operacionais CHECKSIG neste script têm o sufixo VERIFY e outros não?</p>
</li>
</ul>
</div>
</div>
<div class="sect2 data-line-641">
<h3 id="segwit">Segregated Witness (Testemunha Segregada)</h3>
<div class="paragraph data-line-643">
<p>A Segregated Witness ou segwit (em português, Testemunha Segregada) é uma atualização para as regras de consenso do bitcoin e para o protocolo da rede, que foi proposta e implementada como um soft-fork BIP-9, o qual foi ativado na rede principal do bitcoin em 1º de agosto de 2017.</p>
</div>
<div class="paragraph data-line-645">
<p>Na criptografia, o termo "testemunha" (em inglês, <em>witness</em>) é usado para descrever uma solução para um quebra-cabeça criptográfico. Em termos de bitcoin, a testemunha satisfaz uma condição criptográfica colocada em uma saída de transação não gasta (UTXO).</p>
</div>
<div class="paragraph data-line-647">
<p>No contexto do bitcoin, uma assinatura digital é <em>um tipo de testemunha</em>, mas uma testemunha é mais amplamente qualquer solução que seja capaz de satisfazer as condições impostas a uma UTXO e de destravar essa UTXO para ser gasta. O termo "testemunha" é um termo mais geral para um "script de destravamento" ou "scriptSig".</p>
</div>
<div class="paragraph data-line-649">
<p>Antes da introdução da segwit, cada entrada em uma transação era seguida pelos dados de testemunha que a destravavam. Os dados de testemunha eram incorporados à transação como parte de cada entrada. Portanto, "<em>testemunha segregada</em>" nada mais é do que separar (segregar) a assinatura ou o script de destravamento de uma saída específica. Para simplificar, pense como se fosse um "scriptSig separado" ou uma "assinatura separada".</p>
</div>
<div class="paragraph data-line-651">
<p>A Segregated Witness, portanto, é uma mudança arquitetônica para o bitcoin que visa mover os dados de testemunha do campo scriptSig (script de destravamento) de uma transação para uma estrutura separada de dados de <em>testemunha</em> que acompanha uma transação. Os clientes podem solicitar dados de transações com ou sem os dados de testemunha que as acompanham.</p>
</div>
<div class="paragraph data-line-653">
<p>Nesta seção, veremos alguns dos benefícios da Segregated Witness, descreveremos o mecanismo usado para implantar e implementar essa mudança de arquitetura, assim como demonstraremos o uso da Segregated Witness em transações e endereços.</p>
</div>
<div class="paragraph data-line-655">
<p>A Segregated Witness é definida pelas seguintes BIPs:</p>
</div>
<div class="dlist data-line-657">
<dl>
<dt class="hdlist1"><a href="https://github.com/bitcoin/bips/blob/master/bip-0141.mediawiki" data-href="https://github.com/bitcoin/bips/blob/master/bip-0141.mediawiki">BIP-141</a> </dt>
<dd>
<p>A definição principal da Segregated Witness.</p>
</dd>
<dt class="hdlist1"><a href="https://github.com/bitcoin/bips/blob/master/bip-0143.mediawiki" data-href="https://github.com/bitcoin/bips/blob/master/bip-0143.mediawiki">BIP-143</a> </dt>
<dd>
<p>Verificação de Assinatura de Transação para o Programa de Testemunha Versão 0</p>
</dd>
<dt class="hdlist1"><a href="https://github.com/bitcoin/bips/blob/master/bip-0144.mediawiki" data-href="https://github.com/bitcoin/bips/blob/master/bip-0144.mediawiki">BIP-144</a> </dt>
<dd>
<p>Serviços de Par&#x2014;Novas mensagens de rede e formatos de serialização</p>
</dd>
<dt class="hdlist1"><a href="https://github.com/bitcoin/bips/blob/master/bip-0145.mediawiki" data-href="https://github.com/bitcoin/bips/blob/master/bip-0145.mediawiki">BIP-145</a> </dt>
<dd>
<p>Atualizações do getblocktemplate para a Segregated Witness (para mineração)</p>
</dd>
<dt class="hdlist1"><a href="https://github.com/bitcoin/bips/blob/master/bip-0173.mediawiki" data-href="https://github.com/bitcoin/bips/blob/master/bip-0173.mediawiki">BIP-173</a></dt>
<dd>
<p>Formato de endereço Base32 para saídas de testemunha v0-16 nativas</p>
</dd>
</dl>
</div>
<div class="sect3 data-line-668">
<h4 id="_por_que_a_segregated_witness_foi_implementada">Por que a Segregated Witness foi Implementada?</h4>
<div class="paragraph data-line-670">
<p>A Segregated Witness é uma mudança arquitetônica que tem vários efeitos sobre a escalabilidade, a segurança, os incentivos econômicos e o desempenho do bitcoin:</p>
</div>
<div class="dlist data-line-672">
<dl>
<dt class="hdlist1">Maleabilidade de transação </dt>
<dd>
<p>Ao mover a testemunha para fora dos dados da transação, o hash de transação, que é usado como um identificador, deixa de incluir os dados de testemunha. Como os dados de testemunha são a única parte da transação que pode ser modificada por terceiros (ver <a href="#segwit_txid">Identificadores de transação</a>), removê-los também remove a oportunidade para ataques de maleabilidade de transação. Com a Segregated Witness, os hashes de transação tornam-se imutáveis para qualquer pessoa que não seja o criador da transação, o que representa um grande avanço na implementação de muitos outros protocolos que dependem da construção de transações de bitcoin avançadas, como canais de pagamento, transações encadeadas e redes lightning.</p>
</dd>
<dt class="hdlist1">Controle de Versão de Script </dt>
<dd>
<p>Com a introdução de scripts de Segregated Witness, cada script de travamento é precedido por um número de <em>versão de script</em>, semelhante à maneira como as transações e os blocos têm números de versão. A adição de um número de versão de script permite que a linguagem de script seja atualizada de maneira compatível com versões anteriores (ou seja, usando atualizações de soft fork) para introduzir novos operandos, sintaxe ou semântica de script. A capacidade de atualizar a linguagem de script de uma forma não disruptiva aumentará bastante a velocidade de inovação do bitcoin.</p>
</dd>
<dt class="hdlist1">Escalabilidade da Rede e do Armazenamento </dt>
<dd>
<p>Os dados de testemunha geralmente contribuem bastante para o tamanho total de uma transação. Scripts mais complexos, como aqueles usados para multiassinaturas ou canais de pagamento, são muito grandes. Em alguns casos, esses scripts respondem pela maioria (mais de 75%) dos dados em uma transação. Ao mover os dados de testemunha para fora dos dados da transação, a Segregated Witness melhora a escalabilidade do bitcoin. Os nós podem remover os dados de testemunha após validar as assinaturas ou ignorá-los completamente, caso eles façam a verificação de pagamento simplificada. Os dados de testemunha não precisam ser transmitidos para todos os nós e não precisam ser armazenados no disco por todos os nós.</p>
</dd>
<dt class="hdlist1">Otimização da Verificação de Assinatura </dt>
<dd>
<p>A Segregated Witness atualiza as funções de assinatura (CHECKSIG, CHECKMULTISIG, etc.) para reduzir a complexidade computacional do algoritmo. Antes da segwit, o algoritmo usado para produzir uma assinatura exigia um número de operações de hash que era proporcional ao tamanho da transação. Os cálculos de <em>hashing</em> dos dados aumentavam em O(n<sup>2</sup>) em relação ao número de operações de assinatura, introduzindo uma carga computacional substancial em todos os nós que verificam a assinatura. Com a segwit, o algoritmo foi alterado para reduzir a complexidade para O(n).</p>
</dd>
<dt class="hdlist1">Melhoria na Assinatura Offline </dt>
<dd>
<p>As assinaturas da Segregated Witness incorporam o valor (quantia) referenciado por cada entrada no hash que é assinado. Antes disso, um dispositivo de assinatura offline, como uma carteira de hardware, tinha que verificar a quantia de cada entrada antes de assinar uma transação. Isso geralmente era feito através de um streaming de uma grande quantidade de dados contendo informações sobre as transações prévias referenciadas como entradas. Como a quantia agora faz parte do hash de compromisso que é assinado, um dispositivo offline não precisa mais das transações prévias. Se as quantias não corresponderem (se elas forem adulteradas por um sistema online comprometido), a assinatura será inválida.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3 data-line-682">
<h4 id="_como_funciona_a_segregated_witness">Como Funciona a Segregated Witness</h4>
<div class="paragraph data-line-684">
<p>À primeira vista, a Segregated Witness parece ser uma mudança na forma como as transações são construídas e, portanto, um recurso a nível de transação, mas ela não é. Em vez disso, a  Segregated Witness é uma mudança na forma como a UTXO individual é gasta e, portanto, é um recurso a nível de cada saída individual.</p>
</div>
<div class="paragraph data-line-686">
<p>Uma transação pode gastar saídas da Segregated Witness, saídas tradicionais (testemunha em linha) ou ambas. Portanto, não faz muito sentido se referir a uma transação como uma "transação de Segregated Witness". Em vez disso, devemos nos referir a saídas de transação específicas como "saídas de Segregated Witness" ou "saídas com testmunha segregada".</p>
</div>
<div class="paragraph data-line-688">
<p>Quando uma transação gasta uma UTXO, ela deve fornecer uma testemunha. Em uma UTXO tradicional, o script de travamento requer que os dados de testemunha sejam fornecidos <em>em linha</em> na entrada da transação que gasta a UTXO. Uma UTXO de Segregated Witness, entretanto, especifica um script de travamento que pode ser satisfeito com dados de testemunha que estejam fora da entrada (que estejam segregados da entrada).</p>
</div>
</div>
<div class="sect3 data-line-690">
<h4 id="_soft_fork_retrocompatibilidade">Soft Fork (Retrocompatibilidade)</h4>
<div class="paragraph data-line-692">
<p>Segregated Witness is a significant change to the way outputs and transactions are architected. Such a change would normally require a simultaneous change in every Bitcoin node and wallet to change the consensus rules&#x2014;what is known as a hard fork. Instead, segregated witness is introduced with a much less disruptive change, which is backward compatible, known as a soft fork. This type of upgrade allows non-upgraded software to ignore the changes and continue to operate without any disruption.</p>
</div>
<div class="paragraph data-line-694">
<p>As saídas de Segregated Witness são construídas de forma que elas ainda possam ser validadas por sistemas mais antigos que não reconhecem a segwit. Para uma carteira ou nó antigo, uma saída de Segregated Witness parece ser uma saída que <em>qualquer pessoa pode gastar</em>. Essas saídas podem ser gastas com uma assinatura vazia, portanto, o fato de não haver assinatura dentro da transação (a assinatura é segregada) não invalida a transação. Carteiras e nós de mineração mais novos, no entanto, veem a saída de Segregated Witness e esperam encontrar uma testemunha válida para ela nos dados de testemunha da transação.</p>
</div>
</div>
<div class="sect3 data-line-696">
<h4 id="_exemplos_de_saída_e_de_transação_com_segregated_witness">Exemplos de Saída e de Transação com Segregated Witness</h4>
<div class="paragraph data-line-698">
<p>Vamos dar uma olhada em algumas de nossas transações de exemplo para ver como elas mudariam com a Segregated Witness. Veremos primeiro como um pagamento Pay-to-Public-Key-Hash (P2PKH) é transformado com o programa da Segregated Witness. Em seguida, veremos o equivalente da Segregated Witness para os scripts Pay-to-Script-Hash (P2SH). Finalmente, veremos como ambos os programas de Segregated Witness descritos acima podem ser incorporados a um script P2SH.</p>
</div>
<div class="sect4 data-line-701">
<h5 id="p2wpkh">Pay-to-Witness-Public-Key-Hash (P2WPKH)</h5>
<div class="paragraph data-line-703">
<p>Em <a href="#cup_of_coffee">[cup_of_coffee]</a>, a Alice criou uma transação para pagar ao Bob por uma xícara de café. Essa transação criou uma saída P2PKH com um valor de 0,015 BTC que poderia ser gasto pelo Bob. O script da saída é semelhante a este:</p>
</div>
<div class="listingblock data-line-706">
<div class="title">Exemplo de script de saída P2PKH</div>
<div class="content">
<pre>DUP HASH160 ab68025513c3dbd2f7b92a94e0581f5d50f654e7 EQUALVERIFY CHECKSIG</pre>
</div>
</div>
<div class="paragraph data-line-710">
<p>Com a Segregated Witness, a Alice criaria um script Pay-to-Witness-Public-Key-Hash (P2WPKH) (em português, Paga-para-Testemunha-de-Hash-de-Chave-Pública), que ficaria assim:</p>
</div>
<div class="listingblock data-line-713">
<div class="title">Exemplo de script de saída P2WPKH</div>
<div class="content">
<pre>0 ab68025513c3dbd2f7b92a94e0581f5d50f654e7</pre>
</div>
</div>
<div class="paragraph data-line-717">
<p>As you can see, a Segregated Witness output’s locking script is much simpler than a traditional output. It consists of two values that are pushed on to the script evaluation stack. To an old (nonsegwit-aware) Bitcoin client, the two pushes would look like an output that anyone can spend and does not require a signature (or rather, can be spent with an empty signature). To a newer, segwit-aware client, the first number (0) is interpreted as a version number (the <em>witness version</em>) and the second part (20 bytes) is the equivalent of a locking script known as a <em>witness program</em>. The 20-byte witness program is simply the hash of the public key, as in a P2PKH script.</p>
</div>
<div class="paragraph data-line-719">
<p>Agora, vamos examinar a transação correspondente que o Bob usa para gastar essa saída. Para o script original (não segwit), a transação do Bob teria que incluir uma assinatura na entrada de transação:</p>
</div>
<div class="listingblock data-line-722">
<div class="title">Transação decodificada mostrando uma saída P2PKH sendo gasta com uma assinatura</div>
<div class="content">
<pre>[...]
“Vin” : [
"txid": "0627052b6f28912f2703066a912ea577f2ce4da4caa5a5fbd8a57286c345c2f2",
"vout": 0,
     	 "scriptSig": “&lt;scriptSig do Bob&gt;”,
]
[...]</pre>
</div>
</div>
<div class="paragraph data-line-732">
<p>No entanto, para gastar a saída de Segregated Witness, a transação não tem uma assinatura na parte da entrada. Em vez disso, a transação do Bob tem um scriptSig vazio nos dados da transação (a primeira parte de uma transação, que inclui a parte da entrada) e inclui sua assinatura nos dados de testemunha (a segunda parte de uma transação, que é separada dos dados da transação):</p>
</div>
<div class="listingblock data-line-735">
<div class="title">Transação decodificada mostrando uma saída P2WPKH sendo gasta com dados de testemunha separados</div>
<div class="content">
<pre>[...]
“Vin” : [
"txid": "0627052b6f28912f2703066a912ea577f2ce4da4caa5a5fbd8a57286c345c2f2",
"vout": 0,
     	 "scriptSig": “”,
]
[...]
“witness”: “&lt;dados de testemunha do Bob&gt;”
[...]</pre>
</div>
</div>
</div>
<div class="sect4 data-line-747">
<h5 id="_construção_do_p2wpkh_pela_carteira">Construção do P2WPKH pela carteira</h5>
<div class="paragraph data-line-749">
<p>É extremamente importante observar que o P2WPKH só deve ser criado pelo beneficiário (destinatário) e que ele não deve ser convertido pelo remetente a partir de uma chave pública, um script P2PKH ou um endereço conhecido. O destinatário não tem como saber se a carteira do remetente tem a capacidade de construir transações segwit e de gastar saídas P2WPKH.</p>
</div>
<div class="paragraph data-line-751">
<p>Além disso, as saídas P2WPKH devem ser construídas a partir do hash de uma chave pública <em>comprimida</em>. As chaves públicas não comprimidas não fazem parte do padrão segwit e podem ser explicitamente desabilitadas por um soft fork no futuro. Se o hash usado no P2WPKH vier de uma chave pública não comprimida, ele pode não ser gastável e você pode acabar perdendo os seus fundos. As saídas P2WPKH devem ser criadas pela carteira do beneficiário ao se derivar uma chave pública comprimida a partir de sua chave privada.</p>
</div>
<div class="admonitionblock warning data-line-754">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph data-line-755">
<p>P2WPKH should be constructed by the payee (recipient) by converting a compressed public key to a P2WPKH hash. You should never transform a P2PKH script, Bitcoin address, or uncompressed public key to a P2WPKH witness script.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4 data-line-759">
<h5 id="p2wsh">Pay-to-Witness-Script-Hash (P2WSH)</h5>
<div class="paragraph data-line-761">
<p>O segundo tipo de programa de testemunha corresponde a um script Pay-to-Script-Hash (P2SH). Nós vimos esse tipo de script em <a href="#p2sh">Pay-to-Script-Hash (P2SH)</a>. Naquele exemplo, o P2SH foi usado pela empresa do Mohammed para expressar um script multiassinatura. Os pagamentos para a empresa do Mohammed foram codificados com um script de travamento como este:</p>
</div>
<div class="listingblock data-line-764">
<div class="title">Exemplo de script de saída P2SH</div>
<div class="content">
<pre>HASH160 54c557e07dde5bb6cb791c7a540e0a4796f5e97e EQUAL</pre>
</div>
</div>
<div class="paragraph data-line-768">
<p>Este script P2SH faz referência ao hash de um <em>script de resgate</em> que define uma exigência de uma multiassinatura 2-de-5 para se gastar os fundos. Para gastar essa saída, a empresa do Mohammed apresentaria o script de resgate (cujo hash corresponde ao hash de script contido na saída P2SH) e as assinaturas necessárias para satisfazer esse script de resgate, tudo dentro da entrada da transação:</p>
</div>
<div class="listingblock data-line-771">
<div class="title">Transação decodificada mostrando uma saída P2SH sendo gasta</div>
<div class="content">
<pre>[...]
“Vin” : [
"txid": "abcdef12345...",
"vout": 0,
     	 "scriptSig": “&lt;AssA&gt; &lt;AssB&gt; &lt;2 CPubA CPubB CPubC CPubD CPubE 5 CHECKMULTISIG&gt;”,
]</pre>
</div>
</div>
<div class="paragraph data-line-780">
<p>Agora, vamos ver como esse exemplo ficaria caso ele fosse atualizado para a segwit. Se os clientes do Mohammed estivessem usando uma carteira compatível com segwit, eles fariam um pagamento criando uma saída Pay-to-Witness-Script-Hash (P2WSH) (em português, Paga-para-Testemunha-de-Hash-de-Script) semelhante a esta:</p>
</div>
<div class="listingblock data-line-783">
<div class="title">Exemplo de script de saída P2WSH</div>
<div class="content">
<pre>0 a9b7b38d972cabc7961dbfbcb841ad4508d133c47ba87457b4a0e8aae86dbb89</pre>
</div>
</div>
<div class="paragraph data-line-787">
<p>Novamente, assim como no exemplo do P2WPKH, você pode ver que o script equivalente da Segregated Witness é muito mais simples e omite os vários operandos de script que são vistos nos scripts P2SH. Em vez disso, o programa de Segregated Witness consiste em dois valores que são adicionados na pilha: a versão da testemunha (0) e o hash SHA256 de 32 bytes do script de resgate.</p>
</div>
<div class="paragraph data-line-789">
<p>A empresa do Mohammed pode gastar a saída P2WSH apresentando o script de resgate correto e um número suficiente de assinaturas para satisfazê-lo. Tanto o script de resgate quanto as assinaturas seriam segregados <em>fora</em> dos dados da transação de gasto como parte dos dados de testemunha. Na entrada da transação, a carteira do Mohammed colocaria um scriptSig vazio:</p>
</div>
<div class="listingblock data-line-792">
<div class="title">Transação decodificada mostrando uma saída P2WSH sendo gasta com dados de testemunha separados</div>
<div class="content">
<pre>[...]
“Vin” : [
"txid": "abcdef12345...",
"vout": 0,
     	 "scriptSig": “”,
]
[...]
“witness”: “&lt;AssA&gt; &lt;AssB&gt; &lt;2 CPubA CPubB CPubC CPubD CPubE 5 CHECKMULTISIG&gt;”
[...]</pre>
</div>
</div>
<div class="admonitionblock tip data-line-805">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-806">
<p>Enquanto o P2SH usa o hash de 20 bytes do RIPEMD160(SHA256(script)), o programa de testemunha P2WSH usa um hash de 32 bytes do SHA256(script). Esta diferença na escolha do algoritmo de hash é deliberada e fornece maior segurança para o P2WSH (128 bits de segurança no P2WSH versus 80 bits de segurança no P2SH). Ela também é usada para diferenciar entre os dois tipos de programas de testemunha (P2WPKH e P2WSH) através do comprimento do hash (ver abaixo).</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4 data-line-810">
<h5 id="_diferenciando_entre_p2wpkh_e_p2wsh">Diferenciando entre P2WPKH e P2WSH</h5>
<div class="paragraph data-line-812">
<p>Nas duas seções anteriores, demonstramos dois tipos de programas de testemunha: <a href="#p2wpkh">Pay-to-Witness-Public-Key-Hash (P2WPKH)</a> e <a href="#p2wsh">Pay-to-Witness-Script-Hash (P2WSH)</a>. Ambos os tipos de programas de testemunha consistem em um número de versão de apenas um byte seguido por um hash mais longo. Eles são muito semelhantes, mas são interpretados de maneiras muito diferentes: um é interpretado como um hash de chave pública, que é satisfeito por uma assinatura e o outro é interpretado como um hash de script, que é satisfeito por um script de resgate. A diferença crucial entre eles é o comprimento do hash:</p>
</div>
<div class="ulist data-line-814">
<ul>
<li class="data-line-814">
<p>O hash de chave pública no P2WPKH tem 20 bytes</p>
</li>
<li class="data-line-815">
<p>O hash de script no P2WSH tem 32 bytes</p>
</li>
</ul>
</div>
<div class="paragraph data-line-817">
<p>Essa diferença é o que permite que uma carteira diferencie os dois tipos de programa de testemunha. Observando o comprimento do hash, uma carteira pode determinar qual é o tipo do programa de testemunha, P2WPKH ou P2WSH.</p>
</div>
</div>
</div>
<div class="sect3 data-line-819">
<h4 id="_atualizando_para_a_segregated_witness">Atualizando para a Segregated Witness</h4>
<div class="paragraph data-line-821">
<p>Como podemos ver nos exemplos anteriores, a atualização para a Segregated Witness é um processo de duas etapas. Primeiro, as carteiras devem criar saídas especiais do tipo segwit. Então, essas saídas podem ser gastas por carteiras que sabem como construir transações de Segregated Witness. Nos exemplos, a carteira da Alice era compatível com segwit e tinha a capacidade de criar saídas especiais com scripts de Segregated Witness. A carteira do Bob também é compatível com a segwit e tem a capacidade de gastar essas saídas. O que pode não ser óbvio a partir do exemplo é que, na prática, a carteira da Alice precisa <em>saber</em> que o Bob usa uma carteira que é compatível com segwit e consegue gastar essas saídas. Caso contrário, se a carteira de Bob não for atualizada e a Alice tentar fazer pagamentos de segwit para o Bob, a carteira do Bob não será capaz de detectar esses pagamentos.</p>
</div>
<div class="admonitionblock tip data-line-824">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-825">
<p>Para os pagamentos dos tipos P2WPKH e P2WSH, ambas as carteiras (do remetente e do destinatário) precisam ser atualizadas para que elas possam usar a segwit. Além disso, a carteira do remetente precisa saber que a carteira do destinatário é compatível com a segwit.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-828">
<p>A Segregated Witness não será implementada simultaneamente em toda a rede. Em vez disso, a Segregated Witness é implementada como uma atualização compatível com versões anteriores (retrocompatível), onde <em>clientes antigos e clientes novos podem coexistir</em>. Os desenvolvedores de carteira atualizarão os seus aplicativos de carteira de forma independente para adicionar os recursos da segwit. Os pagamentos dos tipos P2WPKH e P2WSH serão usados quando tanto o remetente quanto o destinatário forem compatíveis com a segwit. Os pagamentos tradicionais, dos tipos P2PKH e o P2SH, continuarão a funcionar nas carteiras não atualizadas. Isso nos deixa com dois cenários importantes, que serão abordados na próxima seção:</p>
</div>
<div class="ulist data-line-830">
<ul>
<li class="data-line-830">
<p>Capacidade de uma carteira de remetente incompatível em fazer um pagamento para uma carteira de destinatário compatível com segwit.</p>
</li>
<li class="data-line-832">
<p>Capacidade de uma carteira de remetente compatível em reconhecer e distinguir entre os destinatários que são compatíveis dos que são incompatíveis com segwit, por meio de seus <em>endereços</em>.</p>
</li>
</ul>
</div>
<div class="sect4 data-line-834">
<h5 id="_embutindo_a_segregated_witness_dentro_do_p2sh">Embutindo a Segregated Witness dentro do P2SH</h5>
<div class="paragraph data-line-836">
<p>Vamos supor, por exemplo, que a carteira da Alice não seja atualizada para a segwit, mas a carteira do Bob seja atualizada e consiga lidar com transações da segwit. A Alice e o Bob podem usar transações "antigas" não segwit. Mas o Bob provavelmente gostaria de usar a segwit para reduzir as taxas de transação, aproveitando o desconto que ele teria ao deixar de incluir os dados de testemunha.</p>
</div>
<div class="paragraph data-line-838">
<p>Nesse caso, a carteira do Bob pode construir um endereço P2SH que contém um script segwit dentro dele. A carteira da Alice vê esse endereço como se fosse um endereço P2SH "normal" e consegue fazer pagamentos para ele sem sequer saber que a segwit existe. A carteira do Bob pode então gastar esse pagamento com uma transação de segwit, aproveitando ao máximo as vantagens da segwit e reduzindo as taxas de transação.</p>
</div>
<div class="paragraph data-line-840">
<p>As duas formas de scripts de testemunha, o P2WPKH e o P2WSH, podem ser embutidas em um endereço P2SH. A primeira forma embutida é denominada P2SH(P2WPKH) e a segunda é denominada P2SH(P2WSH).</p>
</div>
</div>
<div class="sect4 data-line-842">
<h5 id="_pay_to_witness_public_key_hash_dentro_de_um_pay_to_script_hash">Pay-to-Witness-Public-Key-Hash dentro de um Pay-to-Script-Hash</h5>
<div class="paragraph data-line-844">
<p>A primeira forma de script de testemunha que examinaremos é a P2SH(P2WPKH). Ela é um programa de testemunha Pay-to-Witness-Public-Key-Hash, embutido em um script Pay-to-Script-Hash, para que possa ser usado por uma carteira que não tenha conhecimento da segwit.</p>
</div>
<div class="paragraph data-line-846">
<p>Bob&#8217;s wallet constructs a P2WPKH witness program with Bob&#8217;s public key. This witness program is then hashed and the resulting hash is encoded as a P2SH script. The P2SH script is converted to a Bitcoin address, one that starts with a "3," as we saw in the <a href="#p2sh">Pay-to-Script-Hash (P2SH)</a> section.</p>
</div>
<div class="paragraph data-line-848">
<p>A carteira do Bob começa com o programa de testemunha P2WPKH que vimos anteriormente:</p>
</div>
<div class="listingblock data-line-851">
<div class="title">Programa de testemunha P2WPKH do Bob</div>
<div class="content">
<pre>0 ab68025513c3dbd2f7b92a94e0581f5d50f654e7</pre>
</div>
</div>
<div class="paragraph data-line-855">
<p>O programa de testemunha P2WPKH consiste na versão da testemunha e no hash de chave pública de 20 bytes do Bob.</p>
</div>
<div class="paragraph data-line-857">
<p>A carteira do Bob então faz o hash do programa de testemunha anterior, primeiro com o SHA256, depois com o RIPEMD160, produzindo outro hash de 20 bytes.</p>
</div>
<div class="paragraph data-line-859">
<p>Vamos usar bx na linha de comando para replicar isso:</p>
</div>
<div class="listingblock data-line-862">
<div class="title">HASH160 do programa de testemunha P2WPKH</div>
<div class="content">
<pre>echo \
'0 [ab68025513c3dbd2f7b92a94e0581f5d50f654e7]'\
 | bx script-encode | bx sha256 | bx ripemd160
3e0547268b3b19288b3adef9719ec8659f4b2b0b</pre>
</div>
</div>
<div class="paragraph data-line-870">
<p>Next, the redeem script hash is converted to a Bitcoin address. Let&#8217;s use bx on the command-line again:</p>
</div>
<div class="listingblock data-line-873">
<div class="title">Endereço P2SH</div>
<div class="content">
<pre>echo \
'3e0547268b3b19288b3adef9719ec8659f4b2b0b' \
| bx address-encode -v 5
37Lx99uaGn5avKBxiW26HjedQE3LrDCZru</pre>
</div>
</div>
<div class="paragraph data-line-880">
<p>Now, Bob can display this address for customers to pay for their coffee. Alice&#8217;s wallet can make a payment to 37Lx99uaGn5avKBxiW26HjedQE3LrDCZru, just as it would to any other Bitcoin address.</p>
</div>
<div class="paragraph data-line-882">
<p>Para pagar para o Bob, a carteira da Alice travaria a saída com um script P2SH:</p>
</div>
<div class="listingblock data-line-883">
<div class="content">
<pre>HASH160 3e0547268b3b19288b3adef9719ec8659f4b2b0b EQUAL</pre>
</div>
</div>
<div class="paragraph data-line-887">
<p>Mesmo que a carteira da Alice não tenha suporte para segwit, o pagamento que ela cria pode ser gasto pelo Bob através de uma transação com segwit.</p>
</div>
</div>
<div class="sect4 data-line-889">
<h5 id="_pay_to_witness_script_hash_dentro_de_um_pay_to_script_hash">Pay-to-Witness-Script-Hash dentro de um Pay-to-Script-Hash</h5>
<div class="paragraph data-line-891">
<p>Da mesma forma, um programa de testemunha P2WSH para um script multiassinatura ou outro script complicado pode ser embutido dentro de um script e endereço P2SH, permitindo que qualquer carteira faça pagamentos que são compatíveis com a segwit.</p>
</div>
<div class="paragraph data-line-893">
<p>Conforme vimos em <a href="#p2wsh">Pay-to-Witness-Script-Hash (P2WSH)</a>, a empresa do Mohammed está usando pagamentos de Segregated Witness com scripts multiassinatura. Para possibilitar que qualquer cliente pague para sua empresa, independente se suas carteiras foram ou não atualizadas para a segwit, a carteira do Mohammed pode embutir o programa de testemunha P2WSH dentro de um script P2SH.</p>
</div>
<div class="paragraph data-line-895">
<p>Primeiro, a carteira do Mohammed faz o hash do script de resgate com o SHA256 (apenas uma vez). Vamos usar bx na linha de comando para fazer isso :</p>
</div>
<div class="listingblock data-line-898">
<div class="title">A carteira do Mohammed cria um programa de testemunha P2WSH</div>
<div class="content">
<pre>echo \
2 \ [04C16B8698A9ABF84250A7C3EA7EEDEF9897D1C8C6ADF47F06CF73370D74DCCA01CDCA79DCC5C395D7EEC6984D83F1F50C900A24DD47F569FD4193AF5DE762C587] \
[04A2192968D8655D6A935BEAF2CA23E3FB87A3495E7AF308EDF08DAC3C1FCBFC2C75B4B0F4D0B1B70CD2423657738C0C2B1D5CE65C97D78D0E34224858008E8B49] \
[047E63248B75DB7379BE9CDA8CE5751D16485F431E46117B9D0C1837C9D5737812F393DA7D4420D7E1A9162F0279CFC10F1E8E8F3020DECDBC3C0DD389D9977965] \
[0421D65CBD7149B255382ED7F78E946580657EE6FDA162A187543A9D85BAAA93A4AB3A8F044DADA618D087227440645ABE8A35DA8C5B73997AD343BE5C2AFD94A5] \
[043752580AFA1ECED3C68D446BCAB69AC0BA7DF50D56231BE0AABF1FDEEC78A6A45E394BA29A1EDF518C022DD618DA774D207D137AAB59E0B000EB7ED238F4D800] \
5 CHECKMULTISIG \
| bx script-encode | bx sha256
9592d601848d04b172905e0ddb0adde59f1590f1e553ffc81ddc4b0ed927dd73</pre>
</div>
</div>
<div class="paragraph data-line-910">
<p>A seguir, o hash do script de resgate é transformado em um programa de testemunha P2WSH:</p>
</div>
<div class="listingblock data-line-912">
<div class="content">
<pre>0 9592d601848d04b172905e0ddb0adde59f1590f1e553ffc81ddc4b0ed927dd73</pre>
</div>
</div>
<div class="paragraph data-line-916">
<p>Em seguida, o próprio programa de testemunha é transformado em hash com o SHA256 e o RIPEMD160, produzindo um novo hash de 20 bytes, como usado no P2SH tradicional. Vamos usar bx na linha de comando para fazer isso:</p>
</div>
<div class="listingblock data-line-919">
<div class="title">O HASH160 do programa de testemunha P2WSH</div>
<div class="content">
<pre> echo \
'0 [9592d601848d04b172905e0ddb0adde59f1590f1e553ffc81ddc4b0ed927dd73]'\
 | bx script-encode | bx sha256 | bx ripemd160
86762607e8fe87c0c37740cddee880988b9455b2</pre>
</div>
</div>
<div class="paragraph data-line-926">
<p>Next, the wallet constructs a P2SH Bitcoin address from this hash. Again, we use bx to calculate on the command-line:</p>
</div>
<div class="listingblock data-line-929">
<div class="title">P2SH Bitcoin address</div>
<div class="content">
<pre>echo \
'86762607e8fe87c0c37740cddee880988b9455b2'\
 | bx address-encode -v 5
3Dwz1MXhM6EfFoJChHCxh1jWHb8GQqRenG</pre>
</div>
</div>
<div class="paragraph data-line-936">
<p>Agora, os clientes do Mohammed podem fazer pagamentos neste endereço, sem precisarem ter suporte à segwit. Para enviar um pagamento a Mohammed, uma carteira travaria a saída com o seguinte script P2SH:</p>
</div>
<div class="listingblock data-line-939">
<div class="title">Script P2SH usado para travar os pagamentos para a multiassinatura do Mohammed</div>
<div class="content">
<pre>HASH160 86762607e8fe87c0c37740cddee880988b9455b2 EQUAL</pre>
</div>
</div>
<div class="paragraph data-line-943">
<p>A empresa do Mohammed pode então construir transações com segwit para gastar esses pagamentos, aproveitando os recursos da segwit, incluindo taxas de transação mais baixas.</p>
</div>
</div>
<div class="sect4 data-line-945">
<h5 id="_endereços_de_segregated_witness">Endereços de Segregated Witness</h5>
<div class="paragraph data-line-947">
<p>Mesmo após a ativação da segwit, levará algum tempo até que a maioria das carteiras seja atualizada. Inicialmente, a segwit será embutida no P2SH, conforme vimos na seção anterior, para facilitar a compatibilidade entre as carteiras com suporte e as carteiras sem suporte à segwit.</p>
</div>
<div class="paragraph data-line-949">
<p>No entanto, assim que as carteiras suportarem amplamente a segwit, fará sentido codificar os scripts de testemunha diretamente em um formato de endereço nativo projetado para a segwit, em vez de embuti-los no P2SH.</p>
</div>
<div class="paragraph data-line-951">
<p>O formato de endereço segwit nativo é definido na BIP-173:</p>
</div>
<div class="dlist data-line-953">
<dl>
<dt class="hdlist1"><a href="https://github.com/bitcoin/bips/blob/master/bip-0173.mediawiki" data-href="https://github.com/bitcoin/bips/blob/master/bip-0173.mediawiki">BIP-173</a></dt>
<dd>
<p>Formato de endereço Base32 para saídas de testemunha v0-16 nativas</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-955">
<p>BIP-173 only encodes witness (P2WPKH and P2WSH) scripts. It is not compatible with non-segwit P2PKH or P2SH scripts. BIP-173 is a checksummed Base32 encoding, as compared to the Base58 encoding of a "traditional" Bitcoin address. BIP-173 addresses are also called <em>bech32</em> addresses, pronounced "beh-ch thirty two", alluding to the use of a "BCH" error detection algorithm and 32-character encoding set.</p>
</div>
<div class="paragraph data-line-957">
<p>Os endereços da BIP-173 usam um conjunto de 32 caracteres alfanuméricos apenas em letras minúsculas, cuidadosamente selecionados para reduzir erros de leitura e de digitação. Por escolher um conjunto de caracteres apenas em letras minúsculas, o bech32 é mais fácil de ser lido e soletrado, além de ser 45% mais eficiente de ser codificado em códigos QR.</p>
</div>
<div class="paragraph data-line-959">
<p>O algoritmo de detecção de erros BCH é uma grande melhoria em relação ao algoritmo de soma de verificação anterior (do Base58Check), permitindo não só a detecção, mas também a <em>correção</em> de erros. Ao detectar um erro, as interfaces de entrada de endereço (como campos de texto em formulários) podem detectar e destacar qual caractere provavelmente foi digitado incorretamente.</p>
</div>
<div class="paragraph data-line-961">
<p>A partir da especificação da BIP-173, aqui estão alguns exemplos de endereços bech32:</p>
</div>
<div class="dlist data-line-963">
<dl>
<dt class="hdlist1">Endereço P2WPKH da Mainnet</dt>
<dd>
<p>bc1qw508d6qejxtdg4y5r3zarvary0c5xw7kv8f3t4</p>
</dd>
<dt class="hdlist1">Endereço P2WPKH da Testnet</dt>
<dd>
<p>tb1qw508d6qejxtdg4y5r3zarvary0c5xw7kxpjzsx</p>
</dd>
<dt class="hdlist1">Endereço P2WSH da Mainnet</dt>
<dd>
<p>bc1qrp33g0q5c5txsp9arysrx4k6zdkfs4nce4xj0gdcccefvpysxf3qccfmv3</p>
</dd>
<dt class="hdlist1">Endereço P2WSH da Testnet</dt>
<dd>
<p>tb1qrp33g0q5c5txsp9arysrx4k6zdkfs4nce4xj0gdcccefvpysxf3q0sl5k7</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-968">
<p>Como você pode ver nesses exemplos, uma <em>string</em> de um endereço bech32 da segwit tem até 90 caracteres e consiste em três partes:</p>
</div>
<div class="dlist data-line-970">
<dl>
<dt class="hdlist1">A parte legível por humanos</dt>
<dd>
<p>O prefixo "bc" ou "tb", que identifica a mainnet ou a testnet</p>
</dd>
<dt class="hdlist1">O separador</dt>
<dd>
<p>O dígito "1", que não faz parte do conjunto de codificação de 32 caracteres e só pode aparecer nesta posição como um separador</p>
</dd>
<dt class="hdlist1">A parte de dados</dt>
<dd>
<p>Um mínimo de 6 caracteres alfanuméricos, que correspondem ao script de testemunha codificado e com soma de verificação (<em>checksum</em>)</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-976">
<p>Atualmente, apenas algumas carteiras aceitam ou produzem endereços segwit bech32 nativos, mas à medida que a adoção da segwit aumenta, você os verá cada vez mais.</p>
</div>
<div class="paragraph data-line-978">
<p>A <a href="#segwit_addresses">Endereços de bitcoin não segwit (legado) e endereços segwit</a> mostra os endereços de bitcoin não segwit (legado ou <em>legacy</em>) e segwit.</p>
</div>
<table id="segwit_addresses" class="tableblock frame-all grid-all stretch data-line-982">
<caption class="title">Table 3. Endereços de bitcoin não segwit (legado) e endereços segwit</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tipo</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Codificação</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Prefixo</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Endereço Legado P2PKH</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base58</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Endereço Legado P2PKH Testnet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base58</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">m ou n</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Endereço Legado P2SH</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base58</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Endereço Legado P2SH Testnet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base58</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Endereço Segwit Aninhado/Embutido P2SH(P2WPKH)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base58</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Endereço Segwit Aninhado/Embutido P2SH(P2WSH)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base58</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Endereço Segwit Nativo P2WPKH</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bech32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bc1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Endereço Segwit Nativo P2WPKH Testnet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bech32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">tb1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Endereço Segwit Nativo P2WSH</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bech32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bc1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Endereço Segwit Nativo P2WSH Testnet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bech32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">tb1</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4 data-line-997">
<h5 id="segwit_txid">Identificadores de transação</h5>
<div class="paragraph data-line-999">
<p>Um dos maiores benefícios da Segregated Witness é que ela elimina a maleabilidade de transação por terceiros.</p>
</div>
<div class="paragraph data-line-1001">
<p>Antes da segwit, as transações podiam ter suas assinaturas sutilmente modificadas por terceiros, alterando seu ID (hash) de transação sem alterar nenhuma das propriedades fundamentais (entradas, saídas, quantias). Isso criou oportunidades para ataques de negação de serviço, bem como ataques contra softwares de carteira mal escritos que presumiam que os hashes de transações não confirmadas eram imutáveis.</p>
</div>
<div class="paragraph data-line-1003">
<p>Com a introdução da Segregated Witness, as transações agora têm dois identificadores, txid e wtxid. O ID de transação tradicional txid é o hash SHA256 duplo da transação serializada, sem os dados de testemunha. Um wtxid de transação é o hash SHA256 duplo do novo formato de serialização da transação com dados de testemunha.</p>
</div>
<div class="paragraph data-line-1005">
<p>O txid tradicional é calculado exatamente da mesma maneira que uma transação sem segwit. No entanto, como uma transação segwit pura (uma transação contendo apenas entradas com segwit) tem scriptSigs vazios em todas as entradas, nenhuma parte da transação pode ser modificada por terceiros. Portanto, em uma transação segwit pura, o txid é imutável por um terceiro, mesmo quando a transação ainda não foi confirmada.</p>
</div>
<div class="paragraph data-line-1007">
<p>O wtxid é como um ID "estendido", pois o hash também incorpora os dados de testemunha. Se uma transação for transmitida sem dados de testemunha, o wtxid e o txid serão idênticos. Observe que, uma vez que o wtxid inclui os dados de testemunha (as assinaturas) e como os dados de testemunha podem ser maleáveis, o wtxid deve ser considerado maleável até que a transação seja confirmada. Apenas o txid de uma transação segwit pura pode ser considerado imutável por terceiros.</p>
</div>
<div class="admonitionblock tip data-line-1010">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-1011">
<p>As transações com Segregated Witness têm dois IDs: o txid e o wtxid. O txid é o hash da transação sem os dados de testemunha e o wtxid é o hash que inclui os dados de testemunha. Somente as transações segwit puras (transações que contêm apenas entradas segwit) possuem um txid que não é suscetível à maleabilidade de transação por terceiros.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3 data-line-1014">
<h4 id="_novo_algoritmo_de_assinatura_da_segregated_witness">Novo Algoritmo de Assinatura da Segregated Witness</h4>
<div class="paragraph data-line-1016">
<p>A Segregated Witness modifica a semântica das quatro funções de verificação de assinatura (CHECKSIG, CHECKSIGVERIFY, CHECKMULTISIG e CHECKMULTISIGVERIFY), mudando a maneira como um hash de compromisso de transação é calculado.</p>
</div>
<div class="paragraph data-line-1018">
<p>As assinaturas nas transações de bitcoin são aplicadas em um <em>hash de compromisso</em>, que é calculado a partir dos dados da transação, travando partes específicas dos dados que indicam o compromisso do signatário com esses valores. Por exemplo, em uma assinatura simples do tipo SIGHASH_ALL, o hash de compromisso inclui todas as entradas e saídas.</p>
</div>
<div class="paragraph data-line-1020">
<p>Unfortunately, the way the commitment hash was calculated introduced the possibility that a node verifying the signature can be forced to perform a significant number of hash computations. Specifically, the hash operations increase in O(n<sup>2</sup>) with respect to the number of signature operations in the transaction. An attacker could therefore create a transaction with a very large number of signature operations, causing the entire Bitcoin network to have to perform hundreds or thousands of hash operations to verify the transaction.</p>
</div>
<div class="paragraph data-line-1022">
<p>A segwit representou uma oportunidade de resolver esse problema ao alterar a maneira como o hash de compromisso é calculado. Para programas de testemunha da versão 0 da segwit, a verificação de assinatura ocorre usando um algoritmo de hash de compromisso aprimorado, conforme especificado na BIP-143.</p>
</div>
<div class="paragraph data-line-1024">
<p>O novo algoritmo atinge dois objetivos importantes. Em primeiro lugar, o número de operações de hash aumenta em uma proporção muito mais gradual (O(n)) em relação ao número de operações de assinatura, reduzindo a oportunidade de serem criados ataques de negação de serviço com transações excessivamente complexas. Em segundo lugar, o hash de compromisso agora também inclui os valores (as quantias) de cada entrada como parte do compromisso. Isso significa que um signatário pode se comprometer com um valor de entrada específico sem precisar "buscar" e verificar a transação anterior referenciada pela entrada. No caso de dispositivos off-line, como carteiras de hardware, isso simplifica muito a comunicação entre o host (o computador/celular/tablet) e a carteira de hardware, eliminando a necessidade de se transmitir transações anteriores para validação. Uma carteira de hardware pode aceitar o valor da entrada "conforme declarado" por um host que não seja de confiança. Como a assinatura é inválida se o valor da entrada não estiver correto, a carteira de hardware não precisa validar o valor antes de assinar a entrada.</p>
</div>
</div>
<div class="sect3 data-line-1026">
<h4 id="_incentivos_econômicos_para_a_segregated_witness">Incentivos Econômicos para a Segregated Witness</h4>
<div class="paragraph data-line-1028">
<p>Bitcoin mining nodes and full nodes incur costs for the resources used to support the Bitcoin network and the blockchain. As the volume of bitcoin transactions increases, so does the cost of resources (CPU, network bandwidth, disk space, memory). Miners are compensated for these costs through fees that are proportional to the size (in bytes) of each transaction. Nonmining full nodes are not compensated, so they incur these costs because they have a need to run an authoritative fully validating full-index node, perhaps because they use the node to operate a bitcoin business.</p>
</div>
<div class="paragraph data-line-1030">
<p>Sem as taxas de transação, o crescimento dos dados do bitcoin aumentaria dramaticamente. As taxas destinam-se a alinhar as necessidades dos usuários do bitcoin com a carga que suas transações impõem à rede, por meio de um mecanismo de descoberta de preço baseado no mercado.</p>
</div>
<div class="paragraph data-line-1032">
<p>The calculation of fees based on transaction size treats all the data in the transaction as equal in cost. But from the perspective of full nodes and miners, some parts of a transaction carry much higher costs. Every transaction added to the Bitcoin network affects the consumption of four resources on nodes:</p>
</div>
<div class="dlist data-line-1034">
<dl>
<dt class="hdlist1">Espaço em disco </dt>
<dd>
<p>Todas as transações são armazenadas na blockchain, o que acaba contribuindo para um aumento no tamanho total da blockchain. A blockchain é armazenada em disco, mas o armazenamento pode ser otimizado através da exclusão de transações mais antigas, também conhecida pelo termo “podagem” (em inglês, <em>pruning</em>).</p>
</dd>
<dt class="hdlist1">CPU</dt>
<dd>
<p>Cada transação deve ser validada, o que requer tempo de CPU.</p>
</dd>
<dt class="hdlist1">Largura de banda </dt>
<dd>
<p>Cada transação é transmitida (através da propagação de inundação) pela rede pelo menos uma vez. Sem qualquer otimização no protocolo de propagação dos blocos, as transações são transmitidas novamente como parte de um bloco, dobrando o impacto na capacidade da rede.</p>
</dd>
<dt class="hdlist1">Memória </dt>
<dd>
<p>Os nós que validam transações mantêm o índice UTXO ou todo o conjunto UTXO na memória para acelerar a validação. Como o armazenamento em memória é pelo menos uma ordem de magnitude mais caro do que o armazenamento em disco, o crescimento do conjunto UTXO contribui desproporcionalmente para o custo de execução de um nó.</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-1042">
<p>Como você pode ver na lista, nem todas as partes de uma transação têm um impacto igual no custo de execução de um nó ou na capacidade do bitcoin de escalar para suportar mais transações. A parte mais cara de uma transação são as saídas recém-criadas, pois elas são adicionadas ao conjunto UTXO na memória. Em comparação, as assinaturas (também conhecidas como dados de testemunha) adicionam uma menor carga à rede e ao custo de execução de um nó, pois os dados de testemunha são validados apenas uma vez e depois nunca mais são usados. Além disso, imediatamente após receber uma nova transação e validar os dados de testemunha, os nós podem descartar esses dados de testemunha. Se as taxas forem calculadas com base no tamanho da transação, sem discriminar entre esses dois tipos de dados, os incentivos de mercado das taxas não estarão alinhados com os custos reais impostos por uma transação. Na verdade, a estrutura de taxas atual incentiva o comportamento oposto, pois os dados de testemunha constituem a maior parte de uma transação.</p>
</div>
<div class="paragraph data-line-1044">
<p>Os incentivos criados pelas taxas são importantes, pois eles afetam o comportamento das carteiras. Todas as carteiras devem implementar alguma estratégia para montar transações que leve em consideração uma série de fatores, como privacidade (reduzindo a reutilização de endereços), fragmentação (fazendo muitos trocos) e taxas. Se as taxas estão servindo como um forte incentivo para as carteiras usarem o mínimo de entradas possível nas transações, isso pode levar a estratégias de seleção de UTXO e de endereço de troco que inadvertidamente incham o conjunto UTXO.</p>
</div>
<div class="paragraph data-line-1046">
<p>As transações consomem UTXOs em suas entradas e criam novas UTXOs com suas saídas. Portanto, uma transação que tem mais entradas do que saídas resultará em uma diminuição no conjunto UTXO, enquanto uma transação que possui mais saídas do que entradas resultará em um aumento no conjunto UTXO. Vamos considerar a <em>diferença</em> entre as entradas e as saídas e chamá-la de “Nova-UTXO-líquida” (em inglês, <em>Net-new-UTXO</em>). Essa é uma métrica importante, pois nos diz qual impacto uma transação terá no recurso mais caro de toda a rede, o conjunto UTXO em memória. Uma transação com uma Nova-UTXO-líquida positiva aumenta esse fardo. Uma transação com uma Nova-UTXO-líquida negativa reduz o fardo. Portanto, o que queremos é encorajar as transações que tenham uma Nova-UTXO-líquida negativa ou as que sejam neutras e tenham uma Nova-UTXO-líquida zero.</p>
</div>
<div class="paragraph data-line-1048">
<p>Let’s look at an example of what incentives are created by the transaction fee calculation, with and without Segregated Witness. We will look at two different transactions. Transaction A is a 3-input, 2-output transaction, which has a Net-new-UTXO metric of &#x2013;1, meaning it consumes one more UTXO than it creates, reducing the UTXO set by one. Transaction B is a 2-input, 3-output transaction, which has a Net-new-UTXO metric of 1, meaning it adds one UTXO to the UTXO set, imposing additional cost on the entire Bitcoin network. Both transactions use multisignature (2-of-3) scripts to demonstrate how complex scripts increase the impact of segregated witness on fees. Let’s assume a transaction feerate of 30 satoshi per byte and a 75% fee discount on witness data:</p>
</div>
<dl>
<dt>Sem Segregated Witness</dt>
<dd>
<p>Taxa da Transação A: 28.590 satoshis</p>
<p>Taxa da Transação B: 20.760 satoshis</p>
</dd>

<dt>Com Segregated Witness</dt>
<dd>
<p>Taxa da Transação A: 12.255 satoshis</p>
<p>Taxa da Transação B: 10.425 satoshis</p>
</dd>
</dl>
<div class="paragraph data-line-1067">
<p>Ambas as transações são menos caras quando a Segregated Witness é implementada. Comparando os custos entre as duas transações, vemos que antes da Segregated Witness, a transação com a Nova-UTXO-líquida positiva tem economias de custo significativas. Com a Segregated Witness, a diferença de custo diminui significativamente em termos absolutos e relativos. Embora seria necessário que as entradas se tornassem mais baratas do que as saídaspara que a consolidação do conjunto UTXO fosse incentivada, esse desconto reduz o incentivo para se criar novas UTXOs com o intuito de se evitar o uso de mais entradas.</p>
</div>
<div class="paragraph data-line-1069">
<p>Segregated Witness therefore has two main effects on the fees paid by bitcoin users. Firstly, segwit reduces the overall cost of transactions by discounting witness data and increasing the capacity of the Bitcoin blockchain. Secondly, segwit’s discount on witness data partially mitigates a misalignment of incentives that may have inadvertently created more bloat in the UTXO set.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-07-10 05:52:41 -0400
</div>
</div>
</body>
</html>